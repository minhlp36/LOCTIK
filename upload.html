<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ÄÄƒng bÃ i - LokTik</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen pb-24">

  <div class="max-w-md mx-auto mt-6 p-4 bg-white rounded shadow">
    <h1 class="text-2xl font-bold text-center mb-4">ÄÄƒng bÃ i má»›i</h1>
    <form id="uploadForm" class="space-y-4">
      <input type="file" id="imageInput" accept="image/*" multiple class="w-full border p-2 rounded" />
      <textarea id="captionInput" rows="3" placeholder="Viáº¿t chÃº thÃ­ch..." class="w-full border p-2 rounded"></textarea>
      <div id="progressContainer" class="text-sm text-blue-600"></div>
      <button type="submit" class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600">ÄÄƒng bÃ i</button>
      <p id="message" class="text-sm text-center mt-2 text-gray-700"></p>
    </form>
  </div>

  <!-- Thanh Ä‘iá»u hÆ°á»›ng -->
  <div class="fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around py-2">
    <a href="feed.html" class="flex flex-col items-center text-gray-600 hover:text-blue-600">
      <span class="text-xl">ğŸ </span><span class="text-sm">Trang chá»§</span>
    </a>
    <a href="upload.html" class="flex flex-col items-center text-blue-600">
      <span class="text-xl">â•</span><span class="text-sm">ÄÄƒng</span>
    </a>
    <a href="chat.html" class="flex flex-col items-center text-gray-600 hover:text-blue-600">
      <span class="text-xl">ğŸ’¬</span><span class="text-sm">Tin nháº¯n</span>
    </a>
    <a href="account.html" class="flex flex-col items-center text-gray-600 hover:text-blue-600">
      <span class="text-xl">ğŸ‘¤</span><span class="text-sm">TÃ i khoáº£n</span>
    </a>
  </div>

  <!-- Firebase v10 + Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getStorage, ref as storageRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import imageCompression from "https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.esm.js";

    // Cáº¥u hÃ¬nh Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAJxH_3ZkN7wQnXVelRzm0mezBCBcxKoJM",
      authDomain: "loktik-1d9af.firebaseapp.com",
      projectId: "loktik-1d9af",
      storageBucket: "loktik-1d9af.appspot.com",
      messagingSenderId: "801363229819",
      appId: "1:801363229819:web:49f086bc180d9ed9c0b6de"
    };

    // Khá»Ÿi táº¡o Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const storage = getStorage(app);
    const db = getFirestore(app);

    const uploadForm = document.getElementById("uploadForm");
    const imageInput = document.getElementById("imageInput");
    const captionInput = document.getElementById("captionInput");
    const message = document.getElementById("message");
    const progressContainer = document.getElementById("progressContainer");

    let currentUser = null;

    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.href = "login.html";
      } else {
        currentUser = user;
      }
    });

    uploadForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const caption = captionInput.value.trim();
      const files = Array.from(imageInput.files).slice(0, 5); // Tá»‘i Ä‘a 5 áº£nh

      if (files.length === 0 && !caption) {
        message.className = "text-sm text-red-500 mt-2";
        message.textContent = "âŒ HÃ£y nháº­p chÃº thÃ­ch hoáº·c chá»n áº£nh.";
        return;
      }

      const submitBtn = uploadForm.querySelector("button[type='submit']");
      submitBtn.disabled = true;
      submitBtn.textContent = "â³ Äang Ä‘Äƒng...";

      try {
        let imageUrls = [];

        for (let i = 0; i < files.length; i++) {
          const file = files[i];

          if (file.size > 5 * 1024 * 1024) {
            throw new Error("áº¢nh quÃ¡ lá»›n. Giá»›i háº¡n má»—i áº£nh lÃ  5MB.");
          }

          const compressed = await imageCompression(file, {
            maxSizeMB: 1,
            maxWidthOrHeight: 1024,
            useWebWorker: true
          });

          const filename = `posts/${Date.now()}_${compressed.name}`;
          const imgRef = storageRef(storage, filename);
          const uploadTask = uploadBytesResumable(imgRef, compressed);

          await new Promise((resolve, reject) => {
            uploadTask.on(
              "state_changed",
              (snapshot) => {
                const percent = Math.floor((snapshot.bytesTransferred / snapshot.totalBytes) * 100);
                progressContainer.innerHTML = `ğŸ“¤ Äang táº£i áº£nh ${i + 1}/${files.length}: ${percent}%`;
              },
              reject,
              async () => {
                const url = await getDownloadURL(uploadTask.snapshot.ref);
                imageUrls.push(url);
                resolve();
              }
            );
          });
        }

        // LÆ°u bÃ i Ä‘Äƒng
        await addDoc(collection(db, "posts"), {
          caption,
          imageUrls,
          uid: currentUser.uid,
          email: currentUser.email,
          displayName: currentUser.displayName || currentUser.email || "áº¨n danh",
          avatarUrl: currentUser.photoURL || "https://www.gravatar.com/avatar?d=mp",
          createdAt: serverTimestamp()
        });

        message.className = "text-sm text-green-500 mt-2";
        message.textContent = "âœ… ÄÄƒng bÃ i thÃ nh cÃ´ng!";
        progressContainer.innerHTML = "";
        uploadForm.reset();
        submitBtn.disabled = false;
        submitBtn.textContent = "ÄÄƒng bÃ i";

        setTimeout(() => window.location.href = "feed.html", 1000);

      } catch (err) {
        message.className = "text-sm text-red-500 mt-2";
        message.textContent = "âŒ Lá»—i: " + err.message;
        submitBtn.disabled = false;
        submitBtn.textContent = "ÄÄƒng bÃ i";
      }
    });
  </script>
</body>
</html>
