<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>T·∫°o b√†i vi·∫øt - LokTik</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    /* ·∫®n thanh cu·ªôn nh∆∞ng v·∫´n cu·ªôn ƒë∆∞·ª£c */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    /* T√πy ch·ªânh select box */
    .custom-select {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
    }
  </style>
</head>
<body class="bg-white text-slate-900 pb-24">

  <header class="sticky top-0 bg-white z-30 border-b border-gray-50 px-4 py-3 flex justify-between items-center shadow-sm">
    <a href="feed.html" class="p-2 -ml-2 text-gray-600 hover:bg-gray-100 rounded-full transition">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
    </a>
    <h1 class="font-bold text-lg">T·∫°o b√†i vi·∫øt</h1>
    <button id="uploadBtn" class="bg-blue-600 text-white px-5 py-1.5 rounded-full text-sm font-semibold opacity-50 disabled:cursor-not-allowed transition-all duration-200 hover:bg-blue-700 shadow-md shadow-blue-200" disabled>
      ƒêƒÉng
    </button>
  </header>

  <main class="max-w-md mx-auto mt-2">
    <div class="px-4 py-3 flex items-center gap-3">
        <img id="userAvatar" src="https://via.placeholder.com/48" class="w-12 h-12 rounded-full bg-gray-100 border border-gray-100 object-cover">
        <div>
            <h3 id="userName" class="font-bold text-base leading-tight">Ng∆∞·ªùi d√πng</h3>
            
            <div class="relative mt-1 inline-block">
                <select id="privacySelect" class="custom-select bg-gray-100 text-gray-600 text-xs font-medium py-1 pl-2 pr-6 rounded-md cursor-pointer focus:ring-2 focus:ring-blue-500 focus:outline-none border border-transparent hover:bg-gray-200 transition">
                    <option value="public">üåç C√¥ng khai</option>
                    <option value="friends">üë• B·∫°n b√®</option>
                    <option value="private">üîí Ch·ªâ m√¨nh t√¥i</option>
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-1.5 text-gray-500">
                    <svg class="h-3 w-3 fill-current" viewBox="0 0 20 20">
                        <path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" />
                    </svg>
                </div>
            </div>
        </div>
    </div>

    <div class="px-4 pt-1 pb-4">
        <textarea id="postContent" rows="3" class="w-full mt-2 outline-none text-lg placeholder-gray-400 resize-none bg-transparent leading-relaxed" placeholder="B·∫°n ƒëang nghƒ© g√¨ th·∫ø?"></textarea>
    </div>

    <div id="previewContainer" class="flex gap-3 overflow-x-auto px-4 pb-4 no-scrollbar">
        <label for="fileInput" class="flex-shrink-0 w-28 h-36 bg-gray-50 border-2 border-dashed border-blue-200 rounded-xl flex flex-col items-center justify-center cursor-pointer hover:bg-blue-50 transition group">
            <div class="p-2 bg-white rounded-full shadow-sm mb-2 group-hover:scale-110 transition">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 text-blue-500">
                    <path fill-rule="evenodd" d="M1.5 6a2.25 2.25 0 012.25-2.25h16.5A2.25 2.25 0 0122.5 6v12.75a2.25 2.25 0 01-2.25 2.25H3.75A2.25 2.25 0 011.5 18.75V6zM3 16.06V18c0 .414.336.75.75.75h16.5A.75.75 0 0021 18v-1.94l-2.69-2.689a1.5 1.5 0 00-2.12 0l-.88.879.97.97a.75.75 0 11-1.06 1.06l-5.16-5.159a1.5 1.5 0 00-2.12 0L3 16.061zm10.125-7.81a1.125 1.125 0 112.25 0 1.125 1.125 0 01-2.25 0z" clip-rule="evenodd" />
                </svg>
            </div>
            <span class="text-xs text-gray-500 font-medium group-hover:text-blue-600">Th√™m ·∫£nh</span>
        </label>
        
        </div>

    <input type="file" id="fileInput" accept="image/*" multiple class="hidden" />

    <div id="progressContainer" class="hidden px-4 mt-4 mb-6">
        <div class="flex justify-between text-xs font-medium text-gray-500 mb-1.5">
            <span id="progressText">ƒêang t·∫£i l√™n...</span>
            <span id="uploadPercent">0%</span>
        </div>
        <div class="w-full bg-gray-100 rounded-full h-1.5 overflow-hidden">
            <div id="progressBar" class="bg-gradient-to-r from-blue-500 to-cyan-400 h-1.5 rounded-full transition-all duration-300 shadow-[0_0_10px_rgba(59,130,246,0.5)]" style="width: 0%"></div>
        </div>
    </div>
  </main>

  <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 flex justify-around items-center py-3 pb-5 z-50 safe-area-pb shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.02)]">
    <a href="feed.html" class="flex flex-col items-center text-gray-400 hover:text-black transition group">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-7 h-7">
          <path d="M11.47 3.84a.75.75 0 011.06 0l8.69 8.69a.75.75 0 101.06-1.06l-8.689-8.69a2.25 2.25 0 00-3.182 0l-8.69 8.69a.75.75 0 001.061 1.06l8.69-8.69z" />
          <path d="M12 5.432l8.159 8.159c.03.03.06.058.091.086v6.198c0 1.035-.84 1.875-1.875 1.875H15a.75.75 0 01-.75-.75v-4.5a.75.75 0 00-.75-.75h-3a.75.75 0 00-.75.75V21a.75.75 0 01-.75.75H5.625a1.875 1.875 0 01-1.875-1.875v-6.198a2.29 2.29 0 00.091-.086L12 5.43z" />
        </svg>
        <span class="text-[10px] font-medium mt-1">Trang ch·ªß</span>
      </a>
  
      <a href="friends.html" class="flex flex-col items-center text-gray-400 hover:text-black transition group">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-7 h-7">
              <path fill-rule="evenodd" d="M8.25 6.75a3.75 3.75 0 117.5 0 3.75 3.75 0 01-7.5 0zM15.75 9.75a3 3 0 116 0 3 3 0 01-6 0zM2.25 9.75a3 3 0 116 0 3 3 0 01-6 0zM6.31 15.117A6.745 6.745 0 0112 12a6.745 6.745 0 016.709 7.498.75.75 0 01-.372.568A12.696 12.696 0 0112 21.75c-2.305 0-4.47-.612-6.337-1.684a.75.75 0 01-.372-.568 6.787 6.787 0 011.019-4.38z" clip-rule="evenodd" />
              <path d="M5.082 14.254a8.287 8.287 0 00-1.308 5.135 9.687 9.687 0 01-1.764-.44l-.115-.04a.563.563 0 01-.373-.487l-.01-.121a3.75 3.75 0 013.57-4.047zM20.226 19.389a8.287 8.287 0 00-1.308-5.135 3.75 3.75 0 013.57 4.047l-.01.121a.563.563 0 01-.373.486l-.115.04c-.567.2-1.156.349-1.764.441z" />
          </svg>
          <span class="text-[10px] font-medium mt-1">B·∫°n b√®</span>
      </a>
      
      <a href="upload.html" class="flex flex-col items-center group">
        <div class="relative w-12 h-8 scale-110">
          <div class="absolute left-0 top-0 bottom-0 w-8 bg-cyan-400 rounded-lg transform -translate-x-1 shadow-sm"></div>
          <div class="absolute right-0 top-0 bottom-0 w-8 bg-red-500 rounded-lg transform translate-x-1 shadow-sm"></div>
          <div class="absolute left-0 right-0 top-0 bottom-0 bg-white rounded-lg flex items-center justify-center border-x-2 border-black z-10">
              <span class="text-black font-bold text-xl leading-none mb-0.5">+</span>
          </div>
        </div>
      </a>
  
      <a href="chat.html" class="flex flex-col items-center text-gray-400 hover:text-black transition group">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-7 h-7">
              <path fill-rule="evenodd" d="M4.804 21.644A6.707 6.707 0 006 21.75a6.721 6.721 0 003.583-1.029c.774.182 1.584.279 2.417.279 5.322 0 9.75-3.97 9.75-9 0-5.03-4.428-9-9.75-9s-9.75 3.97-9.75 9c0 2.409 1.025 4.587 2.674 6.192.232.226.277.428.254.543a3.73 3.73 0 01-.814 1.686.75.75 0 00.44 1.223zM8.25 10.875a1.125 1.125 0 100 2.25 1.125 1.125 0 000-2.25zM10.875 12a1.125 1.125 0 112.25 0 1.125 1.125 0 01-2.25 0zm4.875-1.125a1.125 1.125 0 100 2.25 1.125 1.125 0 000-2.25z" clip-rule="evenodd" />
            </svg>
        <span class="text-[10px] font-medium mt-1">H·ªôp th∆∞</span>
      </a>
  
      <a href="account.html" class="flex flex-col items-center text-gray-400 hover:text-black transition">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-7 h-7">
          <path fill-rule="evenodd" d="M7.5 6a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM3.751 20.105a8.25 8.25 0 0116.498 0 .75.75 0 01-.437.695A18.683 18.683 0 0112 22.5c-2.786 0-5.433-.608-7.812-1.7a.75.75 0 01-.437-.695z" clip-rule="evenodd" />
        </svg>
        <span class="text-[10px] font-medium mt-1">H·ªì s∆°</span>
      </a>
  </nav>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAJxH_3ZkN7wQnXVelRzm0mezBCBcxKoJM",
      authDomain: "loktik-1d9af.firebaseapp.com",
      projectId: "loktik-1d9af",
      storageBucket: "loktik-1d9af.appspot.com",
      messagingSenderId: "801363229819",
      appId: "1:801363229819:web:49f086bc180d9ed9c0b6de"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const fileInput = document.getElementById("fileInput");
    const uploadBtn = document.getElementById("uploadBtn");
    const postContent = document.getElementById("postContent");
    const previewContainer = document.getElementById("previewContainer");
    const progressContainer = document.getElementById("progressContainer");
    const progressBar = document.getElementById("progressBar");
    const uploadPercent = document.getElementById("uploadPercent");
    const userAvatar = document.getElementById("userAvatar");
    const userName = document.getElementById("userName");
    const privacySelect = document.getElementById("privacySelect");
    const progressText = document.getElementById("progressText");

    let currentUser = null;

    // Load User info
    onAuthStateChanged(auth, user => {
        if (!user) return window.location.href = "login.html";
        currentUser = user;
        if(user.photoURL) userAvatar.src = user.photoURL;
        userName.textContent = user.displayName || user.email.split('@')[0]; // Hi·ªÉn th·ªã t√™n ho·∫∑c email
    });

    // Auto Resize Textarea
    postContent.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
        checkUploadCondition();
    });

    // Handle Input change (Preview Images)
    fileInput.addEventListener('change', () => {
        const files = Array.from(fileInput.files);
        
        // X√≥a ·∫£nh c≈© nh∆∞ng gi·ªØ l·∫°i n√∫t Th√™m ·∫£nh (firstElementChild)
        const addBtn = previewContainer.firstElementChild;
        previewContainer.innerHTML = '';
        previewContainer.appendChild(addBtn);

        files.slice(0, 10).forEach(file => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const imgDiv = document.createElement("div");
                imgDiv.className = "flex-shrink-0 w-28 h-36 rounded-xl bg-gray-100 overflow-hidden relative border border-gray-200 shadow-sm";
                imgDiv.innerHTML = `
                    <img src="${e.target.result}" class="w-full h-full object-cover">
                `;
                previewContainer.appendChild(imgDiv);
            };
            reader.readAsDataURL(file);
        });
        checkUploadCondition();
    });

    function checkUploadCondition() {
        if(postContent.value.trim() !== "" || fileInput.files.length > 0) {
            uploadBtn.disabled = false;
            uploadBtn.style.opacity = "1";
            uploadBtn.classList.remove("shadow-none");
            uploadBtn.classList.add("shadow-blue-200");
        } else {
            uploadBtn.disabled = true;
            uploadBtn.style.opacity = "0.5";
            uploadBtn.classList.add("shadow-none");
        }
    }

    async function compressImage(file) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
          const img = new Image();
          img.src = event.target.result;
          img.onload = () => {
            const canvas = document.createElement("canvas");
            const maxSize = 1080; // TƒÉng ch·∫•t l∆∞·ª£ng ·∫£nh l√™n m·ªôt ch√∫t cho ƒë·∫πp
            let width = img.width;
            let height = img.height;
            if (width > height) {
              if (width > maxSize) { height *= maxSize / width; width = maxSize; }
            } else {
              if (height > maxSize) { width *= maxSize / height; height = maxSize; }
            }
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, width, height);
            canvas.toBlob((blob) => resolve(blob), "image/jpeg", 0.8);
          };
        };
      });
    }

    uploadBtn.addEventListener("click", async () => {
     const content = postContent.value.trim();
     const privacy = privacySelect.value; // L·∫•y gi√° tr·ªã quy·ªÅn ri√™ng t∆∞
     const files = Array.from(fileInput.files);

     if (!content && files.length === 0) return;

      uploadBtn.disabled = true;
      uploadBtn.innerHTML = '<span class="animate-pulse">ƒêang x·ª≠ l√Ω...</span>';
      progressContainer.classList.remove("hidden");

      try {
          const uploadedImageUrls = [];
          if (files.length > 0) {
            const limitedFiles = files.slice(0, 10);
            progressText.textContent = `ƒêang t·∫£i l√™n 1/${limitedFiles.length} ·∫£nh...`;
            
            for (let i = 0; i < limitedFiles.length; i++) {
              const file = limitedFiles[i];
              const compressedFile = await compressImage(file);

              const storageRef = ref(storage, `posts/${currentUser.uid}/${Date.now()}-${file.name}`);
              const uploadTask = await uploadBytes(storageRef, compressedFile);
              const downloadURL = await getDownloadURL(uploadTask.ref);

              uploadedImageUrls.push(downloadURL);
              
              const percent = Math.floor(((i + 1) / limitedFiles.length) * 100);
              progressBar.style.width = `${percent}%`;
              uploadPercent.textContent = `${percent}%`;
              
              if(i < limitedFiles.length - 1) {
                  progressText.textContent = `ƒêang t·∫£i l√™n ${i + 2}/${limitedFiles.length} ·∫£nh...`;
              }
            }
          }

          progressText.textContent = "ƒêang ho√†n t·∫•t...";

          await addDoc(collection(db, "posts"), {
            displayName: currentUser.displayName || currentUser.email.split('@')[0],
            avatarUrl: currentUser.photoURL,
            uid: currentUser.uid,
            text: content,
            imageUrls: uploadedImageUrls,
            privacy: privacy, // L∆∞u quy·ªÅn ri√™ng t∆∞ v√†o database
            createdAt: serverTimestamp(),
            likes: [],
            commentsCount: 0
          });

          uploadBtn.textContent = "ƒê√£ ƒëƒÉng!";
          uploadBtn.classList.add("bg-green-500");
          
          setTimeout(() => {
              window.location.href = "feed.html";
          }, 800);

      } catch (error) {
          console.error(error);
          alert("L·ªói ƒëƒÉng b√†i: " + error.message);
          uploadBtn.disabled = false;
          uploadBtn.textContent = "ƒêƒÉng";
          progressContainer.classList.add("hidden");
      }
    });
  </script>
</body>
</html>
