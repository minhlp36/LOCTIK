<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>T·∫°o b√†i vi·∫øt - LokTik</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .safe-area-pb { padding-bottom: env(safe-area-inset-bottom, 20px); }
    
    /* Custom Select Styling */
    .select-wrapper { position: relative; display: inline-block; }
    .select-wrapper select {
        appearance: none;
        -webkit-appearance: none;
        padding-right: 1.5rem;
    }
  </style>
</head>
<body class="bg-white text-slate-900 pb-24">

  <header class="sticky top-0 bg-white/95 backdrop-blur-md z-30 border-b border-gray-50 px-4 h-14 flex justify-between items-center">
    <a href="feed.html" class="text-slate-900 hover:bg-gray-50 p-2 -ml-2 rounded-full transition">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
    </a>
    <h1 class="font-bold text-base">B√†i vi·∫øt m·ªõi</h1>
    <button id="uploadBtn" class="text-blue-600 font-bold text-sm px-2 py-1 rounded opacity-50 disabled:cursor-not-allowed transition-all" disabled>
      ƒêƒÉng
    </button>
  </header>

  <main class="max-w-md mx-auto mt-4 px-4">
    
    <div class="flex items-center gap-3 mb-4">
        <img id="userAvatar" src="https://via.placeholder.com/48" class="w-11 h-11 rounded-full border border-gray-100 object-cover">
        <div>
            <h3 id="userName" class="font-bold text-sm text-slate-900 leading-tight">Ng∆∞·ªùi d√πng</h3>
            
            <div class="select-wrapper mt-0.5">
                <select id="privacySelect" class="bg-blue-50 text-blue-600 text-xs font-bold py-1 pl-2 pr-6 rounded-md border border-blue-100 focus:outline-none">
                    <option value="public">üåç C√¥ng khai</option>
                    <option value="friends">üë• B·∫°n b√®</option>
                    <option value="private">üîí Ch·ªâ m√¨nh t√¥i</option>
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-1.5 text-blue-600">
                    <svg class="h-3 w-3 fill-current" viewBox="0 0 20 20"><path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" /></svg>
                </div>
            </div>
        </div>
    </div>

    <div class="min-h-[100px]">
        <textarea id="postContent" rows="3" class="w-full text-base outline-none placeholder-gray-400 resize-none bg-transparent leading-relaxed" placeholder="B·∫°n ƒëang nghƒ© g√¨?"></textarea>
    </div>

    <div id="previewContainer" class="flex gap-3 overflow-x-auto pb-4 pt-2 no-scrollbar">
        <label for="fileInput" class="flex-shrink-0 w-28 h-36 bg-gray-50 border border-gray-200 rounded-xl flex flex-col items-center justify-center cursor-pointer hover:bg-gray-100 transition active:scale-95">
            <div class="p-2 bg-white rounded-full shadow-sm mb-2 border border-gray-100">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 text-slate-900">
                    <path fill-rule="evenodd" d="M12 3.75a.75.75 0 01.75.75v6.75h6.75a.75.75 0 010 1.5h-6.75v6.75a.75.75 0 01-1.5 0v-6.75H4.5a.75.75 0 010-1.5h6.75V4.5a.75.75 0 01.75-.75z" clip-rule="evenodd" />
                </svg>
            </div>
            <span class="text-xs text-gray-500 font-semibold">Th√™m ·∫£nh</span>
        </label>
    </div>

    <input type="file" id="fileInput" accept="image/*" multiple class="hidden" />

    <div id="progressContainer" class="hidden mt-4 bg-white rounded-xl p-3 border border-gray-100 shadow-sm">
        <div class="flex justify-between text-xs font-bold text-slate-900 mb-2">
            <span id="progressText">ƒêang t·∫£i l√™n...</span>
            <span id="uploadPercent">0%</span>
        </div>
        <div class="w-full bg-gray-100 rounded-full h-2 overflow-hidden">
            <div id="progressBar" class="bg-black h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
        </div>
    </div>

  </main>

  <nav class="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-md border-t border-gray-100 flex justify-around items-center py-3 pb-safe z-50">
    <a href="feed.html" class="flex flex-col items-center text-gray-400 hover:text-black transition group w-16">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 group-hover:scale-110 transition">
        <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
      </svg>
    </a>

    <a href="friends.html" class="flex flex-col items-center text-gray-400 hover:text-black transition group w-16">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 group-hover:scale-110 transition">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" />
        </svg>
    </a>
    
    <a href="upload.html" class="flex flex-col items-center group -mt-6">
      <div class="w-14 h-14 bg-black rounded-full flex items-center justify-center shadow-xl shadow-black/30 scale-105 border-2 border-white transition">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-7 h-7 text-white">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
          </svg>
      </div>
    </a>

    <a href="chat.html" class="flex flex-col items-center text-gray-400 hover:text-black transition group w-16">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 group-hover:scale-110 transition">
            <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 8.25h9m-9 3H12m-9.75 1.51c0 1.6 1.123 2.994 2.707 3.227 1.129.166 2.27.293 3.423.379.35.026.67.21.865.501L12 21l2.755-4.133a1.14 1.14 0 01.865-.501 48.172 48.172 0 003.423-.379c1.584-.233 2.707-1.626 2.707-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0012 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018z" />
          </svg>
    </a>

    <a href="account.html" class="flex flex-col items-center text-gray-400 hover:text-black transition w-16">
      <div class="w-7 h-7 rounded-full border border-gray-300 overflow-hidden p-0.5">
         <img id="myNavAvatar" src="https://via.placeholder.com/30" class="w-full h-full rounded-full object-cover bg-gray-100">
      </div>
    </a>
  </nav>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAJxH_3ZkN7wQnXVelRzm0mezBCBcxKoJM",
      authDomain: "loktik-1d9af.firebaseapp.com",
      projectId: "loktik-1d9af",
      storageBucket: "loktik-1d9af.appspot.com",
      messagingSenderId: "801363229819",
      appId: "1:801363229819:web:49f086bc180d9ed9c0b6de"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // Elements
    const fileInput = document.getElementById("fileInput");
    const uploadBtn = document.getElementById("uploadBtn");
    const postContent = document.getElementById("postContent");
    const previewContainer = document.getElementById("previewContainer");
    const progressContainer = document.getElementById("progressContainer");
    const progressBar = document.getElementById("progressBar");
    const uploadPercent = document.getElementById("uploadPercent");
    const userAvatar = document.getElementById("userAvatar");
    const myNavAvatar = document.getElementById("myNavAvatar");
    const userName = document.getElementById("userName");
    const privacySelect = document.getElementById("privacySelect");
    const progressText = document.getElementById("progressText");

    let currentUser = null;

    onAuthStateChanged(auth, user => {
        if (!user) return window.location.href = "login.html";
        currentUser = user;
        
        const avatar = user.photoURL || `https://api.dicebear.com/9.x/avataaars/svg?seed=${user.uid}`;
        userAvatar.src = avatar;
        myNavAvatar.src = avatar;
        userName.textContent = user.displayName || user.email.split('@')[0];
    });

    // Auto Resize Textarea
    postContent.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
        checkUploadCondition();
    });

    fileInput.addEventListener('change', () => {
        const files = Array.from(fileInput.files);
        const addBtn = previewContainer.firstElementChild;
        previewContainer.innerHTML = '';
        previewContainer.appendChild(addBtn);

        files.slice(0, 10).forEach(file => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const imgDiv = document.createElement("div");
                imgDiv.className = "flex-shrink-0 w-28 h-36 rounded-xl bg-gray-100 overflow-hidden relative border border-gray-200 shadow-sm";
                imgDiv.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover">`;
                previewContainer.appendChild(imgDiv);
            };
            reader.readAsDataURL(file);
        });
        checkUploadCondition();
    });

    function checkUploadCondition() {
        if(postContent.value.trim() !== "" || fileInput.files.length > 0) {
            uploadBtn.disabled = false;
            uploadBtn.style.opacity = "1";
        } else {
            uploadBtn.disabled = true;
            uploadBtn.style.opacity = "0.5";
        }
    }

    async function compressImage(file) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
          const img = new Image();
          img.src = event.target.result;
          img.onload = () => {
            const canvas = document.createElement("canvas");
            const maxSize = 1080; 
            let width = img.width;
            let height = img.height;
            if (width > height) {
              if (width > maxSize) { height *= maxSize / width; width = maxSize; }
            } else {
              if (height > maxSize) { width *= maxSize / height; height = maxSize; }
            }
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, width, height);
            canvas.toBlob((blob) => resolve(blob), "image/jpeg", 0.85);
          };
        };
      });
    }

    uploadBtn.addEventListener("click", async () => {
     const content = postContent.value.trim();
     const privacy = privacySelect.value;
     const files = Array.from(fileInput.files);

     if (!content && files.length === 0) return;

      uploadBtn.disabled = true;
      uploadBtn.textContent = "ƒêang x·ª≠ l√Ω...";
      progressContainer.classList.remove("hidden");

      try {
          const uploadedImageUrls = [];
          if (files.length > 0) {
            const limitedFiles = files.slice(0, 10);
            
            for (let i = 0; i < limitedFiles.length; i++) {
              progressText.textContent = `ƒêang t·∫£i ·∫£nh ${i + 1}/${limitedFiles.length}...`;
              const file = limitedFiles[i];
              const compressedFile = await compressImage(file);

              const storageRef = ref(storage, `posts/${currentUser.uid}/${Date.now()}-${file.name}`);
              const uploadTask = await uploadBytes(storageRef, compressedFile);
              const downloadURL = await getDownloadURL(uploadTask.ref);

              uploadedImageUrls.push(downloadURL);
              
              const percent = Math.floor(((i + 1) / limitedFiles.length) * 100);
              progressBar.style.width = `${percent}%`;
              uploadPercent.textContent = `${percent}%`;
            }
          }

          progressText.textContent = "ƒêang ƒëƒÉng b√†i...";

          await addDoc(collection(db, "posts"), {
            displayName: currentUser.displayName || currentUser.email.split('@')[0],
            avatarUrl: currentUser.photoURL,
            uid: currentUser.uid,
            text: content,
            imageUrls: uploadedImageUrls,
            privacy: privacy,
            createdAt: serverTimestamp(),
            likes: [],
            commentsCount: 0
          });

          uploadBtn.textContent = "Th√†nh c√¥ng!";
          setTimeout(() => { window.location.href = "feed.html"; }, 500);

      } catch (error) {
          console.error(error);
          alert("L·ªói: " + error.message);
          uploadBtn.disabled = false;
          uploadBtn.textContent = "ƒêƒÉng";
          progressContainer.classList.add("hidden");
      }
    });
  </script>
</body>
</html>
