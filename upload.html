<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Đăng bài - LokTik</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
</head>
<body class="bg-gray-100 min-h-screen pb-20">
  <div class="max-w-md mx-auto p-4">
    <h1 class="text-2xl font-bold mb-4 text-center">Đăng bài</h1>

    <textarea id="postContent" rows="4" class="w-full p-2 border rounded mb-4" placeholder="Bạn đang nghĩ gì?"></textarea>

    <input type="file" id="fileInput" accept="image/*" multiple class="mb-2" />
    <p class="text-sm text-gray-500 mb-2">Tối đa 5 ảnh</p>

    <div id="progressContainer" class="mb-2 text-sm text-gray-700 hidden">Đang tải lên: <span id="uploadProgress">0%</span></div>

    <button id="uploadBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded">Đăng bài</button>
  </div>

  <!-- Thanh điều hướng -->
  <div class="fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around py-2">
    <a href="feed.html" class="text-center">
      <div>🏠</div>
      <div class="text-xs">Trang chủ</div>
    </a>
    <a href="upload.html" class="text-center">
      <div>➕</div>
      <div class="text-xs">Đăng</div>
    </a>
    <a href="chat.html" class="text-center">
      <div>💬</div>
      <div class="text-xs">Chat</div>
    </a>
    <a href="account.html" class="text-center">
      <div>👤</div>
      <div class="text-xs">Tôi</div>
    </a>
  </div>

  <script type="module">
    // Firebase cấu hình
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAJxH_3ZkN7wQnXVelRzm0mezBCBcxKoJM",
      authDomain: "loktik-1d9af.firebaseapp.com",
      projectId: "loktik-1d9af",
      storageBucket: "loktik-1d9af.appspot.com",
      messagingSenderId: "801363229819",
      appId: "1:801363229819:web:49f086bc180d9ed9c0b6de",
      measurementId: "G-S6HQ3HN7W3"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore(app);
    const storage = getStorage(app);

    const fileInput = document.getElementById("fileInput");
    const uploadBtn = document.getElementById("uploadBtn");
    const postContent = document.getElementById("postContent");
    const progressContainer = document.getElementById("progressContainer");
    const uploadProgress = document.getElementById("uploadProgress");

    async function compressImage(file) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
          const img = new Image();
          img.src = event.target.result;
          img.onload = () => {
            const canvas = document.createElement("canvas");
            const maxSize = 800;
            let width = img.width;
            let height = img.height;

            if (width > height) {
              if (width > maxSize) {
                height *= maxSize / width;
                width = maxSize;
              }
            } else {
              if (height > maxSize) {
                width *= maxSize / height;
                height = maxSize;
              }
            }

            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, width, height);
            canvas.toBlob((blob) => {
              resolve(blob);
            }, "image/jpeg", 0.7);
          };
        };
      });
    }

    uploadBtn.addEventListener("click", async () => {
      const content = postContent.value.trim();
      const files = Array.from(fileInput.files);

      uploadBtn.disabled = true;
      uploadBtn.textContent = "Đang đăng...";
      progressContainer.classList.remove("hidden");

      onAuthStateChanged(auth, async (user) => {
        if (user) {
          const uploadedImageUrls = [];

          if (files.length > 0) {
            const limitedFiles = files.slice(0, 5);
            for (let i = 0; i < limitedFiles.length; i++) {
              const file = limitedFiles[i];
              const compressedFile = await compressImage(file);

              const storageRef = ref(storage, `posts/${user.uid}/${Date.now()}-${file.name}`);
              const uploadTask = await uploadBytes(storageRef, compressedFile);
              const downloadURL = await getDownloadURL(uploadTask.ref);

              uploadedImageUrls.push(downloadURL);
              const percent = Math.floor(((i + 1) / limitedFiles.length) * 100);
              uploadProgress.textContent = `${percent}%`;
            }
          }

          await addDoc(collection(db, "posts"), {
            displayName: user.displayName,
            avatarUrl: user.photoURL,
            uid: user.uid,
            text: content,
            imageUrls: uploadedImageUrls,
            createdAt: serverTimestamp(),
          });

          alert("Đăng bài thành công!");
          postContent.value = "";
          fileInput.value = "";
          uploadProgress.textContent = "0%";
        } else {
          alert("Vui lòng đăng nhập trước.");
        }

        uploadBtn.disabled = false;
        uploadBtn.textContent = "Đăng bài";
        progressContainer.classList.add("hidden");
      });
    });
  </script>
</body>
</html>
