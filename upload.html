<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Đăng bài mới - LokTik</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Ẩn thanh cuộn */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>
<body class="bg-white text-slate-900 pb-24">

  <header class="sticky top-0 bg-white z-30 border-b border-gray-100 px-4 py-3 flex justify-between items-center">
    <a href="feed.html" class="text-gray-500 font-medium text-sm">Huỷ</a>
    <h1 class="font-bold text-lg">Bài đăng mới</h1>
    <button id="uploadBtn" class="bg-blue-600 text-white px-4 py-1.5 rounded-full text-sm font-bold opacity-50 disabled:cursor-not-allowed" disabled>
      Đăng
    </button>
  </header>

  <main class="max-w-md mx-auto">
    <div class="p-4">
      <div class="flex gap-3">
        <img id="userAvatar" src="https://via.placeholder.com/40" class="w-10 h-10 rounded-full bg-gray-200 border border-gray-100">
        <textarea id="postContent" rows="4" class="w-full mt-2 outline-none text-base placeholder-gray-400 resize-none" placeholder="Bạn đang nghĩ gì thế?"></textarea>
      </div>
    </div>

    <div id="previewContainer" class="flex gap-2 overflow-x-auto px-4 pb-4 no-scrollbar min-h-[100px]">
        <label for="fileInput" class="flex-shrink-0 w-24 h-32 bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:bg-gray-100 transition">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-gray-400">
                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a2.25 2.25 0 002.25-2.25V6a2.25 2.25 0 00-2.25-2.25H3.75A2.25 2.25 0 001.5 6v12.25c0 1.243 1.057 2.25 2.25 2.25zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
            </svg>
            <span class="text-xs text-gray-400 mt-1 font-medium">Thêm ảnh</span>
        </label>
        
        </div>

    <input type="file" id="fileInput" accept="image/*" multiple class="hidden" />

    <div id="progressContainer" class="hidden px-4 mt-4">
        <div class="flex justify-between text-xs text-gray-500 mb-1">
            <span>Đang tải lên...</span>
            <span id="uploadPercent">0%</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2">
            <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
        </div>
    </div>
  </main>

  <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 flex justify-around items-center py-3 pb-5 z-40 safe-area-pb">
    <a href="feed.html" class="flex flex-col items-center text-gray-400 hover:text-black transition group">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-7 h-7">
        <path d="M11.47 3.84a.75.75 0 011.06 0l8.69 8.69a.75.75 0 101.06-1.06l-8.689-8.69a2.25 2.25 0 00-3.182 0l-8.69 8.69a.75.75 0 001.061 1.06l8.69-8.69z" />
        <path d="M12 5.432l8.159 8.159c.03.03.06.058.091.086v6.198c0 1.035-.84 1.875-1.875 1.875H15a.75.75 0 01-.75-.75v-4.5a.75.75 0 00-.75-.75h-3a.75.75 0 00-.75.75V21a.75.75 0 01-.75.75H5.625a1.875 1.875 0 01-1.875-1.875v-6.198a2.29 2.29 0 00.091-.086L12 5.43z" />
      </svg>
      <span class="text-[10px] font-medium mt-1">Trang chủ</span>
    </a>

    <a href="friends.html" class="flex flex-col items-center text-gray-400 hover:text-black transition group">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-7 h-7">
            <path fill-rule="evenodd" d="M8.25 6.75a3.75 3.75 0 117.5 0 3.75 3.75 0 01-7.5 0zM15.75 9.75a3 3 0 116 0 3 3 0 01-6 0zM2.25 9.75a3 3 0 116 0 3 3 0 01-6 0zM6.31 15.117A6.745 6.745 0 0112 12a6.745 6.745 0 016.709 7.498.75.75 0 01-.372.568A12.696 12.696 0 0112 21.75c-2.305 0-4.47-.612-6.337-1.684a.75.75 0 01-.372-.568 6.787 6.787 0 011.019-4.38z" clip-rule="evenodd" />
            <path d="M5.082 14.254a8.287 8.287 0 00-1.308 5.135 9.687 9.687 0 01-1.764-.44l-.115-.04a.563.563 0 01-.373-.487l-.01-.121a3.75 3.75 0 013.57-4.047zM20.226 19.389a8.287 8.287 0 00-1.308-5.135 3.75 3.75 0 013.57 4.047l-.01.121a.563.563 0 01-.373.486l-.115.04c-.567.2-1.156.349-1.764.441z" />
        </svg>
        <span class="text-[10px] font-medium mt-1">Bạn bè</span>
    </a>
    
    <a href="upload.html" class="flex flex-col items-center group">
      <div class="relative w-12 h-8 scale-110">
        <div class="absolute left-0 top-0 bottom-0 w-8 bg-cyan-400 rounded-lg transform -translate-x-1"></div>
        <div class="absolute right-0 top-0 bottom-0 w-8 bg-red-500 rounded-lg transform translate-x-1"></div>
        <div class="absolute left-0 right-0 top-0 bottom-0 bg-white rounded-lg flex items-center justify-center border-x-2 border-black">
            <span class="text-black font-bold text-xl leading-none mb-0.5">+</span>
        </div>
      </div>
    </a>

    <a href="chat.html" class="flex flex-col items-center text-gray-400 hover:text-black transition group">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-7 h-7">
            <path fill-rule="evenodd" d="M4.804 21.644A6.707 6.707 0 006 21.75a6.721 6.721 0 003.583-1.029c.774.182 1.584.279 2.417.279 5.322 0 9.75-3.97 9.75-9 0-5.03-4.428-9-9.75-9s-9.75 3.97-9.75 9c0 2.409 1.025 4.587 2.674 6.192.232.226.277.428.254.543a3.73 3.73 0 01-.814 1.686.75.75 0 00.44 1.223zM8.25 10.875a1.125 1.125 0 100 2.25 1.125 1.125 0 000-2.25zM10.875 12a1.125 1.125 0 112.25 0 1.125 1.125 0 01-2.25 0zm4.875-1.125a1.125 1.125 0 100 2.25 1.125 1.125 0 000-2.25z" clip-rule="evenodd" />
          </svg>
      <span class="text-[10px] font-medium mt-1">Hộp thư</span>
    </a>

    <a href="account.html" class="flex flex-col items-center text-gray-400 hover:text-black transition">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-7 h-7">
        <path fill-rule="evenodd" d="M7.5 6a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM3.751 20.105a8.25 8.25 0 0116.498 0 .75.75 0 01-.437.695A18.683 18.683 0 0112 22.5c-2.786 0-5.433-.608-7.812-1.7a.75.75 0 01-.437-.695z" clip-rule="evenodd" />
      </svg>
      <span class="text-[10px] font-medium mt-1">Hồ sơ</span>
    </a>
  </nav>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAJxH_3ZkN7wQnXVelRzm0mezBCBcxKoJM",
      authDomain: "loktik-1d9af.firebaseapp.com",
      projectId: "loktik-1d9af",
      storageBucket: "loktik-1d9af.appspot.com",
      messagingSenderId: "801363229819",
      appId: "1:801363229819:web:49f086bc180d9ed9c0b6de"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const fileInput = document.getElementById("fileInput");
    const uploadBtn = document.getElementById("uploadBtn");
    const postContent = document.getElementById("postContent");
    const previewContainer = document.getElementById("previewContainer");
    const progressContainer = document.getElementById("progressContainer");
    const progressBar = document.getElementById("progressBar");
    const uploadPercent = document.getElementById("uploadPercent");
    const userAvatar = document.getElementById("userAvatar");

    let currentUser = null;

    // Load User info
    onAuthStateChanged(auth, user => {
        if (!user) return window.location.href = "login.html";
        currentUser = user;
        if(user.photoURL) userAvatar.src = user.photoURL;
    });

    // Handle Input change (Preview Images)
    fileInput.addEventListener('change', () => {
        const files = Array.from(fileInput.files);
        
        // Clear old previews except the "Add" button (first child)
        while (previewContainer.children.length > 1) {
            previewContainer.removeChild(previewContainer.lastChild);
        }

        if(files.length > 0 || postContent.value.trim() !== "") {
            uploadBtn.disabled = false;
            uploadBtn.style.opacity = "1";
        }

        files.slice(0, 5).forEach(file => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const imgDiv = document.createElement("div");
                imgDiv.className = "flex-shrink-0 w-24 h-32 rounded-lg bg-gray-100 overflow-hidden relative border border-gray-200";
                imgDiv.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover">`;
                previewContainer.appendChild(imgDiv);
            };
            reader.readAsDataURL(file);
        });
    });

    postContent.addEventListener('input', () => {
        if(postContent.value.trim() !== "" || fileInput.files.length > 0) {
            uploadBtn.disabled = false;
            uploadBtn.style.opacity = "1";
        } else {
            uploadBtn.disabled = true;
            uploadBtn.style.opacity = "0.5";
        }
    });

    // Compression Logic (Giữ nguyên logic tốt của bạn)
    async function compressImage(file) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
          const img = new Image();
          img.src = event.target.result;
          img.onload = () => {
            const canvas = document.createElement("canvas");
            const maxSize = 800;
            let width = img.width;
            let height = img.height;
            if (width > height) {
              if (width > maxSize) { height *= maxSize / width; width = maxSize; }
            } else {
              if (height > maxSize) { width *= maxSize / height; height = maxSize; }
            }
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, width, height);
            canvas.toBlob((blob) => resolve(blob), "image/jpeg", 0.7);
          };
        };
      });
    }

    // Upload Logic
    uploadBtn.addEventListener("click", async () => {
     const content = postContent.value.trim();
     const files = Array.from(fileInput.files);

     if (!content && files.length === 0) return;

      uploadBtn.disabled = true;
      uploadBtn.textContent = "Đang đăng...";
      progressContainer.classList.remove("hidden");

      try {
          const uploadedImageUrls = [];
          if (files.length > 0) {
            const limitedFiles = files.slice(0, 5);
            for (let i = 0; i < limitedFiles.length; i++) {
              const file = limitedFiles[i];
              const compressedFile = await compressImage(file);

              const storageRef = ref(storage, `posts/${currentUser.uid}/${Date.now()}-${file.name}`);
              const uploadTask = await uploadBytes(storageRef, compressedFile);
              const downloadURL = await getDownloadURL(uploadTask.ref);

              uploadedImageUrls.push(downloadURL);
              
              // Visual Progress
              const percent = Math.floor(((i + 1) / limitedFiles.length) * 100);
              progressBar.style.width = `${percent}%`;
              uploadPercent.textContent = `${percent}%`;
            }
          }

          await addDoc(collection(db, "posts"), {
            displayName: currentUser.displayName || currentUser.email.split('@')[0],
            avatarUrl: currentUser.photoURL,
            uid: currentUser.uid,
            text: content,
            imageUrls: uploadedImageUrls,
            createdAt: serverTimestamp(),
            likes: [] // Init empty likes
          });

          // Reset UI
          postContent.value = "";
          fileInput.value = "";
          while (previewContainer.children.length > 1) {
            previewContainer.removeChild(previewContainer.lastChild);
          }
          uploadBtn.textContent = "Đã đăng!";
          setTimeout(() => {
              window.location.href = "feed.html";
          }, 1000);

      } catch (error) {
          console.error(error);
          alert("Lỗi đăng bài: " + error.message);
          uploadBtn.disabled = false;
          uploadBtn.textContent = "Đăng";
      }
    });
  </script>
</body>
</html>
