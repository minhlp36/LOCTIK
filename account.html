<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>H·ªì s∆° - LokTik</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    /* Hi·ªáu ·ª©ng m·ªù n·ªÅn khi m·ªü modal */
    .modal-backdrop { background-color: rgba(0, 0, 0, 0.6); }
  </style>
</head>
<body class="bg-white text-slate-900 pb-20">

  <header class="sticky top-0 bg-white z-30 border-b border-gray-50 flex justify-between items-center px-4 h-14">
    <div class="w-6"></div> <h1 class="font-bold text-lg" id="headerName">ƒêang t·∫£i...</h1>
    
    <button id="menuBtn" class="text-slate-800 p-2 -mr-2">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7">
        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
      </svg>
    </button>
  </header>

  <div id="settingsMenu" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/20" id="closeMenuOverlay"></div>
    <div class="absolute right-4 top-14 w-48 bg-white rounded-xl shadow-xl border border-gray-100 overflow-hidden animation-fade-in">
        <button id="logoutBtn" class="w-full text-left px-4 py-3 text-red-500 font-medium hover:bg-red-50 flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9" />
            </svg>
            ƒêƒÉng xu·∫•t
        </button>
    </div>
  </div>

  <main class="max-w-md mx-auto">
    <div class="flex flex-col items-center pt-6 pb-2">
      <div class="relative mb-3">
        <div class="w-24 h-24 rounded-full p-1 border border-gray-200">
            <img id="userAvatar" src="https://via.placeholder.com/100" class="w-full h-full rounded-full object-cover bg-gray-100" alt="Avatar">
        </div>
        <div class="absolute bottom-1 right-1 w-5 h-5 bg-green-500 rounded-full border-2 border-white"></div>
      </div>

      <h2 id="userName" class="text-xl font-bold text-slate-900 leading-tight">@username</h2>
      <p id="userEmail" class="text-xs text-gray-400 mt-0.5 mb-5">ƒêang t·∫£i...</p>

      <div class="flex items-center justify-center w-full px-6 mb-6 divide-x divide-gray-200">
        <div class="flex-1 text-center px-2">
          <span class="block font-bold text-lg text-slate-900">128</span>
          <span class="text-xs text-gray-500 font-medium">ƒêang follow</span>
        </div>
        <div class="flex-1 text-center px-2">
          <span class="block font-bold text-lg text-slate-900">4.5k</span>
          <span class="text-xs text-gray-500 font-medium">Follower</span>
        </div>
        <div class="flex-1 text-center px-2">
          <span class="block font-bold text-lg text-slate-900">10.2k</span>
          <span class="text-xs text-gray-500 font-medium">Th√≠ch</span>
        </div>
      </div>

      <div class="flex gap-2 mb-6 w-full px-4">
        <button class="flex-1 py-2.5 bg-slate-900 text-white rounded-lg font-semibold text-sm hover:bg-slate-800 transition shadow-sm">S·ª≠a h·ªì s∆°</button>
        <button class="px-3.5 py-2.5 bg-gray-100 rounded-lg text-slate-700 hover:bg-gray-200 transition border border-gray-200">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M7.217 10.907a2.25 2.25 0 100 2.186m0-2.186c.18.324.283.696.283 1.093s-.103.77-.283 1.093m0-2.186l9.566-5.314m-9.566 7.5l9.566 5.314m0 0a2.25 2.25 0 103.935 2.186 2.25 2.25 0 00-3.935-2.186zm0-12.814a2.25 2.25 0 103.933-2.185 2.25 2.25 0 00-3.933 2.185z" />
          </svg>
        </button>
      </div>
    </div>

    <div class="flex border-b border-gray-200 sticky top-14 bg-white z-20">
      <div class="flex-1 py-3 flex justify-center cursor-pointer border-b-2 border-slate-900 text-slate-900">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
          <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25a2.25 2.25 0 01-2.25-2.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z" />
        </svg>
      </div>
      <div class="flex-1 py-3 flex justify-center cursor-pointer text-gray-400 hover:text-gray-600">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" />
        </svg>
      </div>
      <div class="flex-1 py-3 flex justify-center cursor-pointer text-gray-400 hover:text-gray-600">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z" />
        </svg>
      </div>
    </div>

    <div class="min-h-[300px] bg-white pb-10">
      <div id="loadingSkeleton" class="grid grid-cols-3 gap-0.5">
        <div class="aspect-[3/4] bg-gray-100 animate-pulse"></div>
        <div class="aspect-[3/4] bg-gray-100 animate-pulse"></div>
        <div class="aspect-[3/4] bg-gray-100 animate-pulse"></div>
      </div>

      <div id="emptyState" class="hidden flex flex-col items-center justify-center py-16 text-gray-500">
        <div class="w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mb-3">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-gray-300">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.774 48.774 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zM18.75 10.5h.008v.008h-.008V10.5z" />
            </svg>
        </div>
        <p class="text-sm font-medium">Ch∆∞a c√≥ b√†i ƒëƒÉng n√†o</p>
        <a href="upload.html" class="mt-3 text-blue-600 font-semibold text-sm hover:underline">T·∫°o b√†i vi·∫øt m·ªõi</a>
      </div>
      
      <div id="myPosts" class="grid grid-cols-3 gap-0.5"></div>
    </div>
  </main>

  <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 flex justify-around items-center py-3 pb-5 z-40 safe-area-pb shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.02)]">
    <a href="feed.html" class="flex flex-col items-center text-gray-400 hover:text-black transition group">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-7 h-7">
        <path d="M11.47 3.84a.75.75 0 011.06 0l8.69 8.69a.75.75 0 101.06-1.06l-8.689-8.69a2.25 2.25 0 00-3.182 0l-8.69 8.69a.75.75 0 001.061 1.06l8.69-8.69z" />
        <path d="M12 5.432l8.159 8.159c.03.03.06.058.091.086v6.198c0 1.035-.84 1.875-1.875 1.875H15a.75.75 0 01-.75-.75v-4.5a.75.75 0 00-.75-.75h-3a.75.75 0 00-.75.75V21a.75.75 0 01-.75.75H5.625a1.875 1.875 0 01-1.875-1.875v-6.198a2.29 2.29 0 00.091-.086L12 5.43z" />
      </svg>
      <span class="text-[10px] font-medium mt-1">Trang ch·ªß</span>
    </a>
    <a href="friends.html" class="flex flex-col items-center text-gray-400 hover:text-black transition group">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-7 h-7">
            <path fill-rule="evenodd" d="M8.25 6.75a3.75 3.75 0 117.5 0 3.75 3.75 0 01-7.5 0zM15.75 9.75a3 3 0 116 0 3 3 0 01-6 0zM2.25 9.75a3 3 0 116 0 3 3 0 01-6 0zM6.31 15.117A6.745 6.745 0 0112 12a6.745 6.745 0 016.709 7.498.75.75 0 01-.372.568A12.696 12.696 0 0112 21.75c-2.305 0-4.47-.612-6.337-1.684a.75.75 0 01-.372-.568 6.787 6.787 0 011.019-4.38z" clip-rule="evenodd" />
            <path d="M5.082 14.254a8.287 8.287 0 00-1.308 5.135 9.687 9.687 0 01-1.764-.44l-.115-.04a.563.563 0 01-.373-.487l-.115.04a3.75 3.75 0 013.57-4.047zM20.226 19.389a8.287 8.287 0 00-1.308-5.135 3.75 3.75 0 013.57 4.047l-.01.121a.563.563 0 01-.373.486l-.115.04c-.567.2-1.156.349-1.764.441z" />
        </svg>
        <span class="text-[10px] font-medium mt-1">B·∫°n b√®</span>
    </a>
    
    <a href="upload.html" class="flex flex-col items-center group">
      <div class="relative w-12 h-8 scale-110">
        <div class="absolute left-0 top-0 bottom-0 w-8 bg-cyan-400 rounded-lg transform -translate-x-1 shadow-sm"></div>
        <div class="absolute right-0 top-0 bottom-0 w-8 bg-red-500 rounded-lg transform translate-x-1 shadow-sm"></div>
        <div class="absolute left-0 right-0 top-0 bottom-0 bg-white rounded-lg flex items-center justify-center border-x-2 border-black z-10">
            <span class="text-black font-bold text-xl leading-none mb-0.5">+</span>
        </div>
      </div>
    </a>

    <a href="chat.html" class="flex flex-col items-center text-gray-400 hover:text-black transition group">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-7 h-7">
            <path fill-rule="evenodd" d="M4.804 21.644A6.707 6.707 0 006 21.75a6.721 6.721 0 003.583-1.029c.774.182 1.584.279 2.417.279 5.322 0 9.75-3.97 9.75-9 0-5.03-4.428-9-9.75-9s-9.75 3.97-9.75 9c0 2.409 1.025 4.587 2.674 6.192.232.226.277.428.254.543a3.73 3.73 0 01-.814 1.686.75.75 0 00.44 1.223zM8.25 10.875a1.125 1.125 0 100 2.25 1.125 1.125 0 000-2.25zM10.875 12a1.125 1.125 0 112.25 0 1.125 1.125 0 01-2.25 0zm4.875-1.125a1.125 1.125 0 100 2.25 1.125 1.125 0 000-2.25z" clip-rule="evenodd" />
          </svg>
      <span class="text-[10px] font-medium mt-1">H·ªôp th∆∞</span>
    </a>

    <a href="account.html" class="flex flex-col items-center text-black transition">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-7 h-7">
        <path fill-rule="evenodd" d="M7.5 6a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM3.751 20.105a8.25 8.25 0 0116.498 0 .75.75 0 01-.437.695A18.683 18.683 0 0112 22.5c-2.786 0-5.433-.608-7.812-1.7a.75.75 0 01-.437-.695z" clip-rule="evenodd" />
      </svg>
      <span class="text-[10px] font-medium mt-1">H·ªì s∆°</span>
    </a>
  </nav>

  <div id="postModal" class="fixed inset-0 z-50 hidden">
    <div id="modalBackdrop" class="absolute inset-0 modal-backdrop transition-opacity"></div>
    
    <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-2xl p-6 transform transition-transform duration-300">
        <div class="w-12 h-1.5 bg-gray-300 rounded-full mx-auto mb-6"></div>
        
        <h3 class="text-lg font-bold mb-4">Qu·∫£n l√Ω b√†i vi·∫øt</h3>
        
        <div class="mb-4">
            <label class="block text-xs text-gray-500 font-semibold mb-1 uppercase">Ch·ªânh s·ª≠a m√¥ t·∫£</label>
            <textarea id="editCaptionInput" rows="3" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"></textarea>
        </div>

        <div class="mb-6">
             <label class="block text-xs text-gray-500 font-semibold mb-1 uppercase">Quy·ªÅn ri√™ng t∆∞</label>
             <select id="editPrivacyInput" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2.5 text-sm">
                 <option value="public">üåç C√¥ng khai</option>
                 <option value="friends">üë• B·∫°n b√®</option>
                 <option value="private">üîí Ch·ªâ m√¨nh t√¥i</option>
             </select>
        </div>

        <div class="flex gap-3">
            <button id="deletePostBtn" class="flex-1 bg-red-50 text-red-600 font-bold py-3 rounded-xl hover:bg-red-100 transition">Xo√° b√†i</button>
            <button id="savePostBtn" class="flex-1 bg-slate-900 text-white font-bold py-3 rounded-xl hover:bg-slate-800 transition">L∆∞u thay ƒë·ªïi</button>
        </div>
        <button id="closeModalBtn" class="w-full mt-3 py-3 text-gray-500 font-medium">Hu·ª∑ b·ªè</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, query, where, orderBy, getDocs, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAJxH_3ZkN7wQnXVelRzm0mezBCBcxKoJM",
      authDomain: "loktik-1d9af.firebaseapp.com",
      projectId: "loktik-1d9af",
      storageBucket: "loktik-1d9af.appspot.com",
      messagingSenderId: "801363229819",
      appId: "1:801363229819:web:49f086bc180d9ed9c0b6de"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // DOM Elements
    const headerName = document.getElementById("headerName");
    const userName = document.getElementById("userName");
    const userEmail = document.getElementById("userEmail");
    const userAvatar = document.getElementById("userAvatar");
    const myPosts = document.getElementById("myPosts");
    const menuBtn = document.getElementById("menuBtn");
    const settingsMenu = document.getElementById("settingsMenu");
    const closeMenuOverlay = document.getElementById("closeMenuOverlay");
    const logoutBtn = document.getElementById("logoutBtn");
    const loadingSkeleton = document.getElementById("loadingSkeleton");
    const emptyState = document.getElementById("emptyState");

    // Modal Elements
    const postModal = document.getElementById("postModal");
    const modalBackdrop = document.getElementById("modalBackdrop");
    const closeModalBtn = document.getElementById("closeModalBtn");
    const savePostBtn = document.getElementById("savePostBtn");
    const deletePostBtn = document.getElementById("deletePostBtn");
    const editCaptionInput = document.getElementById("editCaptionInput");
    const editPrivacyInput = document.getElementById("editPrivacyInput");

    let currentPostId = null;
    let currentPostElement = null;

    // --- Menu Logic ---
    menuBtn.addEventListener("click", () => settingsMenu.classList.remove("hidden"));
    closeMenuOverlay.addEventListener("click", () => settingsMenu.classList.add("hidden"));
    
    logoutBtn.addEventListener("click", () => {
        if(confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t?")) {
            signOut(auth).then(() => window.location.href = "login.html");
        }
    });

    // --- Auth & Data Loading ---
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        const name = user.displayName || user.email.split('@')[0];
        headerName.textContent = name;
        userName.textContent = "@" + name.replace(/\s/g, '').toLowerCase();
        userEmail.textContent = user.email;
        if(user.photoURL) userAvatar.src = user.photoURL;

        await loadUserPosts(user.uid);
      } else {
        window.location.href = "login.html";
      }
    });

    async function loadUserPosts(uid) {
      try {
        const q = query(collection(db, "posts"), where("uid", "==", uid), orderBy("createdAt", "desc"));
        const querySnapshot = await getDocs(q);

        loadingSkeleton.style.display = "none";
        myPosts.innerHTML = "";

        if (querySnapshot.empty) {
          emptyState.classList.remove("hidden");
          return;
        }

        querySnapshot.forEach((docSnap) => {
          renderPost(docSnap.id, docSnap.data());
        });

      } catch (error) {
        console.error("L·ªói:", error);
        // Fallback if index is missing (createdAt desc requires index)
        if(error.code === 'failed-precondition') {
             const qSimple = query(collection(db, "posts"), where("uid", "==", uid));
             const snap = await getDocs(qSimple);
             loadingSkeleton.style.display = "none";
             snap.forEach(d => renderPost(d.id, d.data()));
        }
      }
    }

    function renderPost(id, post) {
        const postDiv = document.createElement("div");
        postDiv.className = "relative bg-gray-100 aspect-[3/4] overflow-hidden cursor-pointer group border border-white";
        postDiv.dataset.id = id;

        // X·ª≠ l√Ω hi·ªÉn th·ªã ·∫£nh thumbnail (l·∫•y ·∫£nh ƒë·∫ßu ti√™n)
        let thumbnail = "https://via.placeholder.com/150";
        let isMultiple = false;

        if (post.imageUrls && post.imageUrls.length > 0) {
            thumbnail = post.imageUrls[0];
            isMultiple = post.imageUrls.length > 1;
        }

        // T·∫°o ph·∫ßn t·ª≠ ·∫£nh
        const imgEl = document.createElement("img");
        imgEl.src = thumbnail;
        imgEl.className = "w-full h-full object-cover transition-transform duration-500 group-hover:scale-105";
        postDiv.appendChild(imgEl);

        // Icon Album (n·∫øu nhi·ªÅu ·∫£nh)
        if (isMultiple) {
            const albumIcon = document.createElement("div");
            albumIcon.className = "absolute top-2 right-2 bg-black/50 p-1 rounded backdrop-blur-sm";
            albumIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="white" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 text-white"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 01-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 011.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 00-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 01-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 00-3.375-3.375h-1.5a1.125 1.125 0 01-1.125-1.125v-1.5a3.375 3.375 0 00-3.375-3.375H9.75" /></svg>`;
            postDiv.appendChild(albumIcon);
        }

        // Icon Private (n·∫øu ch·ªâ m√¨nh t√¥i)
        if (post.privacy === 'private') {
             const lockIcon = document.createElement("div");
             lockIcon.className = "absolute bottom-2 left-2 text-white drop-shadow-md";
             lockIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4"><path fill-rule="evenodd" d="M12 1.5a5.25 5.25 0 00-5.25 5.25v3a3 3 0 00-3 3v6.75a3 3 0 003 3h10.5a3 3 0 003-3v-6.75a3 3 0 00-3-3v-3c0-2.9-2.35-5.25-5.25-5.25zm3.75 8.25v-3a3.75 3.75 0 10-7.5 0v3h7.5z" clip-rule="evenodd" /></svg>`;
             postDiv.appendChild(lockIcon);
        }

        // S·ª± ki·ªán click ƒë·ªÉ m·ªü modal
        postDiv.addEventListener("click", () => openModal(id, post, postDiv));
        myPosts.appendChild(postDiv);
    }

    // --- Modal Logic (Edit/Delete) ---
    function openModal(id, post, element) {
        currentPostId = id;
        currentPostElement = element;
        editCaptionInput.value = post.text || "";
        editPrivacyInput.value = post.privacy || "public";
        
        postModal.classList.remove("hidden");
    }

    function closeModal() {
        postModal.classList.add("hidden");
        currentPostId = null;
        currentPostElement = null;
    }

    modalBackdrop.addEventListener("click", closeModal);
    closeModalBtn.addEventListener("click", closeModal);

    // Save Changes
    savePostBtn.addEventListener("click", async () => {
        if(!currentPostId) return;
        
        const newText = editCaptionInput.value;
        const newPrivacy = editPrivacyInput.value;

        savePostBtn.textContent = "ƒêang l∆∞u...";
        savePostBtn.disabled = true;

        try {
            await updateDoc(doc(db, "posts", currentPostId), {
                text: newText,
                privacy: newPrivacy
            });
            alert("ƒê√£ c·∫≠p nh·∫≠t b√†i vi·∫øt!");
            // Reload page to reflect changes is easiest, or update DOM manually
            window.location.reload(); 
        } catch (e) {
            alert("L·ªói: " + e.message);
        } finally {
            savePostBtn.textContent = "L∆∞u thay ƒë·ªïi";
            savePostBtn.disabled = false;
            closeModal();
        }
    });

    // Delete Post
    deletePostBtn.addEventListener("click", async () => {
        if(!currentPostId) return;

        if(confirm("H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c. Xo√° ngay?")) {
            deletePostBtn.textContent = "ƒêang xo√°...";
            try {
                await deleteDoc(doc(db, "posts", currentPostId));
                currentPostElement.remove();
                if(myPosts.children.length === 0) emptyState.classList.remove("hidden");
                closeModal();
            } catch (e) {
                alert("L·ªói xo√° b√†i: " + e.message);
                deletePostBtn.textContent = "Xo√° b√†i";
            }
        }
    });

  </script>
</body>
</html>
