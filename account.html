<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tài khoản của tôi</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/10.5.0/firebase-auth.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/10.5.0/firebase-storage.js"></script>
</head>
<body class="bg-gray-100 text-gray-800">

  <div class="max-w-xl mx-auto p-4">

    <!-- Thông tin người dùng -->
    <div id="user-info" class="bg-white shadow p-4 mb-6 rounded text-center">
      <img id="user-avatar" src="" alt="Avatar" class="w-24 h-24 mx-auto rounded-full object-cover">
      <h2 id="user-email" class="text-lg font-bold mt-2"></h2>
      <p id="user-uid" class="text-sm text-gray-500 break-all"></p>
    </div>

    <!-- Bài đăng của tôi -->
    <div class="bg-white shadow p-4 rounded mb-6">
      <h2 class="text-xl font-semibold mb-4">Bài viết của tôi</h2>
      <div id="my-posts" class="space-y-4"></div>
    </div>

    <!-- Nút quay lại -->
    <div class="text-center">
      <a href="feed.html" class="bg-blue-500 text-white px-4 py-2 rounded">⬅️ Quay lại</a>
    </div>

  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-auth.js";
    import { getFirestore, collection, query, where, orderBy, onSnapshot, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";
    import { getStorage, ref, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const userInfo = document.getElementById("user-info");
    const userEmail = document.getElementById("user-email");
    const userUid = document.getElementById("user-uid");
    const userAvatar = document.getElementById("user-avatar");
    const postList = document.getElementById("my-posts");

    onAuthStateChanged(auth, user => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }

      // Hiển thị thông tin người dùng
      userEmail.textContent = user.email;
      userUid.textContent = user.uid;
      userAvatar.src = user.photoURL || "https://i.pravatar.cc/150?img=12";

      // Lấy bài viết của người dùng
      const q = query(
        collection(db, "posts"),
        where("uid", "==", user.uid),
        orderBy("createdAt", "desc")
      );

      onSnapshot(q, snapshot => {
        postList.innerHTML = "";
        snapshot.forEach(docSnap => {
          const post = docSnap.data();
          const postId = docSnap.id;

          const postDiv = document.createElement("div");
          postDiv.className = "border p-3 rounded shadow-sm";

          postDiv.innerHTML = `
            <img src="${post.imageUrl}" alt="post" class="w-full rounded mb-2">
            <p class="text-gray-700 mb-1">${post.caption || ""}</p>
            <p class="text-xs text-gray-400">${new Date(post.createdAt?.seconds * 1000).toLocaleString()}</p>
            <div class="mt-2 flex gap-2">
              <button class="bg-red-500 text-white px-3 py-1 rounded delete-btn" data-id="${postId}">Xoá</button>
              <!-- <button class="bg-yellow-400 text-white px-3 py-1 rounded">Sửa</button> -->
            </div>
          `;

          postList.appendChild(postDiv);
        });

        // Xử lý xoá
        document.querySelectorAll(".delete-btn").forEach(btn => {
          btn.addEventListener("click", async () => {
            const id = btn.getAttribute("data-id");
            if (confirm("Bạn có chắc muốn xoá bài viết này không?")) {
              await deleteDoc(doc(db, "posts", id));
            }
          });
        });
      });
    });
  </script>
</body>
</html>
