<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hồ sơ - LokTik</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Ẩn thanh cuộn nhưng vẫn cuộn được */
    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }
    .no-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
  </style>
</head>
<body class="bg-white text-slate-900 font-sans antialiased pb-20">

  <header class="sticky top-0 bg-white z-30 border-b border-gray-100">
    <div class="flex justify-between items-center px-4 h-12 max-w-md mx-auto">
      <div class="w-6"></div> <h1 class="font-bold text-lg" id="headerName">...</h1>
      <button id="logoutBtn" class="text-slate-800">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9" />
        </svg>
      </button>
    </div>
  </header>

  <main class="max-w-md mx-auto">
    <div class="flex flex-col items-center pt-6 pb-4">
      <div class="relative mb-3">
        <div class="w-24 h-24 rounded-full bg-gray-200 overflow-hidden border-2 border-white shadow-sm">
          <img id="userAvatar" src="https://api.dicebear.com/9.x/avataaars/svg?seed=Felix" class="w-full h-full object-cover" alt="Avatar">
        </div>
        <div class="absolute bottom-0 right-0 bg-blue-500 text-white rounded-full p-1 border-2 border-white">
           <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-3 h-3">
             <path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
           </svg>
        </div>
      </div>

      <h2 id="userName" class="text-lg font-bold text-slate-900">@username</h2>
      <p id="userId" class="text-xs text-gray-400 mb-4">UID: ...</p>

      <div class="flex items-center justify-center space-x-8 mb-6 text-slate-800">
        <div class="text-center">
          <span class="block font-bold text-lg">128</span>
          <span class="text-xs text-gray-500">Đang follow</span>
        </div>
        <div class="text-center">
          <span class="block font-bold text-lg">4.5k</span>
          <span class="text-xs text-gray-500">Follower</span>
        </div>
        <div class="text-center">
          <span class="block font-bold text-lg">10.2k</span>
          <span class="text-xs text-gray-500">Thích</span>
        </div>
      </div>

      <div class="flex space-x-2 mb-4 w-full px-12">
        <button class="flex-1 py-2 bg-gray-100 rounded font-semibold text-sm hover:bg-gray-200 transition">Sửa hồ sơ</button>
        <button class="px-3 py-2 bg-gray-100 rounded hover:bg-gray-200 transition">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M7.217 10.907a2.25 2.25 0 100 2.186m0-2.186c.18.324.283.696.283 1.093s-.103.77-.283 1.093m0-2.186l9.566-5.314m-9.566 7.5l9.566 5.314m0 0a2.25 2.25 0 103.935 2.186 2.25 2.25 0 00-3.935-2.186zm0-12.814a2.25 2.25 0 103.933-2.185 2.25 2.25 0 00-3.933 2.185z" />
          </svg>
        </button>
      </div>
    </div>

    <div class="flex border-t border-b border-gray-200">
      <div class="flex-1 py-3 flex justify-center cursor-pointer border-b-2 border-black text-black">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
          <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25a2.25 2.25 0 01-2.25-2.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z" />
        </svg>
      </div>
      <div class="flex-1 py-3 flex justify-center cursor-pointer text-gray-400 hover:text-gray-600">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
          <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" />
        </svg>
      </div>
    </div>

    <div class="min-h-[300px]">
      <div id="loadingSkeleton" class="grid grid-cols-3 gap-0.5">
        <div class="aspect-[3/4] bg-gray-200 animate-pulse"></div>
        <div class="aspect-[3/4] bg-gray-200 animate-pulse"></div>
        <div class="aspect-[3/4] bg-gray-200 animate-pulse"></div>
      </div>

      <div id="emptyState" class="hidden flex flex-col items-center justify-center py-12 text-gray-500">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16 mb-2 text-gray-300">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.774 48.774 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z" />
          <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zM18.75 10.5h.008v.008h-.008V10.5z" />
        </svg>
        <p class="text-sm">Chưa có video nào</p>
        <a href="upload.html" class="mt-4 text-blue-500 font-semibold text-sm hover:underline">Quay video đầu tiên</a>
      </div>
      
      <div id="myPosts" class="grid grid-cols-3 gap-0.5"></div>
    </div>
  </main>

  <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 flex justify-around items-center py-3 pb-5 z-40 safe-area-pb">
    <a href="feed.html" class="flex flex-col items-center text-gray-400 hover:text-black transition group">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-7 h-7 group-hover:scale-105 transition">
        <path d="M11.47 3.84a.75.75 0 011.06 0l8.69 8.69a.75.75 0 101.06-1.06l-8.689-8.69a2.25 2.25 0 00-3.182 0l-8.69 8.69a.75.75 0 001.061 1.06l8.69-8.69z" />
        <path d="M12 5.432l8.159 8.159c.03.03.06.058.091.086v6.198c0 1.035-.84 1.875-1.875 1.875H15a.75.75 0 01-.75-.75v-4.5a.75.75 0 00-.75-.75h-3a.75.75 0 00-.75.75V21a.75.75 0 01-.75.75H5.625a1.875 1.875 0 01-1.875-1.875v-6.198a2.29 2.29 0 00.091-.086L12 5.43z" />
      </svg>
      <span class="text-[10px] font-medium mt-1">Trang chủ</span>
    </a>
    
    <a href="upload.html" class="flex flex-col items-center group">
      <div class="relative w-12 h-8">
        <div class="absolute left-0 top-0 bottom-0 w-8 bg-cyan-400 rounded-lg transform -translate-x-1"></div>
        <div class="absolute right-0 top-0 bottom-0 w-8 bg-red-500 rounded-lg transform translate-x-1"></div>
        <div class="absolute left-0 right-0 top-0 bottom-0 bg-white rounded-lg flex items-center justify-center border-x-2 border-black">
            <span class="text-black font-bold text-xl leading-none mb-0.5">+</span>
        </div>
      </div>
    </a>

    <a href="chat.html" class="flex flex-col items-center text-gray-400 hover:text-black transition group">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-7 h-7 group-hover:scale-105 transition">
            <path fill-rule="evenodd" d="M4.804 21.644A6.707 6.707 0 006 21.75a6.721 6.721 0 003.583-1.029c.774.182 1.584.279 2.417.279 5.322 0 9.75-3.97 9.75-9 0-5.03-4.428-9-9.75-9s-9.75 3.97-9.75 9c0 2.409 1.025 4.587 2.674 6.192.232.226.277.428.254.543a3.73 3.73 0 01-.814 1.686.75.75 0 00.44 1.223zM8.25 10.875a1.125 1.125 0 100 2.25 1.125 1.125 0 000-2.25zM10.875 12a1.125 1.125 0 112.25 0 1.125 1.125 0 01-2.25 0zm4.875-1.125a1.125 1.125 0 100 2.25 1.125 1.125 0 000-2.25z" clip-rule="evenodd" />
          </svg>
      <span class="text-[10px] font-medium mt-1">Hộp thư</span>
    </a>

    <a href="account.html" class="flex flex-col items-center text-black transition">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-7 h-7">
        <path fill-rule="evenodd" d="M7.5 6a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM3.751 20.105a8.25 8.25 0 0116.498 0 .75.75 0 01-.437.695A18.683 18.683 0 0112 22.5c-2.786 0-5.433-.608-7.812-1.7a.75.75 0 01-.437-.695z" clip-rule="evenodd" />
      </svg>
      <span class="text-[10px] font-medium mt-1">Hồ sơ</span>
    </a>
  </nav>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, collection, query, where, orderBy, getDocs, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAJxH_3ZkN7wQnXVelRzm0mezBCBcxKoJM",
      authDomain: "loktik-1d9af.firebaseapp.com",
      projectId: "loktik-1d9af",
      storageBucket: "loktik-1d9af.appspot.com",
      messagingSenderId: "801363229819",
      appId: "1:801363229819:web:49f086bc180d9ed9c0b6de",
      measurementId: "G-S6HQ3HN7W3"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Elements
    const headerName = document.getElementById("headerName");
    const userName = document.getElementById("userName");
    const userId = document.getElementById("userId");
    const userAvatar = document.getElementById("userAvatar");
    const myPosts = document.getElementById("myPosts");
    const logoutBtn = document.getElementById("logoutBtn");
    const loadingSkeleton = document.getElementById("loadingSkeleton");
    const emptyState = document.getElementById("emptyState");

    // Logout
    logoutBtn.addEventListener("click", () => {
        if(confirm("Đăng xuất tài khoản?")) {
            signOut(auth).then(() => window.location.href = "login.html");
        }
    });

    // Auth & Load Data
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        // Update User Info UI
        const name = user.displayName || user.email.split('@')[0];
        headerName.textContent = name;
        userName.textContent = "@" + name.replace(/\s/g, '').toLowerCase();
        userId.textContent = "UID: " + user.uid.slice(0,8); // Shorten UID
        if(user.photoURL) userAvatar.src = user.photoURL;

        await loadUserPosts(user.uid);
      } else {
        window.location.href = "login.html";
      }
    });

    async function loadUserPosts(uid) {
      try {
        // Query Firebase
        const q = query(
          collection(db, "posts"), 
          where("uid", "==", uid)
          // orderBy("timestamp", "desc") // Bỏ comment dòng này nếu đã tạo Index
        );
        
        const querySnapshot = await getDocs(q);

        // Hide Loading, Show Content
        loadingSkeleton.style.display = "none";
        myPosts.innerHTML = "";

        if (querySnapshot.empty) {
          emptyState.classList.remove("hidden");
          return;
        }

        querySnapshot.forEach((docSnap) => {
          const post = docSnap.data();
          const postDiv = document.createElement("div");
          // Tỉ lệ 3:4 cho giống video
          postDiv.className = "relative bg-black aspect-[3/4] overflow-hidden cursor-pointer group";

          let mediaElement;
          const isVideo = post.url && post.url.includes(".mp4");

          if (isVideo) {
            mediaElement = document.createElement("video");
            mediaElement.src = post.url;
            mediaElement.className = "w-full h-full object-cover";
            mediaElement.muted = true;
            // Icon Play ở góc để biết là video
            const playIcon = document.createElement("div");
            playIcon.innerHTML = '<svg class="w-4 h-4 text-white drop-shadow-md" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>';
            playIcon.className = "absolute top-2 right-2 z-10 opacity-80";
            postDiv.appendChild(playIcon);
          } else {
            mediaElement = document.createElement("img");
            mediaElement.src = post.url || "https://via.placeholder.com/150";
            mediaElement.className = "w-full h-full object-cover";
          }

          // Số view giả lập
          const views = document.createElement("div");
          views.className = "absolute bottom-2 left-2 text-white text-xs font-bold flex items-center drop-shadow-md z-10";
          views.innerHTML = `
            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            ${Math.floor(Math.random() * 5000)}
          `;

          // Delete Button (Long press simulation on mobile via a click for now)
          postDiv.addEventListener('click', async () => {
              if(confirm("Xoá bài viết này?")) {
                  await deleteDoc(doc(db, "posts", docSnap.id));
                  postDiv.remove();
                  if(myPosts.children.length === 0) emptyState.classList.remove("hidden");
              }
          });

          postDiv.appendChild(mediaElement);
          postDiv.appendChild(views);
          myPosts.appendChild(postDiv);
        });

      } catch (error) {
        console.error("Lỗi:", error);
        loadingSkeleton.textContent = "Lỗi tải.";
      }
    }
  </script>
</body>
</html>
