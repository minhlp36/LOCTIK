<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ÄÄƒng nháº­p - LokTik</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .logo-text {
        background: linear-gradient(to right, #06b6d4, #ef4444);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
  </style>
</head>
<body class="bg-gray-50 flex items-center justify-center min-h-screen px-4">

  <div id="loadingScreen" class="fixed inset-0 bg-white z-50 flex items-center justify-center hidden">
      <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-slate-900"></div>
  </div>

  <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm border border-gray-100">
    
    <div class="text-center mb-6">
        <h1 class="text-4xl font-black logo-text tracking-tighter mb-1">LokTik</h1>
        <p class="text-gray-400 text-sm font-medium">Máº¡ng xÃ£ há»™i video ngáº¯n</p>
    </div>

    <h2 id="form-title" class="text-xl font-bold mb-6 text-center text-slate-800">ChÃ o má»«ng trá»Ÿ láº¡i! ğŸ‘‹</h2>

    <button id="googleBtn" class="w-full flex items-center justify-center gap-3 bg-white border border-gray-300 hover:bg-gray-50 text-slate-700 font-bold py-3 rounded-xl transition shadow-sm mb-6">
        <svg class="w-5 h-5" viewBox="0 0 24 24">
            <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
            <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
            <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.84z" fill="#FBBC05"/>
            <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
        </svg>
        Tiáº¿p tá»¥c vá»›i Google
    </button>

    <div class="relative flex py-2 items-center mb-6">
        <div class="flex-grow border-t border-gray-200"></div>
        <span class="flex-shrink-0 mx-4 text-gray-400 text-xs font-semibold uppercase">Hoáº·c báº±ng Email</span>
        <div class="flex-grow border-t border-gray-200"></div>
    </div>

    <form id="login-form" class="space-y-4">
      <div>
          <input type="email" id="login-email" placeholder="Email cá»§a báº¡n" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-cyan-400 transition" required />
      </div>
      <div>
          <input type="password" id="login-password" placeholder="Máº­t kháº©u" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-cyan-400 transition" required />
      </div>
      <button type="submit" id="btnLogin" class="w-full bg-slate-900 text-white font-bold py-3 rounded-xl hover:bg-slate-800 transition shadow-lg shadow-slate-200">
        ÄÄƒng nháº­p
      </button>
    </form>

    <form id="register-form" class="space-y-4 hidden">
      <div>
          <input type="text" id="register-name" placeholder="TÃªn hiá»ƒn thá»‹" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-red-400 transition" required />
      </div>
      <div>
          <input type="email" id="register-email" placeholder="Email" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-red-400 transition" required />
      </div>
      <div>
          <input type="password" id="register-password" placeholder="Máº­t kháº©u" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-red-400 transition" required />
      </div>
      <button type="submit" id="btnRegister" class="w-full bg-gradient-to-r from-pink-500 to-red-500 text-white font-bold py-3 rounded-xl hover:opacity-90 transition shadow-lg shadow-red-200">
        ÄÄƒng kÃ½ & VÃ o ngay
      </button>
    </form>

    <div id="message" class="hidden mt-4 p-3 bg-red-50 text-red-500 text-sm rounded-lg text-center font-medium border border-red-100"></div>

    <div class="text-center mt-6 pt-6 border-t border-gray-100">
      <p class="text-sm text-gray-500">
        <span id="toggle-text">ChÆ°a cÃ³ tÃ i khoáº£n?</span>
        <button id="toggle-form" class="text-blue-600 font-bold hover:underline ml-1">Táº¡o má»›i ngay</button>
      </p>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAJxH_3ZkN7wQnXVelRzm0mezBCBcxKoJM",
      authDomain: "loktik-1d9af.firebaseapp.com",
      projectId: "loktik-1d9af",
      storageBucket: "loktik-1d9af.appspot.com",
      messagingSenderId: "801363229819",
      appId: "1:801363229819:web:49f086bc180d9ed9c0b6de"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // DOM Elements
    const loginForm = document.getElementById("login-form");
    const registerForm = document.getElementById("register-form");
    const toggleBtn = document.getElementById("toggle-form");
    const toggleText = document.getElementById("toggle-text");
    const messageDiv = document.getElementById("message");
    const title = document.getElementById("form-title");
    const btnLogin = document.getElementById("btnLogin");
    const btnRegister = document.getElementById("btnRegister");
    const googleBtn = document.getElementById("googleBtn");
    const loadingScreen = document.getElementById("loadingScreen");

    // Kiá»ƒm tra tráº¡ng thÃ¡i Ä‘Äƒng nháº­p (Náº¿u Ä‘Ã£ Ä‘Äƒng nháº­p thÃ¬ vÃ o luÃ´n)
    // Cá» isRegistering Ä‘á»ƒ trÃ¡nh redirect khi Ä‘ang trong quÃ¡ trÃ¬nh Ä‘Äƒng kÃ½
    let isRegistering = false;
    onAuthStateChanged(auth, (user) => {
        if (user && !isRegistering) {
            // Náº¿u Ä‘Ã£ cÃ³ user vÃ  khÃ´ng pháº£i Ä‘ang báº¥m nÃºt Ä‘Äƒng kÃ½ -> Chuyá»ƒn trang
            window.location.href = "feed.html";
        }
    });

    // Toggle Forms
    toggleBtn.addEventListener("click", () => {
      messageDiv.classList.add("hidden");
      if (loginForm.classList.contains("hidden")) {
        loginForm.classList.remove("hidden");
        registerForm.classList.add("hidden");
        title.textContent = "ChÃ o má»«ng trá»Ÿ láº¡i! ğŸ‘‹";
        toggleText.textContent = "ChÆ°a cÃ³ tÃ i khoáº£n?";
        toggleBtn.textContent = "Táº¡o má»›i ngay";
      } else {
        loginForm.classList.add("hidden");
        registerForm.classList.remove("hidden");
        title.textContent = "Tham gia LokTik ğŸš€";
        toggleText.textContent = "ÄÃ£ cÃ³ tÃ i khoáº£n?";
        toggleBtn.textContent = "ÄÄƒng nháº­p";
      }
    });

    function showError(msg) {
        messageDiv.textContent = msg;
        messageDiv.classList.remove("hidden");
    }

    // --- GOOGLE LOGIN ---
    googleBtn.addEventListener("click", async () => {
        const provider = new GoogleAuthProvider();
        googleBtn.disabled = true;
        googleBtn.innerHTML = "Äang káº¿t ná»‘i...";
        
        try {
            const result = await signInWithPopup(auth, provider);
            const user = result.user;
            
            // Kiá»ƒm tra vÃ  táº¡o user trong DB náº¿u chÆ°a cÃ³
            const userDocRef = doc(db, "users", user.uid);
            const userDocSnap = await getDoc(userDocRef);

            if (!userDocSnap.exists()) {
                const lowerName = (user.displayName || "").toLowerCase();
                const lowerEmail = (user.email || "").toLowerCase();
                await setDoc(userDocRef, {
                    uid: user.uid,
                    email: user.email,
                    displayName: user.displayName,
                    photoURL: user.photoURL,
                    createdAt: serverTimestamp(),
                    bio: "Xin chÃ o, tÃ´i dÃ¹ng Google Login! ğŸŒ",
                    lowercaseName: lowerName,
                    lowercaseEmail: lowerEmail
                });
            }
            window.location.href = "feed.html";
        } catch (error) {
            console.error(error);
            showError("Lá»—i Google: " + error.message);
            googleBtn.disabled = false;
            googleBtn.innerHTML = "Tiáº¿p tá»¥c vá»›i Google";
        }
    });

    // --- EMAIL LOGIN ---
    loginForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const email = document.getElementById("login-email").value;
      const password = document.getElementById("login-password").value;

      btnLogin.disabled = true;
      btnLogin.textContent = "Äang xá»­ lÃ½...";
      messageDiv.classList.add("hidden");

      signInWithEmailAndPassword(auth, email, password)
        .then(() => {
          window.location.href = "feed.html";
        })
        .catch((error) => {
          btnLogin.disabled = false;
          btnLogin.textContent = "ÄÄƒng nháº­p";
          let msg = "Lá»—i Ä‘Äƒng nháº­p.";
          if(error.code === 'auth/invalid-credential') msg = "Sai email hoáº·c máº­t kháº©u.";
          showError(msg);
        });
    });

    // --- EMAIL REGISTER (FIXED) ---
    registerForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      isRegistering = true; // ÄÃ¡nh dáº¥u Ä‘ang Ä‘Äƒng kÃ½ Ä‘á»ƒ onAuthStateChanged khÃ´ng cháº¡y Ä‘Ã¨

      const name = document.getElementById("register-name").value;
      const email = document.getElementById("register-email").value;
      const password = document.getElementById("register-password").value;

      btnRegister.disabled = true;
      btnRegister.textContent = "Äang táº¡o tÃ i khoáº£n...";
      messageDiv.classList.add("hidden");

      try {
          // 1. Táº¡o Authentication
          const userCredential = await createUserWithEmailAndPassword(auth, email, password);
          const user = userCredential.user;
          const randomAvatar = `https://api.dicebear.com/9.x/avataaars/svg?seed=${user.uid}`;
          
          // 2. Cáº­p nháº­t Profile Auth (TÃªn + áº¢nh)
          await updateProfile(user, { displayName: name, photoURL: randomAvatar });
          
          // 3. LÆ°u vÃ o Firestore (DÃ¹ng try-catch riÃªng Ä‘á»ƒ Ä‘áº£m báº£o redirect ká»ƒ cáº£ khi DB lá»—i)
          try {
              const lowerName = name.toLowerCase();
              const lowerEmail = email.toLowerCase();
              
              await setDoc(doc(db, "users", user.uid), {
                uid: user.uid,
                email: user.email,
                displayName: name,
                photoURL: randomAvatar,
                createdAt: serverTimestamp(),
                bio: "ThÃ nh viÃªn má»›i âœ¨",
                lowercaseName: lowerName,
                lowercaseEmail: lowerEmail
              });
          } catch (dbError) {
              console.error("Lá»—i lÆ°u DB:", dbError);
              // Váº«n cho qua vÃ¬ tÃ i khoáº£n Auth Ä‘Ã£ táº¡o thÃ nh cÃ´ng
          }

          // 4. Chuyá»ƒn hÆ°á»›ng
          window.location.href = "feed.html";

      } catch (error) {
          console.error(error);
          isRegistering = false; // Reset cá»
          btnRegister.disabled = false;
          btnRegister.textContent = "ÄÄƒng kÃ½ tÃ i khoáº£n";
          
          let msg = error.message;
          if(error.code === 'auth/email-already-in-use') msg = "Email nÃ y Ä‘Ã£ Ä‘Æ°á»£c sá»­ dá»¥ng.";
          if(error.code === 'auth/weak-password') msg = "Máº­t kháº©u quÃ¡ yáº¿u (tá»‘i thiá»ƒu 6 kÃ½ tá»±).";
          showError(msg);
      }
    });
  </script>
</body>
</html>
