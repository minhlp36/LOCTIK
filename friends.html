<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>B·∫°n b√® - LokTik</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>
<body class="bg-gray-50 text-slate-900 pb-20">

  <header class="sticky top-0 bg-white z-30 border-b border-gray-100 px-4 py-3 flex justify-center items-center shadow-sm">
    <h1 class="font-bold text-lg">B·∫°n b√®</h1>
  </header>

  <main class="max-w-md mx-auto p-4">
    
    <div class="flex p-1 bg-gray-200 rounded-xl mb-6">
      <button onclick="switchTab('list')" id="tab-list" class="flex-1 py-2 text-sm font-bold rounded-lg bg-white shadow text-black transition-all">Danh s√°ch</button>
      <button onclick="switchTab('requests')" id="tab-requests" class="flex-1 py-2 text-sm font-bold rounded-lg text-gray-500 hover:text-black transition-all relative">
        L·ªùi m·ªùi
        <span id="badge-req" class="hidden absolute top-1 right-2 w-2 h-2 bg-red-500 rounded-full"></span>
      </button>
      <button onclick="switchTab('search')" id="tab-search" class="flex-1 py-2 text-sm font-bold rounded-lg text-gray-500 hover:text-black transition-all">T√¨m ki·∫øm</button>
    </div>

    <div id="content-list" class="space-y-3">
        <div id="loading-friends" class="text-center text-gray-400 py-4">ƒêang t·∫£i danh s√°ch...</div>
        <div id="friend-list-container"></div>
    </div>

    <div id="content-requests" class="hidden space-y-6">
        <div>
            <h3 class="text-xs font-bold text-gray-400 uppercase mb-2">L·ªùi m·ªùi ƒë√£ nh·∫≠n</h3>
            <div id="received-list" class="space-y-3">
                <p class="text-sm text-gray-400 text-center py-2">Kh√¥ng c√≥ l·ªùi m·ªùi n√†o.</p>
            </div>
        </div>
        <div>
            <h3 class="text-xs font-bold text-gray-400 uppercase mb-2">ƒê√£ g·ª≠i ƒëi</h3>
            <div id="sent-list" class="space-y-3"></div>
        </div>
    </div>

    <div id="content-search" class="hidden space-y-4">
        <div class="relative">
            <input type="text" id="searchInput" placeholder="Nh·∫≠p email ng∆∞·ªùi d√πng..." class="w-full bg-white border border-gray-200 p-3 pl-10 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 transition">
            <svg class="w-5 h-5 text-gray-400 absolute left-3 top-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            <button onclick="handleSearch()" class="absolute right-2 top-2 bg-black text-white px-4 py-1.5 rounded-lg text-sm font-bold">T√¨m</button>
        </div>
        <div id="search-results" class="space-y-3"></div>
    </div>

  </main>

  <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 flex justify-around items-center py-3 pb-5 z-40 safe-area-pb">
    <a href="feed.html" class="flex flex-col items-center text-gray-400 hover:text-black transition group">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-7 h-7">
        <path d="M11.47 3.84a.75.75 0 011.06 0l8.69 8.69a.75.75 0 101.06-1.06l-8.689-8.69a2.25 2.25 0 00-3.182 0l-8.69 8.69a.75.75 0 001.061 1.06l8.69-8.69z" />
        <path d="M12 5.432l8.159 8.159c.03.03.06.058.091.086v6.198c0 1.035-.84 1.875-1.875 1.875H15a.75.75 0 01-.75-.75v-4.5a.75.75 0 00-.75-.75h-3a.75.75 0 00-.75.75V21a.75.75 0 01-.75.75H5.625a1.875 1.875 0 01-1.875-1.875v-6.198a2.29 2.29 0 00.091-.086L12 5.43z" />
      </svg>
      <span class="text-[10px] font-medium mt-1">Trang ch·ªß</span>
    </a>
    
    <a href="upload.html" class="flex flex-col items-center group">
      <div class="relative w-12 h-8">
        <div class="absolute left-0 top-0 bottom-0 w-8 bg-cyan-400 rounded-lg transform -translate-x-1"></div>
        <div class="absolute right-0 top-0 bottom-0 w-8 bg-red-500 rounded-lg transform translate-x-1"></div>
        <div class="absolute left-0 right-0 top-0 bottom-0 bg-white rounded-lg flex items-center justify-center border-x-2 border-black">
            <span class="text-black font-bold text-xl leading-none mb-0.5">+</span>
        </div>
      </div>
    </a>

    <a href="friends.html" class="flex flex-col items-center text-black transition group">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-7 h-7">
            <path fill-rule="evenodd" d="M8.25 6.75a3.75 3.75 0 117.5 0 3.75 3.75 0 01-7.5 0zM15.75 9.75a3 3 0 116 0 3 3 0 01-6 0zM2.25 9.75a3 3 0 116 0 3 3 0 01-6 0zM6.31 15.117A6.745 6.745 0 0112 12a6.745 6.745 0 016.709 7.498.75.75 0 01-.372.568A12.696 12.696 0 0112 21.75c-2.305 0-4.47-.612-6.337-1.684a.75.75 0 01-.372-.568 6.787 6.787 0 011.019-4.38z" clip-rule="evenodd" />
            <path d="M5.082 14.254a8.287 8.287 0 00-1.308 5.135 9.687 9.687 0 01-1.764-.44l-.115-.04a.563.563 0 01-.373-.487l-.01-.121a3.75 3.75 0 013.57-4.047zM20.226 19.389a8.287 8.287 0 00-1.308-5.135 3.75 3.75 0 013.57 4.047l-.01.121a.563.563 0 01-.373.486l-.115.04c-.567.2-1.156.349-1.764.441z" />
          </svg>          
        <span class="text-[10px] font-medium mt-1">B·∫°n b√®</span>
      </a>

    <a href="account.html" class="flex flex-col items-center text-gray-400 hover:text-black transition">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-7 h-7">
        <path fill-rule="evenodd" d="M7.5 6a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM3.751 20.105a8.25 8.25 0 0116.498 0 .75.75 0 01-.437.695A18.683 18.683 0 0112 22.5c-2.786 0-5.433-.608-7.812-1.7a.75.75 0 01-.437-.695z" clip-rule="evenodd" />
      </svg>
      <span class="text-[10px] font-medium mt-1">H·ªì s∆°</span>
    </a>
  </nav>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, collection, query, where, getDocs, addDoc, updateDoc, deleteDoc, doc, getDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAJxH_3ZkN7wQnXVelRzm0mezBCBcxKoJM",
      authDomain: "loktik-1d9af.firebaseapp.com",
      projectId: "loktik-1d9af",
      storageBucket: "loktik-1d9af.appspot.com",
      messagingSenderId: "801363229819",
      appId: "1:801363229819:web:49f086bc180d9ed9c0b6de"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;

    // --- Tab Switching Logic ---
    window.switchTab = (tabName) => {
        ['list', 'requests', 'search'].forEach(t => {
            document.getElementById(`content-${t}`).classList.add('hidden');
            const btn = document.getElementById(`tab-${t}`);
            btn.className = "flex-1 py-2 text-sm font-bold rounded-lg text-gray-500 hover:text-black transition-all";
        });
        document.getElementById(`content-${tabName}`).classList.remove('hidden');
        document.getElementById(`tab-${tabName}`).className = "flex-1 py-2 text-sm font-bold rounded-lg bg-white shadow text-black transition-all";
    };

    onAuthStateChanged(auth, user => {
      if (!user) return window.location.href = "login.html";
      currentUser = user;
      
      listenFriends();
      listenRequests();
      listenSentRequests();
    });

    // 1. L·∫Øng nghe danh s√°ch b·∫°n b√® (status == 'accepted')
    function listenFriends() {
        const q = query(
            collection(db, "friendRequests"),
            where("status", "==", "accepted"),
            where("users", "array-contains", currentUser.uid)
        );

        onSnapshot(q, async (snapshot) => {
            const container = document.getElementById("friend-list-container");
            document.getElementById("loading-friends").style.display = "none";
            container.innerHTML = "";

            if(snapshot.empty) {
                container.innerHTML = `<div class="text-center text-gray-400 py-10">
                    <p class="text-4xl mb-2">ü§∑‚Äç‚ôÇÔ∏è</p>Ch∆∞a c√≥ b·∫°n b√®.
                </div>`;
                return;
            }

            for (const docSnap of snapshot.docs) {
                const data = docSnap.data();
                const otherUid = data.users.find(uid => uid !== currentUser.uid);
                
                // Fetch info
                const userSnap = await getDoc(doc(db, "users", otherUid));
                const user = userSnap.data() || { email: "Ng∆∞·ªùi d√πng ·∫©n" };
                const avatar = user.photoURL || `https://api.dicebear.com/9.x/avataaars/svg?seed=${otherUid}`;
                const name = user.displayName || user.email.split('@')[0];

                const div = document.createElement("div");
                div.className = "flex items-center justify-between bg-white p-3 rounded-xl shadow-sm border border-gray-100";
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <img src="${avatar}" class="w-12 h-12 rounded-full bg-gray-100 border">
                        <div>
                            <p class="font-bold text-sm">${name}</p>
                            <a href="chat-room.html?id=${docSnap.id}&friendName=${encodeURIComponent(name)}" class="text-xs text-blue-500 font-semibold hover:underline">Nh·∫Øn tin</a>
                        </div>
                    </div>
                    <button onclick="unfriend('${docSnap.id}')" class="text-gray-400 hover:text-red-500 p-2">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M22 10.5h-6m-2.25-4.125a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zM3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" /></svg>
                    </button>
                `;
                container.appendChild(div);
            }
        });
    }

    // 2. L·∫Øng nghe l·ªùi m·ªùi ƒë·∫øn (status == 'pending' && to == me)
    function listenRequests() {
        const q = query(
            collection(db, "friendRequests"),
            where("status", "==", "pending"),
            where("to", "==", currentUser.uid)
        );

        onSnapshot(q, async (snapshot) => {
            const container = document.getElementById("received-list");
            const badge = document.getElementById("badge-req");
            
            container.innerHTML = "";
            
            if(snapshot.empty) {
                container.innerHTML = `<p class="text-sm text-gray-400 text-center py-2">Kh√¥ng c√≥ l·ªùi m·ªùi n√†o.</p>`;
                badge.classList.add("hidden");
                return;
            }
            
            badge.classList.remove("hidden");

            for(const docSnap of snapshot.docs) {
                const data = docSnap.data();
                const userSnap = await getDoc(doc(db, "users", data.from));
                const user = userSnap.data() || { email: "..." };
                const avatar = user.photoURL || `https://api.dicebear.com/9.x/avataaars/svg?seed=${data.from}`;

                const div = document.createElement("div");
                div.className = "flex items-center justify-between bg-white p-3 rounded-xl shadow-sm";
                div.innerHTML = `
                   <div class="flex items-center gap-3">
                        <img src="${avatar}" class="w-10 h-10 rounded-full">
                        <p class="font-bold text-sm">${user.displayName || "Ng∆∞·ªùi d√πng"}</p>
                   </div>
                   <div class="flex gap-2">
                        <button onclick="respond('${docSnap.id}', true)" class="bg-blue-500 text-white px-3 py-1.5 rounded-lg text-xs font-bold">Ch·∫•p nh·∫≠n</button>
                        <button onclick="respond('${docSnap.id}', false)" class="bg-gray-100 text-black px-3 py-1.5 rounded-lg text-xs font-bold">Xo√°</button>
                   </div>
                `;
                container.appendChild(div);
            }
        });
    }

    // 3. L·∫Øng nghe l·ªùi m·ªùi ƒë√£ g·ª≠i (status == 'pending' && from == me)
    function listenSentRequests() {
        const q = query(
            collection(db, "friendRequests"),
            where("status", "==", "pending"),
            where("from", "==", currentUser.uid)
        );

        onSnapshot(q, async (snapshot) => {
            const container = document.getElementById("sent-list");
            container.innerHTML = "";
            
            if(snapshot.empty) return;

            for(const docSnap of snapshot.docs) {
                const data = docSnap.data();
                const userSnap = await getDoc(doc(db, "users", data.to));
                const user = userSnap.data() || { email: "..." };

                const div = document.createElement("div");
                div.className = "flex items-center justify-between p-2 border-b border-gray-100";
                div.innerHTML = `
                    <span class="text-sm font-medium text-gray-600">G·ª≠i t·ªõi: ${user.displayName || user.email}</span>
                    <button onclick="cancelReq('${docSnap.id}')" class="text-xs text-red-500 font-bold border border-red-200 px-2 py-1 rounded">Hu·ª∑</button>
                `;
                container.appendChild(div);
            }
        });
    }

    // 4. T√¨m ki·∫øm ng∆∞·ªùi d√πng (ƒë·ªÉ k·∫øt b·∫°n)
    window.handleSearch = async () => {
        const keyword = document.getElementById("searchInput").value.trim();
        const container = document.getElementById("search-results");
        
        if(!keyword) return;
        container.innerHTML = `<p class="text-center text-gray-400">ƒêang t√¨m...</p>`;

        // T√¨m theo email (ch√≠nh x√°c)
        const q = query(collection(db, "users"), where("email", "==", keyword));
        const querySnap = await getDocs(q);

        container.innerHTML = "";
        
        if(querySnap.empty) {
            container.innerHTML = `<p class="text-center text-red-400">Kh√¥ng t√¨m th·∫•y email n√†y.</p>`;
            return;
        }

        querySnap.forEach(docSnap => {
            const user = docSnap.data();
            if(docSnap.id === currentUser.uid) {
                container.innerHTML = `<p class="text-center text-gray-500">ƒê√¢y l√† b·∫°n.</p>`;
                return;
            }

            const avatar = user.photoURL || `https://api.dicebear.com/9.x/avataaars/svg?seed=${docSnap.id}`;
            
            const div = document.createElement("div");
            div.className = "flex items-center justify-between bg-white p-3 rounded-xl shadow-sm";
            div.innerHTML = `
                <div class="flex items-center gap-3">
                    <img src="${avatar}" class="w-10 h-10 rounded-full">
                    <div>
                        <p class="font-bold text-sm">${user.displayName || "User"}</p>
                        <p class="text-xs text-gray-400">${user.email}</p>
                    </div>
                </div>
                <button onclick="sendFriendRequest('${docSnap.id}')" class="bg-black text-white px-4 py-1.5 rounded-lg text-xs font-bold">K·∫øt b·∫°n</button>
            `;
            container.appendChild(div);
        });
    }

    // --- Actions --- //

    window.sendFriendRequest = async (toUid) => {
        // Ki·ªÉm tra xem ƒë√£ g·ª≠i ch∆∞a ho·∫∑c ƒë√£ l√† b·∫°n ch∆∞a
        const q = query(collection(db, "friendRequests"), where("users", "array-contains", currentUser.uid));
        const checkSnap = await getDocs(q);
        
        let exists = false;
        checkSnap.forEach(doc => {
            const d = doc.data();
            if(d.users.includes(toUid)) exists = true; // ƒê√£ c√≥ quan h·ªá (pending ho·∫∑c accepted)
        });

        if(exists) {
            alert("ƒê√£ g·ª≠i l·ªùi m·ªùi ho·∫∑c ƒë√£ l√† b·∫°n b√®!");
            return;
        }

        await addDoc(collection(db, "friendRequests"), {
            from: currentUser.uid,
            to: toUid,
            status: "pending",
            users: [currentUser.uid, toUid],
            createdAt: serverTimestamp()
        });
        alert("ƒê√£ g·ª≠i l·ªùi m·ªùi!");
        switchTab('requests');
    };

    window.respond = async (docId, accept) => {
        if(accept) {
            await updateDoc(doc(db, "friendRequests", docId), { status: "accepted" });
            switchTab('list');
        } else {
            await deleteDoc(doc(db, "friendRequests", docId));
        }
    };

    window.cancelReq = async (docId) => {
        if(confirm("Hu·ª∑ l·ªùi m·ªùi n√†y?")) {
            await deleteDoc(doc(db, "friendRequests", docId));
        }
    };

    window.unfriend = async (docId) => {
        if(confirm("Hu·ª∑ k·∫øt b·∫°n v·ªõi ng∆∞·ªùi n√†y?")) {
            await deleteDoc(doc(db, "friendRequests", docId));
        }
    };
  </script>
</body>
</html>
