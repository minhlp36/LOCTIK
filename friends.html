<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>B·∫°n b√® - LokTik</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .safe-area-pb { padding-bottom: env(safe-area-inset-bottom, 20px); }
  </style>
</head>
<body class="bg-gray-50 text-slate-900 pb-24">

  <header class="sticky top-0 bg-white z-30 border-b border-gray-100 px-4 py-3 flex justify-center items-center shadow-sm">
    <h1 class="font-bold text-lg">B·∫°n b√®</h1>
  </header>

  <main class="max-w-md mx-auto p-4">
    
    <div class="flex p-1 bg-gray-200 rounded-xl mb-6">
      <button onclick="switchTab('list')" id="tab-list" class="flex-1 py-2 text-sm font-bold rounded-lg bg-white shadow text-black transition-all">Danh s√°ch</button>
      <button onclick="switchTab('requests')" id="tab-requests" class="flex-1 py-2 text-sm font-bold rounded-lg text-gray-500 hover:text-black transition-all relative">
        L·ªùi m·ªùi
        <span id="badge-req" class="hidden absolute top-1 right-2 w-2 h-2 bg-red-500 rounded-full"></span>
      </button>
      <button onclick="switchTab('search')" id="tab-search" class="flex-1 py-2 text-sm font-bold rounded-lg text-gray-500 hover:text-black transition-all">T√¨m ki·∫øm</button>
    </div>

    <div id="content-list" class="space-y-3">
        <div id="loading-friends" class="text-center text-gray-400 py-4">ƒêang t·∫£i danh s√°ch...</div>
        <div id="friend-list-container"></div>
    </div>

    <div id="content-requests" class="hidden space-y-6">
        <div>
            <h3 class="text-xs font-bold text-gray-400 uppercase mb-2">L·ªùi m·ªùi ƒë√£ nh·∫≠n</h3>
            <div id="received-list" class="space-y-3">
                <p class="text-sm text-gray-400 text-center py-2">Kh√¥ng c√≥ l·ªùi m·ªùi n√†o.</p>
            </div>
        </div>
        <hr class="border-gray-200">
        <div>
            <h3 class="text-xs font-bold text-gray-400 uppercase mb-2">ƒê√£ g·ª≠i ƒëi (Ch·ªù ph·∫£n h·ªìi)</h3>
            <div id="sent-list" class="space-y-3"></div>
        </div>
    </div>

    <div id="content-search" class="hidden space-y-4">
        <div class="relative">
            <input type="text" id="searchInput" placeholder="Nh·∫≠p email ho·∫∑c t√™n ch√≠nh x√°c..." class="w-full bg-white border border-gray-200 p-3 pl-10 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 transition">
            <svg class="w-5 h-5 text-gray-400 absolute left-3 top-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            <button onclick="handleSearch()" class="absolute right-2 top-2 bg-black text-white px-4 py-1.5 rounded-lg text-sm font-bold">T√¨m</button>
        </div>
        <div id="search-error" class="hidden text-center text-red-500 text-sm"></div>
        <div id="search-results" class="space-y-3"></div>
    </div>

  </main>

  <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 flex justify-around items-center py-3 pb-5 z-40 safe-area-pb px-2">
    
    <a href="feed.html" class="flex flex-col items-center text-gray-400 hover:text-black transition group w-1/5">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
        <path d="M11.47 3.84a.75.75 0 011.06 0l8.69 8.69a.75.75 0 101.06-1.06l-8.689-8.69a2.25 2.25 0 00-3.182 0l-8.69 8.69a.75.75 0 001.061 1.06l8.69-8.69z" />
        <path d="M12 5.432l8.159 8.159c.03.03.06.058.091.086v6.198c0 1.035-.84 1.875-1.875 1.875H15a.75.75 0 01-.75-.75v-4.5a.75.75 0 00-.75-.75h-3a.75.75 0 00-.75.75V21a.75.75 0 01-.75.75H5.625a1.875 1.875 0 01-1.875-1.875v-6.198a2.29 2.29 0 00.091-.086L12 5.43z" />
      </svg>
      <span class="text-[10px] font-medium mt-1">Trang ch·ªß</span>
    </a>
    
    <a href="friends.html" class="flex flex-col items-center text-black transition group w-1/5">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
            <path fill-rule="evenodd" d="M8.25 6.75a3.75 3.75 0 117.5 0 3.75 3.75 0 01-7.5 0zM15.75 9.75a3 3 0 116 0 3 3 0 01-6 0zM2.25 9.75a3 3 0 116 0 3 3 0 01-6 0zM6.31 15.117A6.745 6.745 0 0112 12a6.745 6.745 0 016.709 7.498.75.75 0 01-.372.568A12.696 12.696 0 0112 21.75c-2.305 0-4.47-.612-6.337-1.684a.75.75 0 01-.372-.568 6.787 6.787 0 011.019-4.38z" clip-rule="evenodd" />
            <path d="M5.082 14.254a8.287 8.287 0 00-1.308 5.135 9.687 9.687 0 01-1.764-.44l-.115-.04a.563.563 0 01-.373-.487l-.01-.121a3.75 3.75 0 013.57-4.047zM20.226 19.389a8.287 8.287 0 00-1.308-5.135 3.75 3.75 0 013.57 4.047l-.01.121a.563.563 0 01-.373.486l-.115.04c-.567.2-1.156.349-1.764.441z" />
        </svg>          
        <span class="text-[10px] font-medium mt-1">B·∫°n b√®</span>
    </a>

    <a href="upload.html" class="flex flex-col items-center group w-1/5">
        <div class="relative w-12 h-8">
          <div class="absolute left-0 top-0 bottom-0 w-8 bg-cyan-400 rounded-lg transform -translate-x-1"></div>
          <div class="absolute right-0 top-0 bottom-0 w-8 bg-red-500 rounded-lg transform translate-x-1"></div>
          <div class="absolute left-0 right-0 top-0 bottom-0 bg-white rounded-lg flex items-center justify-center border-x-2 border-black">
              <span class="text-black font-bold text-xl leading-none mb-0.5">+</span>
          </div>
        </div>
    </a>

    <a href="messages.html" class="flex flex-col items-center text-gray-400 hover:text-black transition w-1/5">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
            <path fill-rule="evenodd" d="M4.848 2.771A49.144 49.144 0 0112 2.25c2.405 0 4.781.173 7.152.521C20.868 3.068 22 4.47 22 6.084v5.832c0 1.613-1.133 3.016-2.848 3.313A49.128 49.128 0 0112 15.75c-2.405 0-4.781-.173-7.152-.521C3.133 14.932 2 13.529 2 11.916V6.084c0-1.614 1.132-3.016 2.848-3.313zM3 18.364V18.75A3.375 3.375 0 006.375 22.125h11.25A3.375 3.375 0 0021 18.75v-.386c-2.9.758-5.9.986-9 .986s-6.1-.228-9-.986z" clip-rule="evenodd" />
            <path fill-rule="evenodd" d="M12 10.875a.375.375 0 00.375-.375v-1.5a.375.375 0 00-.75 0v1.5a.375.375 0 00.375.375z" clip-rule="evenodd" />
            <path fill-rule="evenodd" d="M12 7.125a.75.75 0 100-1.5.75.75 0 000 1.5z" clip-rule="evenodd" />
        </svg>
        <span class="text-[10px] font-medium mt-1">H·ªôp th∆∞</span>
    </a>

    <a href="account.html" class="flex flex-col items-center text-gray-400 hover:text-black transition w-1/5">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
        <path fill-rule="evenodd" d="M7.5 6a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM3.751 20.105a8.25 8.25 0 0116.498 0 .75.75 0 01-.437.695A18.683 18.683 0 0112 22.5c-2.786 0-5.433-.608-7.812-1.7a.75.75 0 01-.437-.695z" clip-rule="evenodd" />
      </svg>
      <span class="text-[10px] font-medium mt-1">H·ªì s∆°</span>
    </a>
  </nav>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, collection, query, where, getDocs, addDoc, updateDoc, deleteDoc, doc, getDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAJxH_3ZkN7wQnXVelRzm0mezBCBcxKoJM",
      authDomain: "loktik-1d9af.firebaseapp.com",
      projectId: "loktik-1d9af",
      storageBucket: "loktik-1d9af.appspot.com",
      messagingSenderId: "801363229819",
      appId: "1:801363229819:web:49f086bc180d9ed9c0b6de"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;

    window.switchTab = (tabName) => {
        ['list', 'requests', 'search'].forEach(t => {
            document.getElementById(`content-${t}`).classList.add('hidden');
            const btn = document.getElementById(`tab-${t}`);
            btn.className = "flex-1 py-2 text-sm font-bold rounded-lg text-gray-500 hover:text-black transition-all";
        });
        document.getElementById(`content-${tabName}`).classList.remove('hidden');
        document.getElementById(`tab-${tabName}`).className = "flex-1 py-2 text-sm font-bold rounded-lg bg-white shadow text-black transition-all";
    };

    onAuthStateChanged(auth, user => {
      if (!user) return window.location.href = "login.html";
      currentUser = user;
      
      listenFriends();
      listenRequests();
      listenSentRequests();
    });

    function listenFriends() {
        const q = query(
            collection(db, "friendRequests"),
            where("status", "==", "accepted"),
            where("users", "array-contains", currentUser.uid)
        );

        onSnapshot(q, async (snapshot) => {
            const container = document.getElementById("friend-list-container");
            document.getElementById("loading-friends").style.display = "none";
            container.innerHTML = "";

            if(snapshot.empty) {
                container.innerHTML = `<div class="text-center text-gray-400 py-10"><p class="text-4xl mb-2">ü§∑‚Äç‚ôÇÔ∏è</p>Ch∆∞a c√≥ b·∫°n b√®.</div>`;
                return;
            }

            for (const docSnap of snapshot.docs) {
                const data = docSnap.data();
                const otherUid = data.users.find(uid => uid !== currentUser.uid);
                const userSnap = await getDoc(doc(db, "users", otherUid));
                const user = userSnap.data() || { email: "Ng∆∞·ªùi d√πng ·∫©n" };
                const avatar = user.photoURL || `https://api.dicebear.com/9.x/avataaars/svg?seed=${otherUid}`;
                const name = user.displayName || user.email.split('@')[0];

                const div = document.createElement("div");
                div.className = "flex items-center justify-between bg-white p-3 rounded-xl shadow-sm border border-gray-100";
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <img src="${avatar}" class="w-12 h-12 rounded-full bg-gray-100 border">
                        <div>
                            <p class="font-bold text-sm">${name}</p>
                            <a href="chat-room.html?id=${docSnap.id}&friendName=${encodeURIComponent(name)}" class="text-xs text-blue-500 font-semibold hover:underline">Nh·∫Øn tin</a>
                        </div>
                    </div>
                    <button onclick="unfriend('${docSnap.id}')" class="text-gray-400 hover:text-red-500 p-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                `;
                container.appendChild(div);
            }
        });
    }

    function listenRequests() {
        const q = query(
            collection(db, "friendRequests"),
            where("status", "==", "pending"),
            where("to", "==", currentUser.uid)
        );

        onSnapshot(q, async (snapshot) => {
            const container = document.getElementById("received-list");
            const badge = document.getElementById("badge-req");
            container.innerHTML = "";
            
            if(snapshot.empty) {
                container.innerHTML = `<p class="text-sm text-gray-400 text-center py-2">Kh√¥ng c√≥ l·ªùi m·ªùi n√†o.</p>`;
                badge.classList.add("hidden");
                return;
            }
            
            badge.classList.remove("hidden");
            for(const docSnap of snapshot.docs) {
                const data = docSnap.data();
                const userSnap = await getDoc(doc(db, "users", data.from));
                const user = userSnap.data() || { email: "..." };
                const avatar = user.photoURL || `https://api.dicebear.com/9.x/avataaars/svg?seed=${data.from}`;

                const div = document.createElement("div");
                div.className = "flex items-center justify-between bg-white p-3 rounded-xl shadow-sm";
                div.innerHTML = `
                   <div class="flex items-center gap-3">
                        <img src="${avatar}" class="w-10 h-10 rounded-full">
                        <p class="font-bold text-sm">${user.displayName || "User"}</p>
                   </div>
                   <div class="flex gap-2">
                        <button onclick="respond('${docSnap.id}', true)" class="bg-blue-500 text-white px-3 py-1.5 rounded-lg text-xs font-bold">Ch·∫•p nh·∫≠n</button>
                        <button onclick="respond('${docSnap.id}', false)" class="bg-gray-100 text-black px-3 py-1.5 rounded-lg text-xs font-bold">Xo√°</button>
                   </div>
                `;
                container.appendChild(div);
            }
        });
    }

    function listenSentRequests() {
        const q = query(
            collection(db, "friendRequests"),
            where("status", "==", "pending"),
            where("from", "==", currentUser.uid)
        );

        onSnapshot(q, async (snapshot) => {
            const container = document.getElementById("sent-list");
            container.innerHTML = "";
            if(snapshot.empty) {
                container.innerHTML = `<p class="text-sm text-gray-400 text-center py-2">Ch∆∞a g·ª≠i l·ªùi m·ªùi n√†o.</p>`;
                return;
            }

            for(const docSnap of snapshot.docs) {
                const data = docSnap.data();
                const userSnap = await getDoc(doc(db, "users", data.to));
                const user = userSnap.data() || { email: "..." };

                const div = document.createElement("div");
                div.className = "flex items-center justify-between p-2 border-b border-gray-100";
                div.innerHTML = `
                    <span class="text-sm font-medium text-gray-600">G·ª≠i t·ªõi: ${user.displayName || user.email}</span>
                    <button onclick="cancelReq('${docSnap.id}')" class="text-xs text-red-500 font-bold border border-red-200 px-2 py-1 rounded hover:bg-red-50">Hu·ª∑</button>
                `;
                container.appendChild(div);
            }
        });
    }

    // --- X·ª¨ L√ù T√åM KI·∫æM (ƒê√É C·∫¨P NH·∫¨T) --- //
    
    async function checkRelation(targetUid) {
        const q = query(collection(db, "friendRequests"), where("users", "array-contains", currentUser.uid));
        const snapshot = await getDocs(q);
        
        let result = { status: 'none', docId: null };
        
        snapshot.forEach(doc => {
            const d = doc.data();
            if (d.users.includes(targetUid)) {
                result.docId = doc.id;
                if (d.status === 'accepted') {
                    result.status = 'friends';
                } else if (d.status === 'pending') {
                    result.status = (d.from === currentUser.uid) ? 'sent' : 'received';
                }
            }
        });
        return result;
    }

    // T√¨m ki·∫øm: Th·ª≠ t√¨m Email -> N·∫øu r·ªóng th·ª≠ t√¨m DisplayName
    window.handleSearch = async () => {
        const keyword = document.getElementById("searchInput").value.trim();
        const container = document.getElementById("search-results");
        const errorDiv = document.getElementById("search-error");
        
        if(!keyword) return;
        
        container.innerHTML = `<p class="text-center text-gray-400">ƒêang t√¨m...</p>`;
        errorDiv.classList.add('hidden');

        let querySnap;

        // C√°ch 1: T√¨m theo Email ch√≠nh x√°c
        const qEmail = query(collection(db, "users"), where("email", "==", keyword));
        querySnap = await getDocs(qEmail);

        // C√°ch 2: N·∫øu kh√¥ng th·∫•y email, t√¨m theo displayName (ch√≠nh x√°c)
        if(querySnap.empty) {
            const qName = query(collection(db, "users"), where("displayName", "==", keyword));
            querySnap = await getDocs(qName);
        }

        container.innerHTML = "";
        
        if(querySnap.empty) {
            container.innerHTML = `
                <div class="text-center py-4">
                    <p class="text-3xl mb-2">üïµÔ∏è</p>
                    <p class="text-gray-500 font-medium">Kh√¥ng t√¨m th·∫•y.</p>
                    <p class="text-xs text-gray-400 mt-1">H√£y nh·∫≠p ch√≠nh x√°c Email ho·∫∑c T√™n.</p>
                </div>
            `;
            return;
        }

        for (const docSnap of querySnap.docs) {
            const user = docSnap.data();
            if(docSnap.id === currentUser.uid) {
                continue; // B·ªè qua b·∫£n th√¢n
            }

            const avatar = user.photoURL || `https://api.dicebear.com/9.x/avataaars/svg?seed=${docSnap.id}`;
            
            const relation = await checkRelation(docSnap.id);
            let btnHtml = '';

            if (relation.status === 'friends') {
                btnHtml = `<button class="bg-gray-100 text-gray-500 px-4 py-1.5 rounded-lg text-xs font-bold cursor-default">B·∫°n b√®</button>`;
            } else if (relation.status === 'sent') {
                btnHtml = `<button onclick="cancelReqFromSearch('${relation.docId}', this)" class="bg-gray-200 text-red-500 px-4 py-1.5 rounded-lg text-xs font-bold hover:bg-gray-300">ƒê√£ g·ª≠i (Hu·ª∑)</button>`;
            } else if (relation.status === 'received') {
                btnHtml = `<button onclick="switchTab('requests')" class="bg-blue-500 text-white px-4 py-1.5 rounded-lg text-xs font-bold">Xem l·ªùi m·ªùi</button>`;
            } else {
                btnHtml = `<button onclick="sendFriendRequest('${docSnap.id}', this)" class="bg-black text-white px-4 py-1.5 rounded-lg text-xs font-bold hover:opacity-80">K·∫øt b·∫°n</button>`;
            }

            const div = document.createElement("div");
            div.className = "flex items-center justify-between bg-white p-3 rounded-xl shadow-sm";
            div.innerHTML = `
                <div class="flex items-center gap-3">
                    <img src="${avatar}" class="w-10 h-10 rounded-full bg-gray-50">
                    <div>
                        <p class="font-bold text-sm">${user.displayName || "User"}</p>
                        <p class="text-xs text-gray-400">${user.email}</p>
                    </div>
                </div>
                <div id="action-area-${docSnap.id}">
                    ${btnHtml}
                </div>
            `;
            container.appendChild(div);
        }
        
        // N·∫øu sau khi l·ªçc b·∫£n th√¢n m√† danh s√°ch tr·ªëng
        if(container.innerHTML === "") {
             container.innerHTML = `<p class="text-center text-gray-500">ƒê√¢y l√† t√†i kho·∫£n c·ªßa b·∫°n.</p>`;
        }
    };

    window.sendFriendRequest = async (toUid, btnElement) => {
        btnElement.disabled = true;
        btnElement.innerText = "ƒêang g·ª≠i...";
        
        try {
            const docRef = await addDoc(collection(db, "friendRequests"), {
                from: currentUser.uid,
                to: toUid,
                status: "pending",
                users: [currentUser.uid, toUid],
                createdAt: serverTimestamp()
            });
            
            const parent = btnElement.parentElement;
            parent.innerHTML = `<button onclick="cancelReqFromSearch('${docRef.id}', this)" class="bg-gray-200 text-red-500 px-4 py-1.5 rounded-lg text-xs font-bold hover:bg-gray-300">ƒê√£ g·ª≠i (Hu·ª∑)</button>`;
            
        } catch (error) {
            console.error(error);
            btnElement.disabled = false;
            btnElement.innerText = "L·ªói. Th·ª≠ l·∫°i";
        }
    };

    window.cancelReqFromSearch = async (docId, btnElement) => {
        if(!confirm("Hu·ª∑ l·ªùi m·ªùi k·∫øt b·∫°n n√†y?")) return;
        
        btnElement.disabled = true;
        btnElement.innerText = "...";

        try {
            await deleteDoc(doc(db, "friendRequests", docId));
            btnElement.className = "bg-gray-100 text-gray-400 px-4 py-1.5 rounded-lg text-xs font-bold";
            btnElement.innerText = "ƒê√£ hu·ª∑";
            btnElement.onclick = null;
        } catch (e) {
            alert("L·ªói xo√°");
        }
    };

    window.respond = async (docId, accept) => {
        if(accept) {
            await updateDoc(doc(db, "friendRequests", docId), { status: "accepted" });
            switchTab('list');
        } else {
            await deleteDoc(doc(db, "friendRequests", docId));
        }
    };

    window.cancelReq = async (docId) => {
        if(confirm("Hu·ª∑ l·ªùi m·ªùi n√†y?")) {
            await deleteDoc(doc(db, "friendRequests", docId));
        }
    };

    window.unfriend = async (docId) => {
        if(confirm("Hu·ª∑ k·∫øt b·∫°n v·ªõi ng∆∞·ªùi n√†y?")) {
            await deleteDoc(doc(db, "friendRequests", docId));
        }
    };
  </script>
</body>
</html>
