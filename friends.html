<!DOCTYPE html>
<html lang="vi">
>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>B·∫°n b√® - LokTik</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
    }
    .section-box {
      @apply bg-white p-4 rounded-xl shadow mb-6;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">

  <div class="max-w-xl mx-auto">

    <h1 class="text-2xl font-bold text-center text-blue-600 mb-6">üë• Qu·∫£n l√Ω b·∫°n b√®</h1>

    <!-- üîç T√¨m b·∫°n -->
    <div class="section-box">
      <h2 class="text-lg font-semibold mb-3">üîç T√¨m b·∫°n</h2>
      <div class="flex gap-2">
        <input id="searchInput" type="text" placeholder="Nh·∫≠p t√™n, email ho·∫∑c UID..." class="flex-1 p-2 border rounded" />
        <button onclick="searchFriend()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">T√¨m</button>
      </div>
      <div id="searchResult" class="mt-4 text-sm text-gray-700"></div>
    </div>

    <!-- üì• L·ªùi m·ªùi k·∫øt b·∫°n -->
    <div id="friendRequests" class="section-box"></div>

    <!-- üë¨ Danh s√°ch b·∫°n b√® -->
    <div id="friendList" class="section-box"></div>

  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, getDocs, setDoc, deleteDoc, collection, query, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAJxH_3ZkN7wQnXVelRzm0mezBCBcxKoJM",
      authDomain: "loktik-1d9af.firebaseapp.com",
      projectId: "loktik-1d9af",
      storageBucket: "loktik-1d9af.appspot.com",
      messagingSenderId: "801363229819",
      appId: "1:801363229819:web:49f086bc180d9ed9c0b6de",
      measurementId: "G-S6HQ3HN7W3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let currentUser;

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        loadFriendRequests();
        loadFriendList();
      } else {
        window.location.href = "login.html";
      }
    });

    // üîç T√¨m b·∫°n
    window.searchFriend = async () => {
      const keyword = document.getElementById("searchInput").value.trim().toLowerCase();
      const resultDiv = document.getElementById("searchResult");
      resultDiv.innerHTML = "üîé ƒêang t√¨m...";

      const q = query(collection(db, "users"));
      const querySnapshot = await getDocs(q);

      let found = null;
      querySnapshot.forEach((docSnap) => {
        const data = docSnap.data();
        const uid = docSnap.id;
        const name = (data.name || "").toLowerCase();
        const email = (data.email || "").toLowerCase();

        if ((name.includes(keyword) || email.includes(keyword) || uid === keyword) && uid !== currentUser.uid) {
          found = { uid, ...data };
        }
      });

      if (found) {
        resultDiv.innerHTML = `
          <div class="p-3 border rounded-md bg-gray-50">
            <p class="font-semibold">${found.name || "Kh√¥ng t√™n"} <span class="text-sm text-gray-500">(${found.email || found.uid})</span></p>
            <button onclick="sendFriendRequest('${found.uid}')" class="mt-2 bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded">K·∫øt b·∫°n</button>
          </div>
        `;
      } else {
        resultDiv.innerHTML = "‚ùå Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng n√†o.";
      }
    };

    // üì§ G·ª≠i l·ªùi m·ªùi k·∫øt b·∫°n
    window.sendFriendRequest = async (toUID) => {
      const docId = `${currentUser.uid}_${toUID}`;
      await setDoc(doc(db, "friend_requests", docId), {
        from: currentUser.uid,
        to: toUID,
        status: "pending",
        timestamp: new Date()
      });
      alert("‚úÖ ƒê√£ g·ª≠i l·ªùi m·ªùi k·∫øt b·∫°n.");
    };

    // üì• L·ªùi m·ªùi k·∫øt b·∫°n ƒë·∫øn
    async function loadFriendRequests() {
      const q = query(collection(db, "friend_requests"), where("to", "==", currentUser.uid), where("status", "==", "pending"));
      const snap = await getDocs(q);

      const container = document.getElementById("friendRequests");
      container.innerHTML = "<h2 class='text-lg font-semibold mb-3'>üì• L·ªùi m·ªùi k·∫øt b·∫°n</h2>";

      if (snap.empty) {
        container.innerHTML += "<p class='text-gray-500'>Kh√¥ng c√≥ l·ªùi m·ªùi n√†o.</p>";
        return;
      }

      snap.forEach(async (docSnap) => {
        const data = docSnap.data();
        const fromUID = data.from;
        const userDoc = await getDoc(doc(db, "users", fromUID));
        const userData = userDoc.data();

        container.innerHTML += `
          <div class="p-3 border rounded mb-2 bg-gray-50">
            <p><strong>${userData.name || "Kh√¥ng t√™n"}</strong> (${userData.email || fromUID})</p>
            <div class="mt-2 flex gap-2">
              <button onclick="acceptFriend('${docSnap.id}', '${fromUID}')" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded">Ch·∫•p nh·∫≠n</button>
              <button onclick="rejectFriend('${docSnap.id}')" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded">T·ª´ ch·ªëi</button>
            </div>
          </div>
        `;
      });
    }

    // ‚úÖ Ch·∫•p nh·∫≠n
    window.acceptFriend = async (requestId, fromUID) => {
      await setDoc(doc(db, "friend_requests", requestId), {
        from: fromUID,
        to: currentUser.uid,
        status: "accepted",
        timestamp: new Date()
      });

      await setDoc(doc(db, "users", currentUser.uid, "friends", fromUID), { uid: fromUID });
      await setDoc(doc(db, "users", fromUID, "friends", currentUser.uid), { uid: currentUser.uid });

      loadFriendRequests();
      loadFriendList();
    };

    // ‚ùå T·ª´ ch·ªëi
    window.rejectFriend = async (requestId) => {
      await deleteDoc(doc(db, "friend_requests", requestId));
      loadFriendRequests();
    };

    // üë¨ Danh s√°ch b·∫°n b√®
    async function loadFriendList() {
      const snap = await getDocs(collection(db, "users", currentUser.uid, "friends"));
      const container = document.getElementById("friendList");
      container.innerHTML = "<h2 class='text-lg font-semibold mb-3'>üë¨ Danh s√°ch b·∫°n b√®</h2>";

      if (snap.empty) {
        container.innerHTML += "<p class='text-gray-500'>B·∫°n ch∆∞a c√≥ b·∫°n n√†o.</p>";
        return;
      }

      for (const docSnap of snap.docs) {
        const friendUID = docSnap.id;
        const userDoc = await getDoc(doc(db, "users", friendUID));
        const userData = userDoc.data();

        container.innerHTML += `
          <div class="p-3 border rounded mb-2 bg-gray-50">
            <p><strong>${userData.name || "Kh√¥ng t√™n"}</strong> (${userData.email || friendUID})</p>
            <div class="mt-2 flex gap-2">
              <button onclick="window.location.href='chat.html?uid=${friendUID}'" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded">Chat</button>
              <button onclick="unfriend('${friendUID}')" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded">Hu·ª∑ k·∫øt b·∫°n</button>
            </div>
          </div>
        `;
      }
    }

    // ‚ùå Hu·ª∑ k·∫øt b·∫°n
    window.unfriend = async (friendUID) => {
      await deleteDoc(doc(db, "users", currentUser.uid, "friends", friendUID));
      await deleteDoc(doc(db, "users", friendUID, "friends", currentUser.uid));
      loadFriendList();
    };
  </script>
</body>
</html>
