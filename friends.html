<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>B·∫°n b√® - LokTik</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .safe-area-pb { padding-bottom: env(safe-area-inset-bottom, 20px); }
  </style>
</head>
<body class="bg-white text-slate-900 pb-24">

  <header class="sticky top-0 bg-white z-30 border-b border-gray-100 px-4 py-3 flex justify-center items-center shadow-[0_2px_10px_-4px_rgba(0,0,0,0.05)]">
    <h1 class="font-bold text-lg">B·∫°n b√®</h1>
  </header>

  <main class="max-w-md mx-auto p-4">
    
    <div class="flex p-1 bg-gray-100 rounded-xl mb-6">
      <button onclick="switchTab('list')" id="tab-list" class="flex-1 py-2 text-sm font-bold rounded-lg bg-white shadow-sm text-black transition-all">Danh s√°ch</button>
      <button onclick="switchTab('requests')" id="tab-requests" class="flex-1 py-2 text-sm font-bold rounded-lg text-gray-500 hover:text-black transition-all relative">
        L·ªùi m·ªùi
        <span id="badge-req" class="hidden absolute top-1.5 right-3 w-2 h-2 bg-red-500 rounded-full border border-white"></span>
      </button>
      <button onclick="switchTab('search')" id="tab-search" class="flex-1 py-2 text-sm font-bold rounded-lg text-gray-500 hover:text-black transition-all">T√¨m & K·∫øt b·∫°n</button>
    </div>

    <div id="content-list" class="space-y-3">
        <div id="loading-friends" class="text-center text-gray-400 py-8">
            <div class="animate-spin w-6 h-6 border-2 border-blue-500 border-t-transparent rounded-full mx-auto mb-2"></div>
            ƒêang t·∫£i danh s√°ch...
        </div>
        <div id="friend-list-container"></div>
    </div>

    <div id="content-requests" class="hidden space-y-6">
        <div>
            <h3 class="text-xs font-bold text-gray-400 uppercase mb-3 tracking-wider">L·ªùi m·ªùi ƒë√£ nh·∫≠n</h3>
            <div id="received-list" class="space-y-3">
                <p class="text-sm text-gray-400 text-center py-4 bg-gray-50 rounded-lg border border-dashed border-gray-200">Kh√¥ng c√≥ l·ªùi m·ªùi n√†o.</p>
            </div>
        </div>
        
        <div>
            <h3 class="text-xs font-bold text-gray-400 uppercase mb-3 tracking-wider">ƒê√£ g·ª≠i ƒëi</h3>
            <div id="sent-list" class="space-y-2"></div>
        </div>
    </div>

    <div id="content-search" class="hidden space-y-4">
        <div class="relative group">
            <input type="text" id="searchInput" placeholder="T√¨m theo t√™n ho·∫∑c email..." class="w-full bg-gray-50 border border-gray-200 p-3 pl-10 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white transition shadow-sm">
            <svg class="w-5 h-5 text-gray-400 absolute left-3 top-3.5 group-focus-within:text-blue-500 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            <button onclick="handleSearch()" class="absolute right-1.5 top-1.5 bg-slate-900 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-slate-700 transition">T√¨m</button>
        </div>
        
        <div id="search-hint" class="text-xs text-gray-500 text-center italic">
            M·∫πo: ƒê·ªÉ tr·ªëng v√† b·∫•m "T√¨m" ƒë·ªÉ xem ng∆∞·ªùi d√πng g·ª£i √Ω.
        </div>

        <div id="search-results" class="space-y-3 pt-2">
            </div>
    </div>

  </main>

  <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 flex justify-around items-center py-3 pb-5 z-40 safe-area-pb shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.02)]">
    <a href="feed.html" class="flex flex-col items-center text-gray-400 hover:text-black transition group">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-7 h-7">
        <path d="M11.47 3.84a.75.75 0 011.06 0l8.69 8.69a.75.75 0 101.06-1.06l-8.689-8.69a2.25 2.25 0 00-3.182 0l-8.69 8.69a.75.75 0 001.061 1.06l8.69-8.69z" />
        <path d="M12 5.432l8.159 8.159c.03.03.06.058.091.086v6.198c0 1.035-.84 1.875-1.875 1.875H15a.75.75 0 01-.75-.75v-4.5a.75.75 0 00-.75-.75h-3a.75.75 0 00-.75.75V21a.75.75 0 01-.75.75H5.625a1.875 1.875 0 01-1.875-1.875v-6.198a2.29 2.29 0 00.091-.086L12 5.43z" />
      </svg>
      <span class="text-[10px] font-medium mt-1">Trang ch·ªß</span>
    </a>

    <a href="friends.html" class="flex flex-col items-center text-black transition group">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-7 h-7">
            <path fill-rule="evenodd" d="M8.25 6.75a3.75 3.75 0 117.5 0 3.75 3.75 0 01-7.5 0zM15.75 9.75a3 3 0 116 0 3 3 0 01-6 0zM2.25 9.75a3 3 0 116 0 3 3 0 01-6 0zM6.31 15.117A6.745 6.745 0 0112 12a6.745 6.745 0 016.709 7.498.75.75 0 01-.372.568A12.696 12.696 0 0112 21.75c-2.305 0-4.47-.612-6.337-1.684a.75.75 0 01-.372-.568 6.787 6.787 0 011.019-4.38z" clip-rule="evenodd" />
            <path d="M5.082 14.254a8.287 8.287 0 00-1.308 5.135 9.687 9.687 0 01-1.764-.44l-.115-.04a.563.563 0 01-.373-.487l-.115.04a3.75 3.75 0 013.57-4.047zM20.226 19.389a8.287 8.287 0 00-1.308-5.135 3.75 3.75 0 013.57 4.047l-.01.121a.563.563 0 01-.373.486l-.115.04c-.567.2-1.156.349-1.764.441z" />
        </svg>
        <span class="text-[10px] font-medium mt-1">B·∫°n b√®</span>
    </a>
    
    <a href="upload.html" class="flex flex-col items-center group">
      <div class="relative w-12 h-8 scale-110">
        <div class="absolute left-0 top-0 bottom-0 w-8 bg-cyan-400 rounded-lg transform -translate-x-1 shadow-sm"></div>
        <div class="absolute right-0 top-0 bottom-0 w-8 bg-red-500 rounded-lg transform translate-x-1 shadow-sm"></div>
        <div class="absolute left-0 right-0 top-0 bottom-0 bg-white rounded-lg flex items-center justify-center border-x-2 border-black z-10">
            <span class="text-black font-bold text-xl leading-none mb-0.5">+</span>
        </div>
      </div>
    </a>

    <a href="chat.html" class="flex flex-col items-center text-gray-400 hover:text-black transition group">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-7 h-7">
            <path fill-rule="evenodd" d="M4.804 21.644A6.707 6.707 0 006 21.75a6.721 6.721 0 003.583-1.029c.774.182 1.584.279 2.417.279 5.322 0 9.75-3.97 9.75-9 0-5.03-4.428-9-9.75-9s-9.75 3.97-9.75 9c0 2.409 1.025 4.587 2.674 6.192.232.226.277.428.254.543a3.73 3.73 0 01-.814 1.686.75.75 0 00.44 1.223zM8.25 10.875a1.125 1.125 0 100 2.25 1.125 1.125 0 000-2.25zM10.875 12a1.125 1.125 0 112.25 0 1.125 1.125 0 01-2.25 0zm4.875-1.125a1.125 1.125 0 100 2.25 1.125 1.125 0 000-2.25z" clip-rule="evenodd" />
          </svg>
      <span class="text-[10px] font-medium mt-1">H·ªôp th∆∞</span>
    </a>

    <a href="account.html" class="flex flex-col items-center text-gray-400 hover:text-black transition">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-7 h-7">
        <path fill-rule="evenodd" d="M7.5 6a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM3.751 20.105a8.25 8.25 0 0116.498 0 .75.75 0 01-.437.695A18.683 18.683 0 0112 22.5c-2.786 0-5.433-.608-7.812-1.7a.75.75 0 01-.437-.695z" clip-rule="evenodd" />
      </svg>
      <span class="text-[10px] font-medium mt-1">H·ªì s∆°</span>
    </a>
  </nav>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, query, where, getDocs, addDoc, updateDoc, deleteDoc, doc, getDoc, onSnapshot, serverTimestamp, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAJxH_3ZkN7wQnXVelRzm0mezBCBcxKoJM",
      authDomain: "loktik-1d9af.firebaseapp.com",
      projectId: "loktik-1d9af",
      storageBucket: "loktik-1d9af.appspot.com",
      messagingSenderId: "801363229819",
      appId: "1:801363229819:web:49f086bc180d9ed9c0b6de"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;

    // Tab Switching
    window.switchTab = (tabName) => {
        ['list', 'requests', 'search'].forEach(t => {
            document.getElementById(`content-${t}`).classList.add('hidden');
            const btn = document.getElementById(`tab-${t}`);
            btn.className = "flex-1 py-2 text-sm font-bold rounded-lg text-gray-500 hover:text-black transition-all";
        });
        document.getElementById(`content-${tabName}`).classList.remove('hidden');
        document.getElementById(`tab-${tabName}`).className = "flex-1 py-2 text-sm font-bold rounded-lg bg-white shadow-sm text-black transition-all";
    };

    // Auth & Init
    onAuthStateChanged(auth, user => {
      if (!user) return window.location.href = "login.html";
      currentUser = user;
      
      listenFriends();
      listenRequests();
      listenSentRequests();
    });

    // 1. Listen Friends List
    function listenFriends() {
        const q = query(
            collection(db, "friendRequests"),
            where("status", "==", "accepted"),
            where("users", "array-contains", currentUser.uid)
        );

        onSnapshot(q, async (snapshot) => {
            const container = document.getElementById("friend-list-container");
            document.getElementById("loading-friends").style.display = "none";
            container.innerHTML = "";

            if(snapshot.empty) {
                container.innerHTML = `
                    <div class="text-center text-gray-400 py-10">
                        <p class="text-4xl mb-2 grayscale opacity-50">ü§∑‚Äç‚ôÇÔ∏è</p>
                        <p>Ch∆∞a c√≥ b·∫°n b√® n√†o.</p>
                        <button onclick="switchTab('search')" class="mt-3 text-blue-500 font-semibold text-sm hover:underline">T√¨m k·∫øt b·∫°n ngay</button>
                    </div>`;
                return;
            }

            for (const docSnap of snapshot.docs) {
                const data = docSnap.data();
                const otherUid = data.users.find(uid => uid !== currentUser.uid);
                
                // L·∫•y th√¥ng tin user (n·∫øu xo√° user th√¨ hi·ªÉn th·ªã Ng∆∞·ªùi d√πng ·∫©n)
                let user = { displayName: "Ng∆∞·ªùi d√πng", email: "...", photoURL: null };
                try {
                    const userSnap = await getDoc(doc(db, "users", otherUid));
                    if(userSnap.exists()) user = userSnap.data();
                } catch(e) {}

                const avatar = user.photoURL || `https://api.dicebear.com/9.x/avataaars/svg?seed=${otherUid}`;
                const name = user.displayName || user.email.split('@')[0];

                const div = document.createElement("div");
                div.className = "flex items-center justify-between bg-white p-3 rounded-xl shadow-sm border border-gray-100";
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <img src="${avatar}" class="w-12 h-12 rounded-full bg-gray-50 border border-gray-100 object-cover">
                        <div>
                            <p class="font-bold text-sm text-slate-900">${name}</p>
                            <a href="chat-room.html?id=${docSnap.id}&friendName=${encodeURIComponent(name)}" class="text-xs text-blue-600 font-semibold hover:underline flex items-center gap-1 mt-0.5">
                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.207 12.793l-1.414 1.414L12 13.414l-2.793 2.793-1.414-1.414L10.586 12 7.793 9.207l1.414-1.414L12 10.586l2.793-2.793 1.414 1.414L13.414 12l2.793 2.793z"/></svg>
                                Nh·∫Øn tin
                            </a>
                        </div>
                    </div>
                    <button onclick="unfriend('${docSnap.id}')" class="text-gray-300 hover:text-red-500 p-2 transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                `;
                container.appendChild(div);
            }
        });
    }

    // 2. Listen Incoming Requests
    function listenRequests() {
        const q = query(
            collection(db, "friendRequests"),
            where("status", "==", "pending"),
            where("to", "==", currentUser.uid)
        );

        onSnapshot(q, async (snapshot) => {
            const container = document.getElementById("received-list");
            const badge = document.getElementById("badge-req");
            
            if(snapshot.empty) {
                container.innerHTML = `<p class="text-sm text-gray-400 text-center py-4 bg-gray-50 rounded-lg border border-dashed border-gray-200">Kh√¥ng c√≥ l·ªùi m·ªùi n√†o.</p>`;
                badge.classList.add("hidden");
                return;
            }
            
            badge.classList.remove("hidden");
            container.innerHTML = "";
            
            for(const docSnap of snapshot.docs) {
                const data = docSnap.data();
                let user = { displayName: "Ai ƒë√≥", photoURL: null };
                try {
                    const userSnap = await getDoc(doc(db, "users", data.from));
                    if(userSnap.exists()) user = userSnap.data();
                } catch(e){}

                const avatar = user.photoURL || `https://api.dicebear.com/9.x/avataaars/svg?seed=${data.from}`;

                const div = document.createElement("div");
                div.className = "flex items-center justify-between bg-white p-3 rounded-xl shadow-[0_2px_8px_-2px_rgba(0,0,0,0.1)] border border-gray-50";
                div.innerHTML = `
                   <div class="flex items-center gap-3">
                        <img src="${avatar}" class="w-10 h-10 rounded-full bg-gray-100 object-cover">
                        <p class="font-bold text-sm">${user.displayName}</p>
                   </div>
                   <div class="flex gap-2">
                        <button onclick="respond('${docSnap.id}', true)" class="bg-blue-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-blue-700 transition">Ch·∫•p nh·∫≠n</button>
                        <button onclick="respond('${docSnap.id}', false)" class="bg-gray-100 text-slate-600 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-gray-200 transition">Xo√°</button>
                   </div>
                `;
                container.appendChild(div);
            }
        });
    }

    // 3. Listen Sent Requests
    function listenSentRequests() {
        const q = query(
            collection(db, "friendRequests"),
            where("status", "==", "pending"),
            where("from", "==", currentUser.uid)
        );

        onSnapshot(q, async (snapshot) => {
            const container = document.getElementById("sent-list");
            container.innerHTML = "";
            if(snapshot.empty) return;

            for(const docSnap of snapshot.docs) {
                const data = docSnap.data();
                let user = { email: "...", displayName: "..." };
                try {
                    const userSnap = await getDoc(doc(db, "users", data.to));
                    if(userSnap.exists()) user = userSnap.data();
                } catch(e){}

                const div = document.createElement("div");
                div.className = "flex items-center justify-between p-3 border-b border-gray-100 last:border-0";
                div.innerHTML = `
                    <div class="flex flex-col">
                        <span class="text-sm font-semibold text-slate-700">${user.displayName}</span>
                        <span class="text-xs text-gray-400">ƒêang ch·ªù ph·∫£n h·ªìi...</span>
                    </div>
                    <button onclick="cancelReq('${docSnap.id}')" class="text-xs text-red-500 font-bold border border-red-100 px-3 py-1.5 rounded-lg hover:bg-red-50 transition">Hu·ª∑</button>
                `;
                container.appendChild(div);
            }
        });
    }

    // --- X·ª¨ L√ù T√åM KI·∫æM & G·ª¢I √ù (ƒê√É C·∫¨P NH·∫¨T LOWERCASE) --- //
    
    // H√†m ki·ªÉm tra m·ªëi quan h·ªá (B·∫°n b√®/ƒê√£ g·ª≠i/ƒê√£ nh·∫≠n/Ch∆∞a l√† g√¨)
    async function checkRelation(targetUid) {
        const q = query(collection(db, "friendRequests"), where("users", "array-contains", currentUser.uid));
        const snapshot = await getDocs(q);
        
        let result = { status: 'none', docId: null };
        
        snapshot.forEach(doc => {
            const d = doc.data();
            if (d.users.includes(targetUid)) {
                result.docId = doc.id;
                if (d.status === 'accepted') {
                    result.status = 'friends';
                } else if (d.status === 'pending') {
                    result.status = (d.from === currentUser.uid) ? 'sent' : 'received';
                }
            }
        });
        return result;
    }

    window.handleSearch = async () => {
        // 1. L·∫•y t·ª´ kh√≥a v√† chuy·ªÉn th√†nh ch·ªØ th∆∞·ªùng ƒë·ªÉ t√¨m ki·∫øm kh√¥ng ph√¢n bi·ªát hoa/th∆∞·ªùng
        const rawKeyword = document.getElementById("searchInput").value.trim();
        const keyword = rawKeyword.toLowerCase(); 
        
        const container = document.getElementById("search-results");
        
        container.innerHTML = `<div class="text-center text-gray-400 py-4"><span class="animate-pulse">ƒêang t√¨m ki·∫øm...</span></div>`;

        let querySnap;

        // LOGIC M·ªöI: N·∫øu ƒë·ªÉ tr·ªëng √¥ t√¨m ki·∫øm -> Hi·ªán g·ª£i √Ω 10 ng∆∞·ªùi d√πng m·ªõi nh·∫•t
        if(!keyword) {
             const qSuggest = query(collection(db, "users"), limit(10)); 
             querySnap = await getDocs(qSuggest);
             document.getElementById("search-hint").innerText = "G·ª£i √Ω k·∫øt b·∫°n (10 ng∆∞·ªùi d√πng m·ªõi nh·∫•t):";
        } else {
             // 2. T√åM KI·∫æM THEO LOWERCASE EMAIL
             const qEmail = query(collection(db, "users"), where("lowercaseEmail", "==", keyword));
             querySnap = await getDocs(qEmail);

             // 3. N·∫øu kh√¥ng t√¨m th·∫•y Email, T√åM KI·∫æM THEO LOWERCASE DISPLAYNAME
             if(querySnap.empty) {
                const qName = query(collection(db, "users"), where("lowercaseName", "==", keyword));
                querySnap = await getDocs(qName);
             }
             document.getElementById("search-hint").innerText = `K·∫øt qu·∫£ cho: "${rawKeyword}"`;
        }

        container.innerHTML = "";
        
        if(querySnap.empty) {
            container.innerHTML = `
                <div class="text-center py-6">
                    <p class="text-3xl mb-2 grayscale opacity-50">üïµÔ∏è</p>
                    <p class="text-gray-500 font-medium">Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng kh·ªõp.</p>
                    <p class="text-xs text-gray-400 mt-1">H√£y th·ª≠ nh·∫≠p email ho·∫∑c t√™n ƒë·∫ßy ƒë·ªß.</p>
                </div>
            `;
            return;
        }

        let resultsFound = 0;
        for (const docSnap of querySnap.docs) {
            const user = docSnap.data();
            if(docSnap.id === currentUser.uid) continue; // B·ªè qua ch√≠nh m√¨nh

            resultsFound++;
            const avatar = user.photoURL || `https://api.dicebear.com/9.x/avataaars/svg?seed=${docSnap.id}`;
            const relation = await checkRelation(docSnap.id);
            
            let btnHtml = '';

            if (relation.status === 'friends') {
                btnHtml = `<button class="bg-green-100 text-green-600 px-4 py-1.5 rounded-lg text-xs font-bold cursor-default flex items-center gap-1"><svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg> B·∫°n b√®</button>`;
            } else if (relation.status === 'sent') {
                btnHtml = `<button onclick="cancelReqFromSearch('${relation.docId}', this)" class="bg-gray-100 text-red-500 px-4 py-1.5 rounded-lg text-xs font-bold hover:bg-gray-200 transition">ƒê√£ g·ª≠i (Hu·ª∑)</button>`;
            } else if (relation.status === 'received') {
                btnHtml = `<button onclick="switchTab('requests')" class="bg-blue-100 text-blue-600 px-4 py-1.5 rounded-lg text-xs font-bold hover:bg-blue-200 transition">Xem l·ªùi m·ªùi</button>`;
            } else {
                btnHtml = `<button onclick="sendFriendRequest('${docSnap.id}', this)" class="bg-slate-900 text-white px-4 py-1.5 rounded-lg text-xs font-bold hover:bg-slate-700 transition shadow-sm">K·∫øt b·∫°n</button>`;
            }

            const div = document.createElement("div");
            div.className = "flex items-center justify-between bg-white p-3 rounded-xl shadow-sm border border-gray-100";
            div.innerHTML = `
                <div class="flex items-center gap-3">
                    <img src="${avatar}" class="w-10 h-10 rounded-full bg-gray-50 object-cover">
                    <div>
                        <p class="font-bold text-sm text-slate-900">${user.displayName || "User"}</p>
                        <p class="text-[10px] text-gray-400 font-mono">${user.email}</p>
                    </div>
                </div>
                <div>${btnHtml}</div>
            `;
            container.appendChild(div);
        }
        
        // X·ª≠ l√Ω tr∆∞·ªùng h·ª£p kh√¥ng t√¨m th·∫•y (n·∫øu k·∫øt qu·∫£ t√¨m ki·∫øm r·ªóng)
        if(resultsFound === 0) {
            container.innerHTML = `
                <div class="text-center py-6">
                    <p class="text-3xl mb-2 grayscale opacity-50">üïµÔ∏è</p>
                    <p class="text-gray-500 font-medium">Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng kh·ªõp.</p>
                    <p class="text-xs text-gray-400 mt-1">H√£y th·ª≠ nh·∫≠p email ho·∫∑c t√™n ƒë·∫ßy ƒë·ªß.</p>
                </div>
            `;
        }
    };

    // Actions
    window.sendFriendRequest = async (toUid, btnElement) => {
        btnElement.disabled = true;
        btnElement.innerText = "...";
        try {
            const docRef = await addDoc(collection(db, "friendRequests"), {
                from: currentUser.uid,
                to: toUid,
                status: "pending",
                users: [currentUser.uid, toUid],
                createdAt: serverTimestamp()
            });
            const parent = btnElement.parentElement;
            parent.innerHTML = `<button onclick="cancelReqFromSearch('${docRef.id}', this)" class="bg-gray-100 text-red-500 px-4 py-1.5 rounded-lg text-xs font-bold hover:bg-gray-200">ƒê√£ g·ª≠i (Hu·ª∑)</button>`;
        } catch (error) {
            console.error(error);
            alert("L·ªói g·ª≠i l·ªùi m·ªùi");
            btnElement.disabled = false;
            btnElement.innerText = "K·∫øt b·∫°n";
        }
    };

    window.cancelReqFromSearch = async (docId, btnElement) => {
        if(!confirm("Hu·ª∑ l·ªùi m·ªùi k·∫øt b·∫°n n√†y?")) return;
        try {
            await deleteDoc(doc(db, "friendRequests", docId));
            const parent = btnElement.parentElement;
            // Simple approach: Alert text change
            btnElement.className = "bg-gray-50 text-gray-400 px-4 py-1.5 rounded-lg text-xs font-bold cursor-default";
            btnElement.innerText = "ƒê√£ hu·ª∑";
            btnElement.onclick = null;
        } catch (e) { alert("L·ªói xo√°"); }
    };

    window.respond = async (docId, accept) => {
        if(accept) {
            await updateDoc(doc(db, "friendRequests", docId), { status: "accepted" });
            switchTab('list');
        } else {
            await deleteDoc(doc(db, "friendRequests", docId));
        }
    };

    window.cancelReq = async (docId) => {
        if(confirm("Hu·ª∑ l·ªùi m·ªùi n√†y?")) await deleteDoc(doc(db, "friendRequests", docId));
    };

    window.unfriend = async (docId) => {
        if(confirm("Hu·ª∑ k·∫øt b·∫°n v·ªõi ng∆∞·ªùi n√†y?")) await deleteDoc(doc(db, "friendRequests", docId));
    };
  </script>
</body>
</html>
