<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Kết bạn - LokTik</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4">
  <h1 class="text-2xl font-bold mb-4">Tìm bạn và kết bạn</h1>

  <input id="searchInput" type="text" placeholder="Nhập tên, email hoặc UID..."
    class="w-full p-2 border rounded mb-4" />

  <div id="results" class="space-y-4"></div>

  <!-- Firebase Config -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAJxH_3ZkN7wQnXVelRzm0mezBCBcxKoJM",
      authDomain: "loktik-1d9af.firebaseapp.com",
      projectId: "loktik-1d9af",
      storageBucket: "loktik-1d9af.appspot.com",
      messagingSenderId: "801363229819",
      appId: "1:801363229819:web:49f086bc180d9ed9c0b6de",
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
  </script>

  <!-- Script tìm bạn -->
  <script>
    const searchInput = document.getElementById("searchInput");
    const resultsDiv = document.getElementById("results");

    let currentUser = null;

    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        alert("Vui lòng đăng nhập");
        window.location.href = "login.html";
        return;
      }
      currentUser = user;
    });

    searchInput.addEventListener("input", async () => {
      const keyword = searchInput.value.trim().toLowerCase();
      resultsDiv.innerHTML = "";

      if (keyword === "") return;

      const snapshot = await db.collection("users").get();
      snapshot.forEach((doc) => {
        const data = doc.data();
        const uid = doc.id;

        if (uid === currentUser.uid) return;

        const name = data.name?.toLowerCase() || "";
        const email = data.email?.toLowerCase() || "";

        if (
          uid.toLowerCase().includes(keyword) ||
          name.includes(keyword) ||
          email.includes(keyword)
        ) {
          const container = document.createElement("div");
          container.className = "bg-white p-4 rounded shadow flex items-center justify-between";

          container.innerHTML = `
            <div>
              <p class="font-semibold">${data.name || "(Không có tên)"}</p>
              <p>Email: ${data.email || "?"}</p>
              <p>UID: ${uid}</p>
            </div>
            <button class="bg-blue-500 text-white px-4 py-2 rounded" onclick="sendFriendRequest('${uid}', this)">
              Kết bạn
            </button>
          `;
          resultsDiv.appendChild(container);
        }
      });
    });

    async function sendFriendRequest(targetUid, button) {
      if (!currentUser || !targetUid) return;

      // Kiểm tra đã gửi chưa
      const ref = db
        .collection("friendRequests")
        .doc(targetUid)
        .collection("requests")
        .doc(currentUser.uid);

      const existing = await ref.get();
      if (existing.exists) {
        alert("Đã gửi lời mời trước đó");
        return;
      }

      // Gửi lời mời
      await ref.set({
        fromUid: currentUser.uid,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      });

      // Cập nhật danh sách lời mời đã gửi
      await db
        .collection("friendRequests")
        .doc(currentUser.uid)
        .collection("sent")
        .doc(targetUid)
        .set({
          toUid: targetUid,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        });

      button.innerText = "Đã gửi ✅";
      button.disabled = true;
      button.classList.add("bg-gray-400");
    }
  </script>
</body>
</html>
