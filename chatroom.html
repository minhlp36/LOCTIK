<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Trò chuyện - LokTik</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Ẩn thanh cuộn nhưng vẫn cuộn được */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    /* Hiệu ứng bong bóng chat */
    .msg-own {
        border-bottom-right-radius: 4px;
    }
    .msg-friend {
        border-bottom-left-radius: 4px;
    }
  </style>
</head>
<body class="bg-white flex flex-col h-screen fixed inset-0">

  <header class="bg-white border-b border-gray-100 p-3 flex items-center gap-3 z-10 shrink-0 shadow-sm">
    <a href="chat.html" class="p-2 -ml-2 text-gray-800 hover:bg-gray-100 rounded-full transition">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
        <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
      </svg>
    </a>
    
    <div class="flex items-center gap-3">
        <div class="relative">
            <img id="friendAvatar" src="https://via.placeholder.com/40" class="w-10 h-10 rounded-full border border-gray-200 object-cover">
            <div class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-green-500 border-2 border-white rounded-full"></div>
        </div>
        <div>
            <h1 id="friendName" class="font-bold text-slate-900 leading-tight">Người dùng</h1>
            <p class="text-xs text-gray-500 flex items-center gap-1">
                <span class="inline-block w-1.5 h-1.5 bg-green-500 rounded-full"></span> Đang hoạt động
            </p>
        </div>
    </div>
  </header>

  <div id="messagesContainer" class="flex-1 overflow-y-auto p-4 space-y-3 bg-white scroll-smooth pb-20">
    <div id="loadingMsg" class="flex justify-center mt-10">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
    </div>
  </div>

  <div class="bg-white border-t border-gray-100 p-3 pb-safe shrink-0 absolute bottom-0 w-full z-20">
    <form id="chatForm" class="flex items-end gap-2 max-w-md mx-auto">
        <button type="button" class="p-2 text-gray-400 hover:text-blue-500 transition">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7">
                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a2.25 2.25 0 002.25-2.25V6a2.25 2.25 0 00-2.25-2.25H3.75A2.25 2.25 0 001.5 6v12.25c0 1.243 1.057 2.25 2.25 2.25zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
            </svg>
        </button>

        <div class="flex-1 bg-gray-100 rounded-3xl flex items-center px-4 py-2 focus-within:ring-2 focus-within:ring-blue-100 transition">
            <input type="text" id="messageInput" autocomplete="off" placeholder="Nhắn tin..." class="w-full bg-transparent outline-none text-slate-900 placeholder-gray-500 py-1" required />
        </div>

        <button type="submit" class="p-3 bg-blue-600 text-white rounded-full shadow-lg shadow-blue-200 hover:bg-blue-700 active:scale-95 transition flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 ml-0.5">
                <path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" />
            </svg>
        </button>
    </form>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAJxH_3ZkN7wQnXVelRzm0mezBCBcxKoJM",
      authDomain: "loktik-1d9af.firebaseapp.com",
      projectId: "loktik-1d9af",
      storageBucket: "loktik-1d9af.appspot.com",
      messagingSenderId: "801363229819",
      appId: "1:801363229819:web:49f086bc180d9ed9c0b6de"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // DOM Elements
    const messagesContainer = document.getElementById("messagesContainer");
    const messageInput = document.getElementById("messageInput");
    const chatForm = document.getElementById("chatForm");
    const friendNameEl = document.getElementById("friendName");
    const friendAvatarEl = document.getElementById("friendAvatar");
    const loadingMsg = document.getElementById("loadingMsg");

    // Get URL Params
    const params = new URLSearchParams(window.location.search);
    const chatId = params.get("id"); // Đây là ID của FriendRequest hoặc ID phòng chat riêng
    const friendNameParam = params.get("friendName"); // Lấy tên từ URL (truyền từ trang trước)

    if (!chatId) {
      alert("Lỗi: Không tìm thấy phòng chat.");
      window.location.href = "chat.html";
    }

    // Set Header UI ngay lập tức từ URL param (để đỡ bị giật)
    if (friendNameParam) {
        friendNameEl.textContent = decodeURIComponent(friendNameParam);
        // Avatar tạm thời dựa trên tên (seed)
        friendAvatarEl.src = `https://api.dicebear.com/9.x/avataaars/svg?seed=${friendNameParam}`;
    }

    let currentUser = null;

    auth.onAuthStateChanged(user => {
      if (!user) return window.location.href = "login.html";
      currentUser = user;
      
      // Bắt đầu lắng nghe tin nhắn
      listenMessages();
      
      // (Tuỳ chọn) Load lại thông tin friend kỹ hơn từ Firestore nếu cần
      // loadFriendDetails(); 
    });

    // 1. Lắng nghe tin nhắn Realtime
    function listenMessages() {
      // Lưu ý: Collection path là: chats -> [chatId] -> messages
      const q = query(
        collection(db, "chats", chatId, "messages"),
        orderBy("createdAt", "asc")
      );

      onSnapshot(q, (snapshot) => {
        loadingMsg.style.display = "none"; // Ẩn loading
        
        // Xóa nội dung cũ để render lại (đơn giản hoá, thực tế nên append)
        messagesContainer.innerHTML = "";
        
        // Khoảng trống dưới cùng để không bị che bởi input
        const spacer = document.createElement("div");
        spacer.className = "h-16"; 
        
        snapshot.forEach((doc) => {
            const msg = doc.data();
            const isMine = msg.sender === currentUser.uid;
            
            renderMessage(msg.text, isMine);
        });

        messagesContainer.appendChild(spacer);
        scrollToBottom();
      });
    }

    // 2. Render 1 tin nhắn ra màn hình
    function renderMessage(text, isMine) {
        const divWrapper = document.createElement("div");
        divWrapper.className = `flex w-full ${isMine ? "justify-end" : "justify-start"}`;

        const divBubble = document.createElement("div");
        // Style bong bóng
        if (isMine) {
            divBubble.className = "msg-own bg-blue-600 text-white px-4 py-2 rounded-2xl rounded-tr-sm max-w-[75%] break-words shadow-sm text-[15px]";
        } else {
            divBubble.className = "msg-friend bg-gray-100 text-slate-800 px-4 py-2 rounded-2xl rounded-tl-sm max-w-[75%] break-words text-[15px]";
        }
        
        divBubble.textContent = text;
        divWrapper.appendChild(divBubble);
        messagesContainer.appendChild(divWrapper);
    }

    // 3. Gửi tin nhắn
    chatForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const text = messageInput.value.trim();
      if (!text) return;

      // Xóa input ngay lập tức cho mượt
      messageInput.value = "";
      messageInput.focus();

      try {
        await addDoc(collection(db, "chats", chatId, "messages"), {
            text: text,
            sender: currentUser.uid,
            createdAt: serverTimestamp()
        });
        scrollToBottom();
      } catch (err) {
        console.error("Lỗi gửi tin:", err);
        alert("Không gửi được tin nhắn.");
      }
    });

    function scrollToBottom() {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
  </script>
</body>
</html>
