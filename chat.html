<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Tin nhắn - LokTik</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
    /* Ẩn thanh cuộn */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .safe-area-pb { padding-bottom: env(safe-area-inset-bottom, 20px); }
    
    /* Animation nhẹ */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
  </style>
</head>
<body class="bg-white text-slate-900 h-screen flex flex-col">

  <header class="bg-white px-4 py-3 flex items-center justify-between shrink-0 sticky top-0 z-30">
    <h1 class="text-2xl font-bold tracking-tight">Đoạn chat</h1>
    <button onclick="switchTab('search')" class="w-9 h-9 bg-gray-100 rounded-full flex items-center justify-center hover:bg-gray-200 transition">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 text-gray-600">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
        </svg>          
    </button>
  </header>

  <div class="px-4 pb-2 shrink-0 z-20 bg-white">
    <div class="flex p-1 bg-gray-100 rounded-xl">
      <button onclick="switchTab('friends')" id="btn-friends" class="flex-1 py-1.5 text-xs font-bold rounded-lg bg-white shadow-sm text-black transition-all">
        Hộp thư
      </button>
      <button onclick="switchTab('requests')" id="btn-requests" class="flex-1 py-1.5 text-xs font-bold rounded-lg text-gray-500 hover:text-black transition-all relative">
        Lời mời
        <span id="badge-requests" class="hidden absolute top-0.5 right-3 w-2 h-2 bg-red-500 rounded-full border border-white"></span>
      </button>
    </div>
  </div>

  <div class="flex-1 overflow-y-auto no-scrollbar pb-24 relative">
    
    <div id="tab-friends" class="block px-2">
      <div id="friendsList" class="space-y-1 mt-1">
          <div class="flex items-center gap-3 p-3">
              <div class="w-14 h-14 bg-gray-100 rounded-full animate-pulse"></div>
              <div class="flex-1 space-y-2">
                  <div class="h-4 bg-gray-100 rounded w-1/3 animate-pulse"></div>
                  <div class="h-3 bg-gray-100 rounded w-2/3 animate-pulse"></div>
              </div>
          </div>
          <div class="flex items-center gap-3 p-3">
              <div class="w-14 h-14 bg-gray-100 rounded-full animate-pulse"></div>
              <div class="flex-1 space-y-2">
                  <div class="h-4 bg-gray-100 rounded w-1/4 animate-pulse"></div>
                  <div class="h-3 bg-gray-100 rounded w-1/2 animate-pulse"></div>
              </div>
          </div>
      </div>
    </div>

    <div id="tab-requests" class="hidden px-4 pt-2">
      <h3 class="text-xs font-bold text-gray-400 mb-4 uppercase tracking-wider">Yêu cầu kết bạn</h3>
      <div id="requestsList" class="space-y-4"></div>
    </div>

    <div id="tab-search" class="hidden px-4 pt-2 bg-white absolute inset-0 z-40">
        <div class="flex items-center gap-2 mb-4">
             <button onclick="switchTab('friends')" class="text-gray-500 text-sm">Hủy</button>
             <h2 class="font-bold flex-1 text-center">Tìm bạn mới</h2>
             <div class="w-6"></div> 
        </div>
        <div class="relative mb-6">
            <input type="text" id="searchInput" placeholder="Nhập email..." class="w-full bg-gray-100 p-3 pl-10 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 transition text-sm">
            <svg class="w-4 h-4 text-gray-400 absolute left-3 top-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            <button onclick="searchUser()" class="absolute right-2 top-2 bg-black text-white px-3 py-1.5 rounded-lg text-xs font-bold">Tìm</button>
        </div>
        <div id="searchResult" class="space-y-3"></div>
    </div>

  </div>

  <nav class="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-md border-t border-gray-100 flex justify-around items-center py-3 pb-safe z-50">
    <a href="feed.html" class="flex flex-col items-center text-gray-400 hover:text-black transition group w-16">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 group-hover:scale-110 transition">
        <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
      </svg>
    </a>

    <a href="friends.html" class="flex flex-col items-center text-gray-400 hover:text-black transition group w-16">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 group-hover:scale-110 transition">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" />
        </svg>
    </a>
    
    <a href="upload.html" class="flex flex-col items-center group -mt-5">
      <div class="relative w-14 h-14 bg-black rounded-full flex items-center justify-center shadow-lg shadow-black/20 group-hover:scale-105 transition">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-7 h-7 text-white">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
          </svg>
      </div>
    </a>

    <a href="chat.html" class="flex flex-col items-center text-black transition group w-16">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 group-hover:scale-110 transition">
            <path fill-rule="evenodd" d="M4.804 21.644A6.707 6.707 0 006 21.75a6.721 6.721 0 003.583-1.029c.774.182 1.584.279 2.417.279 5.322 0 9.75-3.97 9.75-9 0-5.03-4.428-9-9.75-9s-9.75 3.97-9.75 9c0 2.409 1.025 4.587 2.674 6.192.232.226.277.428.254.543a3.73 3.73 0 01-.814 1.686.75.75 0 00.44 1.223zM8.25 10.875a1.125 1.125 0 100 2.25 1.125 1.125 0 000-2.25zM10.875 12a1.125 1.125 0 112.25 0 1.125 1.125 0 01-2.25 0zm4.875-1.125a1.125 1.125 0 100 2.25 1.125 1.125 0 000-2.25z" clip-rule="evenodd" />
          </svg>
          <span class="w-1.5 h-1.5 bg-black rounded-full mt-1"></span>
    </a>

    <a href="account.html" class="flex flex-col items-center text-gray-400 hover:text-black transition w-16">
      <div class="w-6 h-6 rounded-full border-2 border-gray-300 overflow-hidden">
         <img id="myNavAvatar" src="https://via.placeholder.com/30" class="w-full h-full object-cover">
      </div>
    </a>
  </nav>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, query, where, getDocs, addDoc, updateDoc, deleteDoc, doc, getDoc, onSnapshot, serverTimestamp, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAJxH_3ZkN7wQnXVelRzm0mezBCBcxKoJM",
      authDomain: "loktik-1d9af.firebaseapp.com",
      projectId: "loktik-1d9af",
      storageBucket: "loktik-1d9af.appspot.com",
      messagingSenderId: "801363229819",
      appId: "1:801363229819:web:49f086bc180d9ed9c0b6de"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    let currentUser = null;

    // --- UI Helpers ---
    window.switchTab = (tabName) => {
      // Ẩn tất cả tab
      ['friends', 'requests', 'search'].forEach(id => {
          document.getElementById(`tab-${id}`).classList.add('hidden');
      });
      // Hiện tab được chọn
      document.getElementById(`tab-${tabName}`).classList.remove('hidden');

      // Style nút
      const btnFriends = document.getElementById('btn-friends');
      const btnRequests = document.getElementById('btn-requests');

      if (tabName === 'search') return; // Không đổi style nút khi search

      if(tabName === 'friends') {
          btnFriends.className = "flex-1 py-1.5 text-xs font-bold rounded-lg bg-white shadow-sm text-black transition-all";
          btnRequests.className = "flex-1 py-1.5 text-xs font-bold rounded-lg text-gray-500 hover:text-black transition-all relative";
      } else {
          btnRequests.className = "flex-1 py-1.5 text-xs font-bold rounded-lg bg-white shadow-sm text-black transition-all relative";
          btnFriends.className = "flex-1 py-1.5 text-xs font-bold rounded-lg text-gray-500 hover:text-black transition-all";
      }
    };

    // Helper: Định dạng thời gian (ví dụ: 12:30, Hôm qua)
    function formatMessageTime(timestamp) {
        if (!timestamp) return "";
        const date = timestamp.toDate();
        const now = new Date();
        const diffMs = now - date;
        const diffDays = diffMs / (1000 * 60 * 60 * 24);

        if (diffDays < 1 && date.getDate() === now.getDate()) {
            return date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit', hour12: false });
        } else if (diffDays < 2) {
            return "Hôm qua";
        } else {
            return date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' });
        }
    }

    // --- Main Logic ---
    onAuthStateChanged(auth, (user) => {
      if (!user) return location.href = "login.html";
      currentUser = user;
      
      // Load avatar cho navbar
      const navAvatar = document.getElementById("myNavAvatar");
      if(user.photoURL) navAvatar.src = user.photoURL;
      else navAvatar.src = `https://api.dicebear.com/9.x/avataaars/svg?seed=${user.uid}`;

      listenToFriends();
      listenToRequests();
    });

    // 1. Lắng nghe danh sách bạn bè & SẮP XẾP THEO TIN NHẮN MỚI NHẤT
    function listenToFriends() {
      const q = query(
        collection(db, "friendRequests"),
        where("status", "==", "accepted"),
        where("users", "array-contains", currentUser.uid)
      );

      onSnapshot(q, async (snapshot) => {
        const listEl = document.getElementById("friendsList");

        if (snapshot.empty) {
            listEl.innerHTML = `
            <div class="flex flex-col items-center justify-center pt-20 text-gray-400">
                <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-3">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 8.511c.884.284 1.5 1.128 1.5 2.097v4.286c0 1.136-.847 2.1-1.98 2.193-.34.027-.68.052-1.02.072v3.091l-3-3c-1.354 0-2.694-.055-4.02-.163a2.115 2.115 0 01-.825-.242m9.345-8.334a2.126 2.126 0 00-.476-.095 48.64 48.64 0 00-8.048 0c-1.131.094-1.976 1.057-1.976 2.192v4.286c0 .837.46 1.58 1.155 1.951m9.345-8.334V6.637c0-1.621-1.152-3.026-2.76-3.235A48.455 48.455 0 0011.25 3c-2.115 0-4.198.137-6.24.402-1.608.209-2.76 1.614-2.76 3.235v6.226c0 1.621 1.152 3.026 2.76 3.235.577.075 1.157.14 1.74.194V21l4.155-4.155" />
                    </svg>
                </div>
                <p class="text-sm font-medium">Chưa có tin nhắn nào</p>
                <button onclick="switchTab('search')" class="mt-3 text-blue-600 font-bold text-sm bg-blue-50 px-4 py-2 rounded-lg">Tìm bạn mới ngay</button>
            </div>`;
            return;
        }

        // Lấy dữ liệu + Lấy tin nhắn cuối cùng để sắp xếp
        const conversations = await Promise.all(snapshot.docs.map(async (docSnap) => {
            const data = docSnap.data();
            const otherUID = data.users.find(uid => uid !== currentUser.uid);
            
            // 1. Lấy thông tin User
            let friend = { displayName: "Người dùng", photoURL: null };
            try {
                const userSnap = await getDoc(doc(db, "users", otherUID));
                if (userSnap.exists()) friend = userSnap.data();
            } catch (e) { console.log(e); }

            // 2. Lấy tin nhắn cuối cùng (để hiển thị và sắp xếp)
            let lastMsg = { text: "Bắt đầu trò chuyện", createdAt: null };
            try {
                const msgsQuery = query(
                    collection(db, "chats", docSnap.id, "messages"),
                    orderBy("createdAt", "desc"),
                    limit(1)
                );
                const msgsSnap = await getDocs(msgsQuery);
                if (!msgsSnap.empty) {
                    const msgData = msgsSnap.docs[0].data();
                    lastMsg = { 
                        text: msgData.text, 
                        createdAt: msgData.createdAt,
                        sender: msgData.sender
                    };
                }
            } catch (e) { console.log("Lỗi lấy last msg", e); }

            return {
                chatId: docSnap.id,
                friendUid: otherUID,
                friend: friend,
                lastMsg: lastMsg
            };
        }));

        // SẮP XẾP: Tin nhắn mới nhất lên đầu (Dựa vào createdAt)
        conversations.sort((a, b) => {
            const timeA = a.lastMsg.createdAt ? a.lastMsg.createdAt.toMillis() : 0;
            const timeB = b.lastMsg.createdAt ? b.lastMsg.createdAt.toMillis() : 0;
            return timeB - timeA; // Giảm dần
        });

        // Render ra HTML
        listEl.innerHTML = "";
        conversations.forEach(item => {
            const { chatId, friend, lastMsg, friendUid } = item;
            const avatar = friend.photoURL || `https://api.dicebear.com/9.x/avataaars/svg?seed=${friendUid}`;
            const name = friend.displayName || "Người dùng";
            
            // Format hiển thị tin nhắn cuối
            const isMe = lastMsg.sender === currentUser.uid;
            const previewText = isMe ? `Bạn: ${lastMsg.text}` : lastMsg.text;
            const timeDisplay = formatMessageTime(lastMsg.lastMsg?.createdAt || lastMsg.createdAt);
            
            // Style chữ đậm nếu không phải mình nhắn (giả lập chưa đọc - logic đơn giản)
            const textStyle = (!isMe && lastMsg.createdAt) ? "text-slate-900 font-medium" : "text-gray-500";

            const div = document.createElement("div");
            div.innerHTML = `
            <a href="chatroom.html?id=${chatId}&friendName=${encodeURIComponent(name)}" class="flex items-center gap-3 p-3 hover:bg-gray-50 rounded-2xl transition cursor-pointer animate-fade-in group">
              <div class="relative shrink-0">
                <img src="${avatar}" class="w-14 h-14 rounded-full object-cover border border-gray-100 group-hover:scale-105 transition" />
                <div class="absolute bottom-0 right-0 w-3.5 h-3.5 bg-green-500 border-[2.5px] border-white rounded-full"></div>
              </div>
              <div class="flex-1 min-w-0 border-b border-gray-50 pb-3 group-hover:border-transparent">
                <div class="flex justify-between items-baseline mb-0.5">
                    <h4 class="font-bold text-[15px] text-slate-900 truncate pr-2">${name}</h4>
                    <span class="text-[11px] text-gray-400 shrink-0">${timeDisplay}</span>
                </div>
                <p class="text-[13px] ${textStyle} truncate pr-4 leading-snug">${previewText}</p>
              </div>
            </a>
            `;
            listEl.appendChild(div);
        });
      });
    }

    // 2. Lắng nghe lời mời (Giữ nguyên logic, cập nhật UI)
    function listenToRequests() {
      const q = query(
        collection(db, "friendRequests"),
        where("to", "==", currentUser.uid),
        where("status", "==", "pending")
      );

      onSnapshot(q, async (snapshot) => {
        const listEl = document.getElementById("requestsList");
        const badge = document.getElementById("badge-requests");
        
        listEl.innerHTML = "";

        if (snapshot.empty) {
            badge.classList.add("hidden");
            listEl.innerHTML = `
            <div class="text-center py-10">
                <p class="text-gray-400 text-sm">Không có lời mời nào.</p>
            </div>`;
            return;
        }

        badge.classList.remove("hidden");

        for (const docSnap of snapshot.docs) {
          const data = docSnap.data();
          const userSnap = await getDoc(doc(db, "users", data.from));
          if(!userSnap.exists()) continue;

          const sender = userSnap.data();
          const avatar = sender.photoURL || `https://api.dicebear.com/9.x/avataaars/svg?seed=${data.from}`;

          const div = document.createElement("div");
          div.className = "flex items-center justify-between bg-white p-3 rounded-2xl border border-gray-100 shadow-sm";
          div.innerHTML = `
            <div class="flex items-center gap-3">
              <img src="${avatar}" class="w-12 h-12 rounded-full bg-gray-100 object-cover" />
              <div>
                <p class="font-bold text-sm text-black">${sender.displayName || "Người dùng"}</p>
                <p class="text-xs text-gray-400">Muốn kết bạn</p>
              </div>
            </div>
            <div class="flex gap-1.5">
              <button class="btn-accept bg-black text-white text-xs px-3 py-2 rounded-lg font-bold hover:bg-gray-800 transition">Đồng ý</button>
              <button class="btn-decline bg-gray-100 text-gray-600 text-xs px-3 py-2 rounded-lg font-bold hover:bg-gray-200 transition">Xóa</button>
            </div>
          `;

          div.querySelector(".btn-accept").onclick = () => respondRequest(docSnap.id, true);
          div.querySelector(".btn-decline").onclick = () => respondRequest(docSnap.id, false);
          
          listEl.appendChild(div);
        }
      });
    }

    // Xử lý chấp nhận/từ chối
    window.respondRequest = async (docId, isAccepted) => {
      try {
        const ref = doc(db, "friendRequests", docId);
        if (isAccepted) {
            await updateDoc(ref, { status: "accepted" });
            switchTab('friends');
        } else {
            await deleteDoc(ref);
        }
      } catch (err) { console.error(err); }
    };

    // 3. Tìm kiếm (Giữ nguyên logic)
    window.searchUser = async () => {
      const email = document.getElementById("searchInput").value.trim();
      const resultEl = document.getElementById("searchResult");
      
      if (!email) {
          resultEl.innerHTML = `<p class="text-center text-gray-400 text-sm py-4">Vui lòng nhập email.</p>`;
          return;
      }
      resultEl.innerHTML = `<div class="text-center text-gray-400 py-4"><div class="animate-spin rounded-full h-5 w-5 border-b-2 border-gray-400 mx-auto"></div></div>`;

      // Search query
      const q = query(collection(db, "users"), where("lowercaseEmail", "==", email.toLowerCase()));
      const querySnap = await getDocs(q);

      if (querySnap.empty) {
        resultEl.innerHTML = `<p class="text-red-500 text-center text-sm py-4">Không tìm thấy người dùng này.</p>`;
        return;
      }

      resultEl.innerHTML = "";
      querySnap.forEach(async (docSnap) => {
          const user = docSnap.data();
          const uid = docSnap.id;
          if (uid === currentUser.uid) return;

          const avatar = user.photoURL || `https://api.dicebear.com/9.x/avataaars/svg?seed=${uid}`;
          
          const qCheck = query(collection(db, "friendRequests"), where("users", "array-contains", uid));
          const checkSnap = await getDocs(qCheck);
          
          let buttonHtml = `<button onclick="sendRequest('${uid}', this)" class="bg-blue-600 text-white px-4 py-1.5 rounded-lg text-xs font-bold shadow-sm hover:scale-105 transition">Kết bạn</button>`;

          if(!checkSnap.empty) {
              const data = checkSnap.docs[0].data();
              if (data.status === 'accepted') buttonHtml = `<span class="text-green-500 text-xs font-bold bg-green-50 px-3 py-1 rounded-lg">Đã là bạn</span>`;
              else if (data.status === 'pending') buttonHtml = `<span class="text-gray-500 text-xs font-bold bg-gray-100 px-3 py-1 rounded-lg">Đã gửi</span>`;
          }
          
          const item = document.createElement("div");
          item.className = "flex items-center justify-between p-3 bg-gray-50 rounded-xl animate-fade-in";
          item.innerHTML = `
             <div class="flex items-center gap-3">
                <img src="${avatar}" class="w-10 h-10 rounded-full bg-white">
                <span class="font-bold text-sm">${user.displayName || user.email}</span>
             </div>
             <div>${buttonHtml}</div>
          `;
          resultEl.appendChild(item);
      });
    };

    window.sendRequest = async (toUid, btnElement) => {
        btnElement.disabled = true;
        btnElement.textContent = '...';
        try {
            await addDoc(collection(db, "friendRequests"), {
                from: currentUser.uid,
                to: toUid,
                status: "pending",
                users: [currentUser.uid, toUid],
                createdAt: serverTimestamp()
            });
            btnElement.parentElement.innerHTML = `<span class="text-gray-500 text-xs font-bold bg-gray-100 px-3 py-1 rounded-lg">Đã gửi</span>`;
        } catch (error) {
            console.error(error);
            alert("Lỗi: " + error.message);
            btnElement.disabled = false;
            btnElement.textContent = 'Kết bạn';
        }
    };
  </script>
</body>
</html>
