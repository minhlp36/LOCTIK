<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>H·ªôp th∆∞ - LokTik</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .safe-area-pb { padding-bottom: env(safe-area-inset-bottom, 20px); }
  </style>
</head>
<body class="bg-white text-slate-900 pb-20">

  <header class="sticky top-0 bg-white z-20 border-b border-gray-100 px-4 py-3 flex items-center justify-center">
    <h1 class="text-lg font-bold">H·ªôp th∆∞</h1>
    <button onclick="switchTab('search')" class="absolute right-4 text-black">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zM3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" />
        </svg>          
    </button>
  </header>

  <div class="max-w-md mx-auto">
    
    <div class="flex p-2 gap-2 bg-gray-50 mx-4 mt-2 rounded-lg">
      <button onclick="switchTab('friends')" id="btn-friends" class="flex-1 py-1.5 text-sm font-medium rounded-md bg-white shadow text-black transition-all">
        Tin nh·∫Øn
      </button>
      <button onclick="switchTab('requests')" id="btn-requests" class="flex-1 py-1.5 text-sm font-medium rounded-md text-gray-500 hover:text-black transition-all relative">
        L·ªùi m·ªùi
        <span id="badge-requests" class="hidden absolute top-0 right-2 w-2 h-2 bg-red-500 rounded-full"></span>
      </button>
    </div>

    <div class="p-4 min-h-[500px]">
      
      <div id="tab-friends" class="block animate-fade-in">
        <div id="friendsList" class="space-y-1">
            <div class="flex items-center gap-3 p-2">
                <div class="w-12 h-12 bg-gray-200 rounded-full animate-pulse"></div>
                <div class="flex-1 space-y-2">
                    <div class="h-4 bg-gray-200 rounded w-1/3 animate-pulse"></div>
                    <div class="h-3 bg-gray-200 rounded w-1/2 animate-pulse"></div>
                </div>
            </div>
        </div>
      </div>

      <div id="tab-requests" class="hidden">
        <h3 class="text-sm font-bold text-gray-500 mb-3 uppercase tracking-wide">Y√™u c·∫ßu m·ªõi</h3>
        <div id="requestsList" class="space-y-4"></div>
      </div>

      <div id="tab-search" class="hidden">
        <div class="relative mb-6">
            <input type="text" id="searchInput" placeholder="T√¨m theo email..." class="w-full bg-gray-100 p-3 pl-10 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 transition">
            <svg class="w-5 h-5 text-gray-400 absolute left-3 top-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            <button onclick="searchUser()" class="absolute right-2 top-2 bg-black text-white px-3 py-1.5 rounded-lg text-sm font-bold">T√¨m</button>
        </div>
        <div id="searchResult" class="space-y-3"></div>
      </div>

    </div>
  </div>

  <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 flex justify-around items-center py-3 pb-5 z-40 safe-area-pb shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.02)]">
    <a href="feed.html" class="flex flex-col items-center text-gray-400 hover:text-black transition group">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-7 h-7">
        <path d="M11.47 3.84a.75.75 0 011.06 0l8.69 8.69a.75.75 0 101.06-1.06l-8.689-8.69a2.25 2.25 0 00-3.182 0l-8.69 8.69a.75.75 0 001.061 1.06l8.69-8.69z" />
        <path d="M12 5.432l8.159 8.159c.03.03.06.058.091.086v6.198c0 1.035-.84 1.875-1.875 1.875H15a.75.75 0 01-.75-.75v-4.5a.75.75 0 00-.75-.75h-3a.75.75 0 00-.75.75V21a.75.75 0 01-.75.75H5.625a1.875 1.875 0 01-1.875-1.875v-6.198a2.29 2.29 0 00.091-.086L12 5.43z" />
      </svg>
      <span class="text-[10px] font-medium mt-1">Trang ch·ªß</span>
    </a>

    <a href="friends.html" class="flex flex-col items-center text-gray-400 hover:text-black transition group">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-7 h-7">
            <path fill-rule="evenodd" d="M8.25 6.75a3.75 3.75 0 117.5 0 3.75 3.75 0 01-7.5 0zM15.75 9.75a3 3 0 116 0 3 3 0 01-6 0zM2.25 9.75a3 3 0 116 0 3 3 0 01-6 0zM6.31 15.117A6.745 6.745 0 0112 12a6.745 6.745 0 016.709 7.498.75.75 0 01-.372.568A12.696 12.696 0 0112 21.75c-2.305 0-4.47-.612-6.337-1.684a.75.75 0 01-.372-.568 6.787 6.787 0 011.019-4.38z" clip-rule="evenodd" />
            <path d="M5.082 14.254a8.287 8.287 0 00-1.308 5.135 9.687 9.687 0 01-1.764-.44l-.115-.04a.563.563 0 01-.373-.487l-.115.04a3.75 3.75 0 013.57-4.047zM20.226 19.389a8.287 8.287 0 00-1.308-5.135 3.75 3.75 0 013.57 4.047l-.01.121a.563.563 0 01-.373.486l-.115.04c-.567.2-1.156.349-1.764.441z" />
        </svg>
        <span class="text-[10px] font-medium mt-1">B·∫°n b√®</span>
    </a>
    
    <a href="upload.html" class="flex flex-col items-center group">
      <div class="relative w-12 h-8 scale-110">
        <div class="absolute left-0 top-0 bottom-0 w-8 bg-cyan-400 rounded-lg transform -translate-x-1 shadow-sm"></div>
        <div class="absolute right-0 top-0 bottom-0 w-8 bg-red-500 rounded-lg transform translate-x-1 shadow-sm"></div>
        <div class="absolute left-0 right-0 top-0 bottom-0 bg-white rounded-lg flex items-center justify-center border-x-2 border-black z-10">
            <span class="text-black font-bold text-xl leading-none mb-0.5">+</span>
        </div>
      </div>
    </a>

    <a href="chat.html" class="flex flex-col items-center text-black transition group">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-7 h-7">
            <path fill-rule="evenodd" d="M4.804 21.644A6.707 6.707 0 006 21.75a6.721 6.721 0 003.583-1.029c.774.182 1.584.279 2.417.279 5.322 0 9.75-3.97 9.75-9 0-5.03-4.428-9-9.75-9s-9.75 3.97-9.75 9c0 2.409 1.025 4.587 2.674 6.192.232.226.277.428.254.543a3.73 3.73 0 01-.814 1.686.75.75 0 00.44 1.223zM8.25 10.875a1.125 1.125 0 100 2.25 1.125 1.125 0 000-2.25zM10.875 12a1.125 1.125 0 112.25 0 1.125 1.125 0 01-2.25 0zm4.875-1.125a1.125 1.125 0 100 2.25 1.125 1.125 0 000-2.25z" clip-rule="evenodd" />
          </svg>
      <span class="text-[10px] font-medium mt-1">H·ªôp th∆∞</span>
    </a>

    <a href="account.html" class="flex flex-col items-center text-gray-400 hover:text-black transition">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-7 h-7">
        <path fill-rule="evenodd" d="M7.5 6a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM3.751 20.105a8.25 8.25 0 0116.498 0 .75.75 0 01-.437.695A18.683 18.683 0 0112 22.5c-2.786 0-5.433-.608-7.812-1.7a.75.75 0 01-.437-.695z" clip-rule="evenodd" />
      </svg>
      <span class="text-[10px] font-medium mt-1">H·ªì s∆°</span>
    </a>
  </nav>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, query, where, getDocs, addDoc, updateDoc, deleteDoc, doc, getDoc, onSnapshot, serverTimestamp, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAJxH_3ZkN7wQnXVelRzm0mezBCBcxKoJM",
      authDomain: "loktik-1d9af.firebaseapp.com",
      projectId: "loktik-1d9af",
      storageBucket: "loktik-1d9af.appspot.com",
      messagingSenderId: "801363229819",
      appId: "1:801363229819:web:49f086bc180d9ed9c0b6de"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    let currentUser = null;

    // --- UI Helpers ---
    window.switchTab = (tabName) => {
      document.getElementById('tab-friends').classList.add('hidden');
      document.getElementById('tab-requests').classList.add('hidden');
      document.getElementById('tab-search').classList.add('hidden');
      
      document.getElementById(`tab-${tabName}`).classList.remove('hidden');

      // Style buttons
      const btnFriends = document.getElementById('btn-friends');
      const btnRequests = document.getElementById('btn-requests');

      if(tabName === 'friends' || tabName === 'search') {
          btnFriends.className = "flex-1 py-1.5 text-sm font-medium rounded-md bg-white shadow text-black transition-all";
          btnRequests.className = "flex-1 py-1.5 text-sm font-medium rounded-md text-gray-500 hover:text-black transition-all relative";
      } else {
          btnRequests.className = "flex-1 py-1.5 text-sm font-medium rounded-md bg-white shadow text-black transition-all relative";
          btnFriends.className = "flex-1 py-1.5 text-sm font-medium rounded-md text-gray-500 hover:text-black transition-all";
      }
    };

    // --- Main Logic ---
    onAuthStateChanged(auth, (user) => {
      if (!user) return location.href = "login.html";
      currentUser = user;
      listenToFriends();
      listenToRequests();
    });

    // 1. L·∫Øng nghe danh s√°ch b·∫°n b√® (Real-time)
    function listenToFriends() {
      const q = query(
        collection(db, "friendRequests"),
        where("status", "==", "accepted"),
        where("users", "array-contains", currentUser.uid)
      );

      // onSnapshot t·ª± ƒë·ªông ch·∫°y l·∫°i khi d·ªØ li·ªáu thay ƒë·ªïi
      onSnapshot(q, async (snapshot) => {
        const listEl = document.getElementById("friendsList");
        listEl.innerHTML = "";

        if (snapshot.empty) {
            listEl.innerHTML = `<div class="text-center py-10 text-gray-400">
                <p class="text-4xl mb-2">üëã</p>
                <p>Ch∆∞a c√≥ cu·ªôc tr√≤ chuy·ªán n√†o.</p>
                <button onclick="switchTab('search')" class="text-blue-500 font-bold mt-2">T√¨m b·∫°n m·ªõi</button>
            </div>`;
            return;
        }

        // C·∫ßn l·∫•y info user c·ªßa t·ª´ng ng∆∞·ªùi b·∫°n
        for (const docSnap of snapshot.docs) {
          const data = docSnap.data();
          const otherUID = data.users.find(uid => uid !== currentUser.uid);
          
          // L·∫•y th√¥ng tin ng∆∞·ªùi kia
          const userSnap = await getDoc(doc(db, "users", otherUID));
          if(!userSnap.exists()) continue;

          const friend = userSnap.data();
          const avatar = friend.photoURL || `https://api.dicebear.com/9.x/avataaars/svg?seed=${otherUID}`;
          const name = friend.displayName || friend.email.split('@')[0];

          const item = document.createElement("div");
          item.innerHTML = `
            <a href="chat-room.html?id=${docSnap.id}&friendName=${encodeURIComponent(name)}" class="flex items-center gap-4 p-3 hover:bg-gray-50 rounded-xl transition cursor-pointer">
              <div class="relative">
                <img src="${avatar}" class="w-12 h-12 rounded-full object-cover border border-gray-100" />
                <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white rounded-full"></div>
              </div>
              <div class="flex-1 min-w-0">
                <h4 class="font-bold text-slate-900 truncate">${name}</h4>
                <p class="text-sm text-gray-500 truncate">Nh·∫•n ƒë·ªÉ nh·∫Øn tin...</p>
              </div>
              <div class="text-gray-300">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg>
              </div>
            </a>
          `;
          listEl.appendChild(item);
        }
      });
    }

    // 2. L·∫Øng nghe l·ªùi m·ªùi k·∫øt b·∫°n (Real-time)
    function listenToRequests() {
      const q = query(
        collection(db, "friendRequests"),
        where("to", "==", currentUser.uid),
        where("status", "==", "pending")
      );

      onSnapshot(q, async (snapshot) => {
        const listEl = document.getElementById("requestsList");
        const badge = document.getElementById("badge-requests");
        
        listEl.innerHTML = "";

        if (snapshot.empty) {
            badge.classList.add("hidden");
            listEl.innerHTML = `<p class="text-center text-gray-400 text-sm py-4">Kh√¥ng c√≥ l·ªùi m·ªùi n√†o.</p>`;
            return;
        }

        badge.classList.remove("hidden"); // Hi·ªán ch·∫•m ƒë·ªè

        for (const docSnap of snapshot.docs) {
          const data = docSnap.data();
          const userSnap = await getDoc(doc(db, "users", data.from));
          if(!userSnap.exists()) continue;

          const sender = userSnap.data();
          const avatar = sender.photoURL || `https://api.dicebear.com/9.x/avataaars/svg?seed=${data.from}`;

          const div = document.createElement("div");
          div.className = "flex items-center justify-between bg-white p-3 rounded-xl border border-gray-100 shadow-sm";
          div.innerHTML = `
            <div class="flex items-center gap-3">
              <img src="${avatar}" class="w-10 h-10 rounded-full bg-gray-100" />
              <div>
                <p class="font-bold text-sm text-black">${sender.displayName || "Ng∆∞·ªùi d√πng"}</p>
                <p class="text-xs text-gray-400">Mu·ªën k·∫øt b·∫°n</p>
              </div>
            </div>
            <div class="flex gap-2">
              <button class="btn-accept bg-blue-500 text-white text-xs px-3 py-1.5 rounded-lg font-bold hover:bg-blue-600 transition">Ch·∫•p nh·∫≠n</button>
              <button class="btn-decline bg-gray-100 text-gray-600 text-xs px-3 py-1.5 rounded-lg font-bold hover:bg-gray-200 transition">Xo√°</button>
            </div>
          `;

          // G√°n s·ª± ki·ªán click
          div.querySelector(".btn-accept").onclick = () => respondRequest(docSnap.id, true);
          div.querySelector(".btn-decline").onclick = () => respondRequest(docSnap.id, false);
          
          listEl.appendChild(div);
        }
      });
    }

    // X·ª≠ l√Ω ch·∫•p nh·∫≠n/t·ª´ ch·ªëi
    window.respondRequest = async (docId, isAccepted) => {
      try {
        const ref = doc(db, "friendRequests", docId);
        
        if (isAccepted) {
            await updateDoc(ref, { status: "accepted" });
            // Sau khi ch·∫•p nh·∫≠n, chuy·ªÉn sang tab tin nh·∫Øn
            switchTab('friends');
        } else {
            // N·∫øu t·ª´ ch·ªëi, x√≥a lu√¥n doc ƒë√≥
            await deleteDoc(ref);
        }
      } catch (err) {
        console.error(err);
        alert("C√≥ l·ªói x·∫£y ra");
      }
    };

    // 3. T√¨m ki·∫øm ng∆∞·ªùi d√πng (ƒê√£ s·ª≠a l·ªói c√∫ ph√°p getDocs)
    window.searchUser = async () => {
      const email = document.getElementById("searchInput").value.trim();
      const resultEl = document.getElementById("searchResult");
      
      if (!email) {
          resultEl.innerHTML = `<p class="text-center text-gray-400 text-sm py-4">Vui l√≤ng nh·∫≠p email ƒë·ªÉ t√¨m ki·∫øm.</p>`;
          return;
      }

      resultEl.innerHTML = `<div class="text-center text-gray-400">ƒêang t√¨m...</div>`;

      // S·ª¨ D·ª§NG TR∆Ø·ªúNG lowercaseEmail ƒë·ªÉ t√¨m ki·∫øm
      const q = query(collection(db, "users"), where("lowercaseEmail", "==", email.toLowerCase()));
      const querySnap = await getDocs(q); // D√πng getDocs cho query

      if (querySnap.empty) {
        resultEl.innerHTML = `<p class="text-red-500 text-center text-sm">Kh√¥ng t√¨m th·∫•y email n√†y.</p>`;
        return;
      }

      resultEl.innerHTML = "";
      
      querySnap.forEach(async (docSnap) => {
          const user = docSnap.data();
          const uid = docSnap.id;

          if (uid === currentUser.uid) {
            resultEl.innerHTML = `<p class="text-gray-500 text-center text-sm">ƒê√¢y l√† t√†i kho·∫£n c·ªßa b·∫°n.</p>`;
            return;
          }

          const avatar = user.photoURL || `https://api.dicebear.com/9.x/avataaars/svg?seed=${uid}`;
          
          // Ki·ªÉm tra tr·∫°ng th√°i hi·ªán t·∫°i (ƒê√£ l√† b·∫°n b√®/ƒêang ch·ªù)
          const qCheck = query(
              collection(db, "friendRequests"),
              where("users", "array-contains", uid) // T√¨m doc ch·ª©a uid c·ªßa ng∆∞·ªùi t√¨m th·∫•y
          );
          
          const checkSnap = await getDocs(qCheck);
          let buttonHtml = `<button onclick="sendRequest('${uid}', this)" class="bg-black text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow hover:scale-105 transition">K·∫øt b·∫°n</button>`;

          if(!checkSnap.empty) {
              const data = checkSnap.docs[0].data();
              if (data.status === 'accepted') {
                  buttonHtml = `<span class="text-green-500 text-xs font-bold">ƒê√£ l√† b·∫°n</span>`;
              } else if (data.status === 'pending') {
                  buttonHtml = `<span class="text-gray-500 text-xs font-bold">ƒê√£ g·ª≠i/Nh·∫≠n l·ªùi m·ªùi</span>`;
              }
          }
          
          const item = document.createElement("div");
          item.className = "flex items-center justify-between p-3 bg-gray-50 rounded-xl";
          item.innerHTML = `
             <div class="flex items-center gap-3">
                <img src="${avatar}" class="w-10 h-10 rounded-full">
                <span class="font-bold text-sm">${user.displayName || user.email}</span>
             </div>
             <div>${buttonHtml}</div>
          `;
          resultEl.appendChild(item);
      });
    };

    window.sendRequest = async (toUid, btnElement) => {
        btnElement.disabled = true;
        btnElement.textContent = '...';

        try {
            await addDoc(collection(db, "friendRequests"), {
                from: currentUser.uid,
                to: toUid,
                status: "pending",
                users: [currentUser.uid, toUid],
                createdAt: serverTimestamp()
            });
            
            // C·∫≠p nh·∫≠t button sau khi g·ª≠i th√†nh c√¥ng
            btnElement.parentElement.innerHTML = `<span class="text-gray-500 text-xs font-bold">ƒê√£ g·ª≠i</span>`;
        } catch (error) {
            console.error(error);
            alert("L·ªói g·ª≠i l·ªùi m·ªùi: " + error.message);
            btnElement.disabled = false;
            btnElement.textContent = 'K·∫øt b·∫°n';
        }
    };
    
    // Quick fix: Import getDocs manualy inside module scope for search function
    import { getDocs as getDocsLocal } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  </script>
</body>
</html>
