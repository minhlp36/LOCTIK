<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LokTik - Trang ch·ªß</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <style>
    .like-btn {
      transition: transform 0.2s;
    }
    .like-btn:active {
      transform: scale(1.2);
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col justify-between">

  <!-- B√†i ƒëƒÉng -->
  <main class="flex-grow overflow-y-auto p-4 space-y-4" id="postList">
    <p class="text-center text-gray-500">‚è≥ ƒêang t·∫£i b√†i vi·∫øt...</p>
  </main>

  <!-- ƒêi·ªÅu h∆∞·ªõng -->
  <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-300 flex justify-around py-2">
    <a href="feed.html" class="flex flex-col items-center text-blue-500 font-bold">
      <span class="text-xl">üè†</span>
      <span class="text-sm">Trang ch·ªß</span>
    </a>
    <a href="upload.html" class="flex flex-col items-center text-gray-600 hover:text-blue-500">
      <span class="text-xl">‚ûï</span>
      <span class="text-sm">ƒêƒÉng</span>
    </a>
    <a href="chat.html" class="flex flex-col items-center text-gray-600 hover:text-blue-500">
      <span class="text-xl">üí¨</span>
      <span class="text-sm">Tin nh·∫Øn</span>
    </a>
    <a href="friends.html" class="flex flex-col items-center text-gray-600 hover:text-blue-500">
      <span class="text-xl">‚úåüèª</span>
      <span class="text-sm">B·∫°n b√®</span>
    </a>
    <a href="account.html" class="flex flex-col items-center text-gray-600 hover:text-blue-500">
      <span class="text-xl">üë§</span>
      <span class="text-sm">T√†i kho·∫£n</span>
    </a>
  </nav>

  <script type="module">
  function timeAgo(date) {
  const seconds = Math.floor((new Date() - date) / 1000);
  const intervals = [
    { label: 'nƒÉm', seconds: 31536000 },
    { label: 'th√°ng', seconds: 2592000 },
    { label: 'ng√†y', seconds: 86400 },
    { label: 'gi·ªù', seconds: 3600 },
    { label: 'ph√∫t', seconds: 60 },
    { label: 'gi√¢y', seconds: 1 }
  ];
  for (const interval of intervals) {
    const count = Math.floor(seconds / interval.seconds);
    if (count >= 1) return `${count} ${interval.label} tr∆∞·ªõc`;
  }
  return 'v·ª´a xong';
}

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import {
    getFirestore, collection, getDocs, doc, getDoc,
    query, orderBy, onSnapshot, serverTimestamp, setDoc, deleteDoc, addDoc

  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAJxH_3ZkN7wQnXVelRzm0mezBCBcxKoJM",
    authDomain: "loktik-1d9af.firebaseapp.com",
    projectId: "loktik-1d9af",
    storageBucket: "loktik-1d9af.appspot.com",
    messagingSenderId: "801363229819",
    appId: "1:801363229819:web:49f086bc180d9ed9c0b6de"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const postList = document.getElementById("postList");

  onAuthStateChanged(auth, user => {
    if (!user) return (window.location.href = "login.html");
    loadPosts(user);
  });

  async function loadPosts(currentUser) {
    const postsQuery = query(collection(db, "posts"), orderBy("createdAt", "desc"));

    onSnapshot(postsQuery, async (snapshot) => {
      postList.innerHTML = "";
      if (snapshot.empty) {
        postList.innerHTML = "<p class='text-center text-gray-500'>Ch∆∞a c√≥ b√†i vi·∫øt n√†o.</p>";
        return;
      }

      for (const docSnap of snapshot.docs) {
        const data = docSnap.data();
        const postId = docSnap.id;

        const username = data.displayName || data.email || "·∫®n danh";
        const time = data.createdAt?.toDate?.() ? data.createdAt.toDate().toLocaleString("vi-VN") : "V·ª´a xong";
        const caption = data.text || data.caption || "";
        const imageUrls = data.imageUrls || [];
        const avatar = data.avatarUrl || "https://www.gravatar.com/avatar?d=mp";

        const likeRef = doc(db, "posts", postId, "likes", currentUser.uid);
        const likeSnap = await getDoc(likeRef);
        const liked = likeSnap.exists();

        const likesSnap = await getDocs(collection(db, "posts", postId, "likes"));
        let likeCount = likesSnap.size;

        const postEl = document.createElement("div");
        postEl.className = "bg-white p-4 rounded shadow space-y-2";

        postEl.innerHTML = `
          <div class="flex items-center gap-2 mb-2">
            <img src="${avatar}" class="w-8 h-8 rounded-full object-cover" />
            <p class="text-sm text-gray-500">${username} ‚Ä¢ ${time}</p>
          </div>
          ${imageUrls.map(url => `
            <img src="${url}" class="rounded mb-2 max-h-96 w-full object-cover transition-opacity duration-300 opacity-0"
              loading="lazy" onload="this.style.opacity='1'" />
          `).join("")}
          <p class="text-gray-800">${caption}</p>
          <button class="like-btn text-red-500">${liked ? "‚ù§Ô∏è" : "ü§ç"} ${likeCount}</button>

          <div class="mt-3">
            <form class="comment-form flex gap-2">
              <input type="text" placeholder="B√¨nh lu·∫≠n..." class="flex-1 p-2 border rounded" />
              <button type="submit" class="bg-blue-500 text-white px-3 rounded">G·ª≠i</button>
            </form>
            <p class="comment-count text-sm text-gray-600 mt-2">‚è≥ ƒêang t·∫£i b√¨nh lu·∫≠n...</p>
            <div class="comment-list mt-2 text-sm text-gray-700 space-y-1 max-h-28 overflow-y-auto"></div>
          </div>
        `;

        postList.appendChild(postEl);

        // Like
        const likeBtn = postEl.querySelector(".like-btn");
        likeBtn.addEventListener("click", async () => {
          const likeDocRef = doc(db, "posts", postId, "likes", currentUser.uid);
          const likeDocSnap = await getDoc(likeDocRef);
          if (!likeDocSnap.exists()) {
            await setDoc(likeDocRef, { likedAt: serverTimestamp() });
            likeCount++;
            likeBtn.innerHTML = `‚ù§Ô∏è ${likeCount}`;
          } else {
            await deleteDoc(likeDocRef);
            likeCount--;
            likeBtn.innerHTML = `ü§ç ${likeCount}`;
          }
        });

        // Comments
        const commentForm = postEl.querySelector(".comment-form");
        const commentInput = commentForm.querySelector("input");
        const commentList = postEl.querySelector(".comment-list");
        const commentCountEl = postEl.querySelector(".comment-count");

        const commentCol = collection(db, "posts", postId, "comments");
        onSnapshot(query(commentCol, orderBy("createdAt", "asc")), commentSnap => {
          commentList.innerHTML = "";
          commentCountEl.textContent = `${commentSnap.size} b√¨nh lu·∫≠n`;

          if (commentSnap.empty) {
            commentList.innerHTML = `<p class="text-gray-400 italic">Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o.</p>`;
          } else {
            let count = 0;
commentSnap.forEach(cmtDoc => {
  if (count >= 3) return; // ch·ªâ hi·ªÉn th·ªã 3 b√¨nh lu·∫≠n
  const cmt = cmtDoc.data();

  const createdAt = cmt.createdAt?.toDate?.();
  const ago = createdAt ? timeAgo(createdAt) : "v·ª´a xong";

  const cmtEl = document.createElement("div");
  cmtEl.className = "bg-gray-100 rounded px-2 py-1";
  cmtEl.innerHTML = `
    <div class="flex justify-between items-center text-sm text-gray-700 font-semibold">
      <span>${cmt.email || "·∫®n danh"}</span>
      <span class="text-xs text-gray-500">${ago}</span>
    </div>
    <div class="text-gray-800 text-sm">${cmt.text}</div>
  `;
  commentList.appendChild(cmtEl);
  count++;
});

          }
        });

        commentForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const text = commentInput.value.trim();
          if (!text || text.length > 200) return alert("B√¨nh lu·∫≠n kh√¥ng h·ª£p l·ªá!");

          await addDoc(commentCol, {
            text,
            email: currentUser.email,
            createdAt: serverTimestamp()
          });

          commentInput.value = "";
        });
      }
    });
  }
</script>
</body>
</html>
